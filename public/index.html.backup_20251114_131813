<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Retail Management System</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    /* prevent page-level horizontal scroll while allowing table-level scroll */
    html, body { overflow-x: hidden; }
  </style>
</head>
<body class="bg-gray-50">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;
    const API_URL = 'http://localhost:3001/api';
    const AuthContext = React.createContext();

    function AuthProvider({ children }) {
      const [token, setToken] = useState(localStorage.getItem('token'));
      const [user, setUser] = useState(() => {
        try { const u = localStorage.getItem('user'); return u ? JSON.parse(u) : null; } catch { return null; }
      });

      const login = (t, u) => { localStorage.setItem('token', t); localStorage.setItem('user', JSON.stringify(u)); setToken(t); setUser(u); };
      const logout = () => { localStorage.removeItem('token'); localStorage.removeItem('user'); setToken(null); setUser(null); };

      return <AuthContext.Provider value={{ token, user, login, logout, isAuthenticated: !!token }}>{children}</AuthContext.Provider>;
    }

    async function apiCall(endpoint, options = {}) {
      const token = localStorage.getItem('token');
      const headers = { 'Content-Type': 'application/json', ...(token && { 'Authorization': `Bearer ${token}` }), ...options.headers };
      const res = await fetch(`${API_URL}${endpoint}`, { ...options, headers });
      if (!res.ok) {
        let err;
        try { err = await res.json(); } catch { err = { error: 'Request failed' }; }
        throw new Error(err.error || 'Request failed');
      }
      return res.json();
    }

    function Login() {
      const { login } = React.useContext(AuthContext);
      const [username, setUsername] = useState('admin');
      const [password, setPassword] = useState('admin123');
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setError(''); setLoading(true);
        try {
          const data = await apiCall('/auth/login', { method: 'POST', body: JSON.stringify({ username, password }) });
          login(data.token, data.user);
        } catch (err) { setError(err.message); } finally { setLoading(false); }
      };

      return (
        <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-500 to-purple-600">
          <div className="bg-white p-8 rounded-2xl shadow-2xl w-96">
            <div className="text-center mb-6">
              <h1 className="text-3xl font-bold text-gray-800">Retail Manager</h1>
              <p className="text-gray-600">Welcome back</p>
            </div>
            <form onSubmit={handleSubmit}>
              <label className="block text-sm font-medium text-gray-700">Username</label>
              <input value={username} onChange={e => setUsername(e.target.value)} className="w-full px-3 py-2 border rounded mb-3" required />
              <label className="block text-sm font-medium text-gray-700">Password</label>
              <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full px-3 py-2 border rounded mb-4" required />
              {error && <div className="text-red-600 mb-3">{error}</div>}
              <button type="submit" disabled={loading} className="w-full bg-blue-600 text-white py-2 rounded">{loading ? 'Logging in...' : 'Login'}</button>
            </form>
            <div className="mt-4 text-sm text-gray-600">Default: admin / admin123</div>
          </div>
        </div>
      );
    }

    function Modal({ children, onClose, wide=false }) {
      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 p-4">
          <div className={`bg-white rounded-lg shadow-2xl ${wide ? 'max-w-5xl w-full' : 'max-w-2xl w-full'} max-h-[90vh] overflow-y-auto relative`}>
            <button onClick={onClose} className="absolute top-3 right-3 text-gray-600 hover:text-gray-900 text-2xl">Ã—</button>
            <div className="p-6">{children}</div>
          </div>
        </div>
      );
    }

    function StatCard({ title, value, icon, color }) {
      return (
        <div className="bg-white p-6 rounded shadow hover:shadow-lg transition">
          <div className="flex items-center justify-between mb-3">
            <div className="text-2xl">{icon}</div>
            <div className={`${color} w-10 h-10 rounded-full flex items-center justify-center text-white`}>{icon}</div>
          </div>
          <div className="text-sm text-gray-600">{title}</div>
          <div className="text-2xl font-bold mt-2">{value}</div>
        </div>
      );
    }

    // ------------------ Customers component (with requested changes) ------------------
    function Customers() {
      const [customers, setCustomers] = useState([]);
      const [search, setSearch] = useState('');
      const [showForm, setShowForm] = useState(false);
      const [editing, setEditing] = useState(null);
      const [showView, setShowView] = useState(false);
      const [viewCustomer, setViewCustomer] = useState(null);

      const initialForm = {
        name: '',
        email: '',
        phone: '',
        address: '',
        vehicle_number: '',
        vehicle_type: '',
        last_service_date: '',
        next_service_date: ''
      };

      const [form, setForm] = useState(initialForm);

      useEffect(() => { loadCustomers(); }, [search]);

      const loadCustomers = async () => {
        try {
          const data = await apiCall(`/customers?search=${encodeURIComponent(search)}`);
          setCustomers(data);
        } catch (err) { console.error(err); }
      };

      // helper to normalize vehicle number: uppercase + non-alphanumeric removed
      const normalizeVehicleNumber = (value) => {
        if (!value) return '';
        return value.toUpperCase().replace(/[^A-Z0-9]/g, '');
      };

      const onVehicleNumberChange = (value) => {
        setForm(prev => ({ ...prev, vehicle_number: normalizeVehicleNumber(value) }));
      };

      const validateForm = () => {
        if (!form.name.trim()) { alert('Name is required'); return false; }
        if (!form.vehicle_type.trim()) { alert('Vehicle type is required'); return false; }
        if (!form.vehicle_number.trim()) { alert('Vehicle number is required'); return false; }
        // vehicle_number must be alphanumeric uppercase (after normalization)
        const vn = form.vehicle_number;
        if (!/^[A-Z0-9]+$/.test(vn)) { alert('Vehicle number must be alphanumeric (A-Z,0-9)'); return false; }
        if (!form.phone.trim()) { alert('Phone number is required'); return false; }
        // optional: basic phone format check
        if (!/^[0-9+\- ]{6,20}$/.test(form.phone)) { if(!confirm('Phone looks unusual. Continue?')) return false; }
        return true;
      };

      const openCreate = () => { setEditing(null); setForm(initialForm); setShowForm(true); };
      const openEdit = (c) => {
        setEditing(c);
        setForm({
          name: c.name ?? '',
          email: c.email ?? '',
          phone: c.phone ?? '',
          address: c.address ?? '',
          vehicle_number: c.vehicle_number ?? '',
          vehicle_type: c.vehicle_type ?? '',
          last_service_date: c.last_service_date ?? '',
          next_service_date: c.next_service_date ?? ''
        });
        setShowForm(true);
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!validateForm()) return;
        try {
          if (editing) {
            await apiCall(`/customers/${editing.id}`, { method: 'PUT', body: JSON.stringify(form) });
          } else {
            await apiCall('/customers', { method: 'POST', body: JSON.stringify(form) });
          }
          setShowForm(false); setEditing(null); setForm(initialForm); loadCustomers();
        } catch (err) { alert(err.message); }
      };

      const handleDelete = async (id) => {
        if (!confirm('Delete this customer?')) return;
        try { await apiCall(`/customers/${id}`, { method: 'DELETE' }); loadCustomers(); } catch (err) { alert(err.message); }
      };

      const handleView = (customer) => { setViewCustomer(customer); setShowView(true); };

      return (
        <div>
          <div className="flex justify-between items-center mb-6">
            <h1 className="text-3xl font-bold text-gray-800">Customers</h1>
            <div className="flex items-center gap-3">
              <input
                value={search}
                onChange={e => setSearch(e.target.value)}
                placeholder="Search by name, phone, email, vehicle..."
                className="px-3 py-2 border rounded-lg w-72"
              />
              <button onClick={openCreate} className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">+ Add Customer</button>
            </div>
          </div>

          <div className="bg-white rounded-lg shadow overflow-hidden">
            {/* table-level horizontal scroll only */}
            <div className="w-full overflow-x-auto">
              <table className="min-w-[900px] w-full table-auto">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Phone</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Vehicle Type</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Vehicle No.</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Last Service</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Next Service</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-gray-200">
                  {customers.map(c => (
                    <tr key={c.id} className="hover:bg-gray-50">
                      <td className="px-6 py-4 whitespace-nowrap">
                        <div className="flex items-center gap-3">
                          {/* view icon */}
                          <button title="View" onClick={() => handleView(c)} className="text-gray-600 hover:text-gray-900">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M2.458 12C3.732 7.943 7.523 5 12 5s8.268 2.943 9.542 7c-1.274 4.057-5.065 7-9.542 7S3.732 16.057 2.458 12z" />
                            </svg>
                          </button>

                          {/* edit icon */}
                          <button title="Edit" onClick={() => openEdit(c)} className="text-blue-600 hover:text-blue-800">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                              <path d="M17.414 2.586a2 2 0 010 2.828L8.414 14.414a1 1 0 01-.464.263l-4 1a1 1 0 01-1.213-1.213l1-4a1 1 0 01.263-.464L14.586 2.586a2 2 0 012.828 0z" />
                            </svg>
                          </button>

                          {/* delete icon */}
                          <button title="Delete" onClick={() => handleDelete(c.id)} className="text-red-600 hover:text-red-800">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                              <path fillRule="evenodd" d="M6 2a1 1 0 00-1 1v1H3a1 1 0 100 2h14a1 1 0 100-2h-2V3a1 1 0 00-1-1H6zm2 6a1 1 0 10-2 0v7a1 1 0 102 0V8zm6 0a1 1 0 10-2 0v7a1 1 0 102 0V8z" clipRule="evenodd" />
                            </svg>
                          </button>
                        </div>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap max-w-xs overflow-hidden text-ellipsis font-medium">{c.name}</td>
                      <td className="px-6 py-4 whitespace-nowrap">{c.phone}</td>
                      <td className="px-6 py-4 whitespace-nowrap">{c.vehicle_type || '-'}</td>
                      <td className="px-6 py-4 whitespace-nowrap font-mono">{c.vehicle_number || '-'}</td>
                      <td className="px-6 py-4 whitespace-nowrap">{c.last_service_date || '-'}</td>
                      <td className="px-6 py-4 whitespace-nowrap">{c.next_service_date || '-'}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>

          {/* Create / Edit Modal */}
          {showForm && (
            <Modal onClose={() => { setShowForm(false); setEditing(null); }} wide={false}>
              <h2 className="text-2xl font-bold mb-4">{editing ? 'Edit Customer' : 'Add Customer'}</h2>
              <form onSubmit={handleSubmit}>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium mb-1">Name *</label>
                    <input type="text" value={form.name} onChange={e => setForm(prev => ({ ...prev, name: e.target.value }))} className="w-full px-3 py-2 border rounded" required />
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-1">Vehicle Type *</label>
                    <input type="text" value={form.vehicle_type} onChange={e => setForm(prev => ({ ...prev, vehicle_type: e.target.value }))} className="w-full px-3 py-2 border rounded" required />
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-1">Vehicle Number *</label>
                    <input
                      type="text"
                      value={form.vehicle_number}
                      onChange={e => onVehicleNumberChange(e.target.value)}
                      className="w-full px-3 py-2 border rounded"
                      placeholder="Alphanumeric - will be uppercased"
                      required
                    />
                    <p className="text-xs text-gray-500 mt-1">Only A-Z and 0-9 are allowed. Will be stored in uppercase.</p>
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-1">Phone *</label>
                    <input type="text" value={form.phone} onChange={e => setForm(prev => ({ ...prev, phone: e.target.value }))} className="w-full px-3 py-2 border rounded" required />
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-1">Email</label>
                    <input type="email" value={form.email} onChange={e => setForm(prev => ({ ...prev, email: e.target.value }))} className="w-full px-3 py-2 border rounded" />
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-1">Last Service Date</label>
                    <input type="date" value={form.last_service_date} onChange={e => setForm(prev => ({ ...prev, last_service_date: e.target.value }))} className="w-full px-3 py-2 border rounded" />
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-1">Next Service Date</label>
                    <input type="date" value={form.next_service_date} onChange={e => setForm(prev => ({ ...prev, next_service_date: e.target.value }))} className="w-full px-3 py-2 border rounded" />
                  </div>

                  <div className="col-span-2">
                    <label className="block text-sm font-medium mb-1">Address</label>
                    <textarea value={form.address} onChange={e => setForm(prev => ({ ...prev, address: e.target.value }))} rows="3" className="w-full px-3 py-2 border rounded"></textarea>
                  </div>
                </div>

                <div className="flex justify-end gap-3 mt-4">
                  <button type="button" onClick={() => { setShowForm(false); setEditing(null); }} className="px-4 py-2 border rounded hover:bg-gray-50">Cancel</button>
                  <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">{editing ? 'Update' : 'Create'}</button>
                </div>
              </form>
            </Modal>
          )}

          {/* View modal */}
          {showView && viewCustomer && (
            <Modal onClose={() => { setShowView(false); setViewCustomer(null); }} wide={false}>
              <h2 className="text-2xl font-bold mb-4">Customer Details</h2>
              <div className="grid grid-cols-2 gap-4">
                <div><div className="text-sm text-gray-500">Name</div><div className="font-medium">{viewCustomer.name}</div></div>
                <div><div className="text-sm text-gray-500">Vehicle Type</div><div className="font-medium">{viewCustomer.vehicle_type || '-'}</div></div>
                <div><div className="text-sm text-gray-500">Vehicle Number</div><div className="font-medium">{viewCustomer.vehicle_number || '-'}</div></div>
                <div><div className="text-sm text-gray-500">Phone</div><div className="font-medium">{viewCustomer.phone}</div></div>
                <div><div className="text-sm text-gray-500">Email</div><div className="font-medium">{viewCustomer.email || '-'}</div></div>
                <div><div className="text-sm text-gray-500">Last Service</div><div className="font-medium">{viewCustomer.last_service_date || '-'}</div></div>
                <div><div className="text-sm text-gray-500">Next Service</div><div className="font-medium">{viewCustomer.next_service_date || '-'}</div></div>
                <div className="col-span-2"><div className="text-sm text-gray-500">Address</div><div className="font-medium">{viewCustomer.address || '-'}</div></div>
              </div>
            </Modal>
          )}
        </div>
      );
    }
    // ------------------ end Customers ------------------

    function Dashboard() {
      const [stats, setStats] = useState(null);
      useEffect(() => { (async () => { try { const d = await apiCall('/dashboard/stats'); setStats(d); } catch (e) { console.error(e); } })(); }, []);
      return (
        <div>
          <h1 className="text-3xl font-bold mb-6">Dashboard</h1>
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <StatCard title="Today's Sales" value={`â‚¹${(stats?.today_sales ?? 0).toFixed(2)}`} icon="ðŸ’°" color="bg-green-500" />
            <StatCard title="Transactions" value={stats?.today_transactions ?? 0} icon="ðŸ›’" color="bg-blue-500" />
            <StatCard title="Total Customers" value={stats?.total_customers ?? 0} icon="ðŸ‘¥" color="bg-purple-500" />
            <StatCard title="Low Stock Items" value={stats?.low_stock_items ?? 0} icon="âš ï¸" color="bg-red-500" />
          </div>
        </div>
      );
    }

    // Products, Services, Sales - simplified but intact structure (unchanged behavior)
    function Products() {
      const [products, setProducts] = useState([]);
      const [filteredProducts, setFilteredProducts] = useState([]);
      const [showForm, setShowForm] = useState(false);
      const [editing, setEditing] = useState(null);
      const [showView, setShowView] = useState(false);
      const [viewProduct, setViewProduct] = useState(null);
      const [searchTerm, setSearchTerm] = useState('');
      const [rackFilter, setRackFilter] = useState('');
      const [allRacks, setAllRacks] = useState([]);

      const initialForm = {
        name: '',
        sell_price: '',
        quantity: '',
        purchase_price: '',
        vendor: '',
        rack_id: '',
        additional_info: ''
      };

      const [form, setForm] = useState(initialForm);

      useEffect(() => { loadProducts(); }, []);

      useEffect(() => {
        filterProducts();
      }, [products, searchTerm, rackFilter]);

      const loadProducts = async () => {
        try {
          const data = await apiCall('/products');
          setProducts(data);
          
          // Extract unique rack IDs
          const racks = [...new Set(data.map(p => p.rack_id).filter(r => r))].sort();
          setAllRacks(racks);
        } catch (err) { console.error(err); }
      };

      const filterProducts = () => {
        let filtered = products;

        // Filter by search term (name, vendor)
        if (searchTerm.trim()) {
          const term = searchTerm.toLowerCase();
          filtered = filtered.filter(p => 
            p.name.toLowerCase().includes(term) || 
            (p.vendor && p.vendor.toLowerCase().includes(term))
          );
        }

        // Filter by rack
        if (rackFilter) {
          filtered = filtered.filter(p => p.rack_id === rackFilter);
        }

        setFilteredProducts(filtered);
      };

      const validateForm = () => {
        if (!form.name.trim()) { alert('Product name is required'); return false; }
        if (!form.sell_price || isNaN(form.sell_price) || parseFloat(form.sell_price) <= 0) {
          alert('Sell price is required and must be a positive number'); return false;
        }
        if (!form.quantity || isNaN(form.quantity) || parseInt(form.quantity) < 0) {
          alert('Quantity is required and must be a non-negative number'); return false;
        }
        if (!form.purchase_price || isNaN(form.purchase_price) || parseFloat(form.purchase_price) <= 0) {
          alert('Purchase price is required and must be a positive number'); return false;
        }
        return true;
      };

      const openCreate = () => { setEditing(null); setForm(initialForm); setShowForm(true); };
      const openEdit = (p) => {
        setEditing(p);
        setForm({
          name: p.name ?? '',
          sell_price: p.sell_price ?? '',
          quantity: p.quantity ?? '',
          purchase_price: p.purchase_price ?? '',
          vendor: p.vendor ?? '',
          rack_id: p.rack_id ?? '',
          additional_info: p.additional_info ?? ''
        });
        setShowForm(true);
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!validateForm()) return;
        try {
          const payload = {
            name: form.name,
            sell_price: parseFloat(form.sell_price),
            quantity: parseInt(form.quantity),
            purchase_price: parseFloat(form.purchase_price),
            vendor: form.vendor || null,
            rack_id: form.rack_id || null,
            additional_info: form.additional_info || null
          };
          if (editing) {
            await apiCall(`/products/${editing.id}`, { method: 'PUT', body: JSON.stringify(payload) });
          } else {
            await apiCall('/products', { method: 'POST', body: JSON.stringify(payload) });
          }
          setShowForm(false); setEditing(null); setForm(initialForm); loadProducts();
        } catch (err) { alert(err.message); }
      };

      const handleDelete = async (id) => {
        if (!confirm('Delete this product?')) return;
        try { await apiCall(`/products/${id}`, { method: 'DELETE' }); loadProducts(); } catch (err) { alert(err.message); }
      };

      const handleView = (product) => { setViewProduct(product); setShowView(true); };

      const calculateTotals = (product) => {
        const totalPurchasePrice = parseFloat(product.purchase_price) * parseInt(product.quantity);
        const expectedTotalSellPrice = parseFloat(product.sell_price) * parseInt(product.quantity);
        const potentialProfit = expectedTotalSellPrice - totalPurchasePrice;
        return { totalPurchasePrice, expectedTotalSellPrice, potentialProfit };
      };

      const clearFilters = () => {
        setSearchTerm('');
        setRackFilter('');
      };

      return (
        <div>
          <div className="flex justify-between items-center mb-6">
            <h1 className="text-3xl font-bold text-gray-800">Products & Inventory</h1>
            <button onClick={openCreate} className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">+ Add Product</button>
          </div>

          {/* Search and Filter Bar */}
          <div className="bg-white rounded-lg shadow p-4 mb-6">
            <div className="flex flex-wrap gap-4 items-end">
              <div className="flex-1 min-w-[250px]">
                <label className="block text-sm font-medium text-gray-700 mb-1">Search Products</label>
                <input
                  type="text"
                  value={searchTerm}
                  onChange={e => setSearchTerm(e.target.value)}
                  placeholder="Search by product name or vendor..."
                  className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                />
              </div>
              
              <div className="min-w-[200px]">
                <label className="block text-sm font-medium text-gray-700 mb-1">Filter by Rack</label>
                <select
                  value={rackFilter}
                  onChange={e => setRackFilter(e.target.value)}
                  className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                >
                  <option value="">All Racks</option>
                  {allRacks.map(rack => (
                    <option key={rack} value={rack}>{rack}</option>
                  ))}
                </select>
              </div>

              {(searchTerm || rackFilter) && (
                <button
                  onClick={clearFilters}
                  className="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600"
                >
                  Clear Filters
                </button>
              )}

              <div className="text-sm text-gray-600 py-2">
                Showing {filteredProducts.length} of {products.length} products
              </div>
            </div>
          </div>

          <div className="bg-white rounded-lg shadow overflow-hidden">
            <div className="w-full overflow-x-auto">
              <table className="min-w-[1100px] w-full table-auto">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Product Name</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Unit Sell Price (â‚¹)</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Quantity</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Unit Purchase Price (â‚¹)</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total Purchase (â‚¹)</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Expected Total Sell (â‚¹)</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Vendor</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Rack ID</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-gray-200">
                  {filteredProducts.map(p => {
                    const { totalPurchasePrice, expectedTotalSellPrice } = calculateTotals(p);
                    return (
                      <tr key={p.id} className="hover:bg-gray-50">
                        <td className="px-6 py-4 whitespace-nowrap">
                          <div className="flex items-center gap-3">
                            <button title="View" onClick={() => handleView(p)} className="text-gray-600 hover:text-gray-900">
                              <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M2.458 12C3.732 7.943 7.523 5 12 5s8.268 2.943 9.542 7c-1.274 4.057-5.065 7-9.542 7S3.732 16.057 2.458 12z" />
                              </svg>
                            </button>
                            <button title="Edit" onClick={() => openEdit(p)} className="text-blue-600 hover:text-blue-800">
                              <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M17.414 2.586a2 2 0 010 2.828L8.414 14.414a1 1 0 01-.464.263l-4 1a1 1 0 01-1.213-1.213l1-4a1 1 0 01.263-.464L14.586 2.586a2 2 0 012.828 0z" />
                              </svg>
                            </button>
                            <button title="Delete" onClick={() => handleDelete(p.id)} className="text-red-600 hover:text-red-800">
                              <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fillRule="evenodd" d="M6 2a1 1 0 00-1 1v1H3a1 1 0 100 2h14a1 1 0 100-2h-2V3a1 1 0 00-1-1H6zm2 6a1 1 0 10-2 0v7a1 1 0 102 0V8zm6 0a1 1 0 10-2 0v7a1 1 0 102 0V8z" clipRule="evenodd" />
                              </svg>
                            </button>
                          </div>
                        </td>
                        <td className="px-6 py-4 whitespace-nowrap max-w-xs overflow-hidden text-ellipsis font-medium">{p.name}</td>
                        <td className="px-6 py-4 whitespace-nowrap">â‚¹{parseFloat(p.sell_price).toFixed(2)}</td>
                        <td className="px-6 py-4 whitespace-nowrap">{p.quantity}</td>
                        <td className="px-6 py-4 whitespace-nowrap">â‚¹{parseFloat(p.purchase_price).toFixed(2)}</td>
                        <td className="px-6 py-4 whitespace-nowrap font-medium text-orange-600">â‚¹{totalPurchasePrice.toFixed(2)}</td>
                        <td className="px-6 py-4 whitespace-nowrap font-medium text-green-600">â‚¹{expectedTotalSellPrice.toFixed(2)}</td>
                        <td className="px-6 py-4 whitespace-nowrap">{p.vendor || '-'}</td>
                        <td className="px-6 py-4 whitespace-nowrap">{p.rack_id || '-'}</td>
                      </tr>
                    );
                  })}
                  {filteredProducts.length === 0 && (
                    <tr>
                      <td colSpan="9" className="px-6 py-8 text-center text-gray-500">
                        No products found. {searchTerm || rackFilter ? 'Try adjusting your filters.' : 'Add your first product to get started.'}
                      </td>
                    </tr>
                  )}
                </tbody>
              </table>
            </div>
          </div>

          {/* Create / Edit Modal */}
          {showForm && (
            <Modal onClose={() => { setShowForm(false); setEditing(null); }} wide={false}>
              <h2 className="text-2xl font-bold mb-4">{editing ? 'Edit Product' : 'Add Product'}</h2>
              <form onSubmit={handleSubmit}>
                <div className="grid grid-cols-2 gap-4">
                  <div className="col-span-2">
                    <label className="block text-sm font-medium mb-1">Product Name *</label>
                    <input type="text" value={form.name} onChange={e => setForm(prev => ({ ...prev, name: e.target.value }))} className="w-full px-3 py-2 border rounded" required />
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-1">Unit Sell Price (â‚¹) *</label>
                    <input type="number" step="0.01" min="0" value={form.sell_price} onChange={e => setForm(prev => ({ ...prev, sell_price: e.target.value }))} className="w-full px-3 py-2 border rounded" required />
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-1">Quantity *</label>
                    <input type="number" min="0" value={form.quantity} onChange={e => setForm(prev => ({ ...prev, quantity: e.target.value }))} className="w-full px-3 py-2 border rounded" required />
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-1">Unit Purchase Price (â‚¹) *</label>
                    <input type="number" step="0.01" min="0" value={form.purchase_price} onChange={e => setForm(prev => ({ ...prev, purchase_price: e.target.value }))} className="w-full px-3 py-2 border rounded" required />
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-1">Vendor</label>
                    <input type="text" value={form.vendor} onChange={e => setForm(prev => ({ ...prev, vendor: e.target.value }))} className="w-full px-3 py-2 border rounded" />
                  </div>

                  <div className="col-span-2">
                    <label className="block text-sm font-medium mb-1">Rack ID</label>
                    <input type="text" value={form.rack_id} onChange={e => setForm(prev => ({ ...prev, rack_id: e.target.value }))} className="w-full px-3 py-2 border rounded" placeholder="e.g., A-1, B-2" />
                  </div>

                  {/* Show calculated totals if editing or if values entered */}
                  {(form.sell_price && form.quantity && form.purchase_price) && (
                    <div className="col-span-2 bg-gray-50 p-4 rounded-lg">
                      <div className="text-sm font-medium text-gray-700 mb-2">Calculated Values:</div>
                      <div className="grid grid-cols-2 gap-3 text-sm">
                        <div>
                          <span className="text-gray-600">Total Purchase Price:</span>
                          <span className="ml-2 font-medium text-orange-600">â‚¹{(parseFloat(form.purchase_price || 0) * parseInt(form.quantity || 0)).toFixed(2)}</span>
                        </div>
                        <div>
                          <span className="text-gray-600">Expected Total Sell Price:</span>
                          <span className="ml-2 font-medium text-green-600">â‚¹{(parseFloat(form.sell_price || 0) * parseInt(form.quantity || 0)).toFixed(2)}</span>
                        </div>
                        <div className="col-span-2">
                          <span className="text-gray-600">Potential Profit:</span>
                          <span className="ml-2 font-medium text-blue-600">â‚¹{((parseFloat(form.sell_price || 0) * parseInt(form.quantity || 0)) - (parseFloat(form.purchase_price || 0) * parseInt(form.quantity || 0))).toFixed(2)}</span>
                        </div>
                      </div>
                    </div>
                  )}

                  <div className="col-span-2">
                    <label className="block text-sm font-medium mb-1">Additional Info</label>
                    <textarea value={form.additional_info} onChange={e => setForm(prev => ({ ...prev, additional_info: e.target.value }))} rows="3" className="w-full px-3 py-2 border rounded"></textarea>
                  </div>
                </div>

                <div className="flex justify-end gap-3 mt-4">
                  <button type="button" onClick={() => { setShowForm(false); setEditing(null); }} className="px-4 py-2 border rounded hover:bg-gray-50">Cancel</button>
                  <button type="submit" className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">{editing ? 'Update' : 'Create'}</button>
                </div>
              </form>
            </Modal>
          )}

          {/* View modal */}
          {showView && viewProduct && (
            <Modal onClose={() => { setShowView(false); setViewProduct(null); }} wide={false}>
              <h2 className="text-2xl font-bold mb-4">Product Details</h2>
              <div className="grid grid-cols-2 gap-4">
                <div className="col-span-2"><div className="text-sm text-gray-500">Product Name</div><div className="font-medium text-lg">{viewProduct.name}</div></div>
                
                <div className="col-span-2 bg-blue-50 p-3 rounded">
                  <div className="text-sm font-medium text-blue-800 mb-2">Pricing Information</div>
                  <div className="grid grid-cols-2 gap-3">
                    <div><div className="text-xs text-gray-600">Unit Sell Price</div><div className="font-medium">â‚¹{parseFloat(viewProduct.sell_price).toFixed(2)}</div></div>
                    <div><div className="text-xs text-gray-600">Quantity</div><div className="font-medium">{viewProduct.quantity}</div></div>
                    <div><div className="text-xs text-gray-600">Unit Purchase Price</div><div className="font-medium">â‚¹{parseFloat(viewProduct.purchase_price).toFixed(2)}</div></div>
                  </div>
                </div>

                <div className="col-span-2 bg-green-50 p-3 rounded">
                  <div className="text-sm font-medium text-green-800 mb-2">Total Values</div>
                  <div className="grid grid-cols-2 gap-3">
                    <div><div className="text-xs text-gray-600">Total Purchase Price</div><div className="font-medium text-orange-600">â‚¹{calculateTotals(viewProduct).totalPurchasePrice.toFixed(2)}</div></div>
                    <div><div className="text-xs text-gray-600">Expected Total Sell Price</div><div className="font-medium text-green-600">â‚¹{calculateTotals(viewProduct).expectedTotalSellPrice.toFixed(2)}</div></div>
                    <div className="col-span-2"><div className="text-xs text-gray-600">Potential Profit (Before Discount)</div><div className="font-medium text-blue-600">â‚¹{calculateTotals(viewProduct).potentialProfit.toFixed(2)}</div></div>
                  </div>
                </div>

                <div><div className="text-sm text-gray-500">Vendor</div><div className="font-medium">{viewProduct.vendor || '-'}</div></div>
                <div><div className="text-sm text-gray-500">Rack ID</div><div className="font-medium">{viewProduct.rack_id || '-'}</div></div>
                <div className="col-span-2"><div className="text-sm text-gray-500">Additional Info</div><div className="font-medium">{viewProduct.additional_info || '-'}</div></div>
                
                <div className="col-span-2 mt-2 p-3 bg-yellow-50 rounded">
                  <div className="text-xs text-yellow-800">
                    <strong>Note:</strong> Customer discounts can be applied during sales transactions. The expected total sell price shown is before any discounts.
                  </div>
                </div>
              </div>
            </Modal>
          )}
        </div>
      );
    }

    function Services() {
      return (
        <div>
          <h1 className="text-3xl font-bold mb-6">Recurring Services</h1>
          <div className="bg-white rounded-lg p-6 shadow">Services list placeholder</div>
        </div>
      );
    }

    function Sales() {
      return (
        <div>
          <h1 className="text-3xl font-bold mb-6">Sales & Billing</h1>
          <div className="bg-white rounded-lg p-6 shadow">Sales list placeholder</div>
        </div>
      );
    }

    function App() {
      const { isAuthenticated, logout, user } = React.useContext(AuthContext);
      const [current, setCurrent] = useState('dashboard');
      if (!isAuthenticated) return <Login />;

      const menu = [
        { id: 'dashboard', label: 'Dashboard', icon: 'ðŸ“Š' },
        { id: 'customers', label: 'Customers', icon: 'ðŸ‘¥' },
        { id: 'products', label: 'Products', icon: 'ðŸ“¦' },
        { id: 'services', label: 'Services', icon: 'ðŸ”„' },
        { id: 'sales', label: 'Sales', icon: 'ðŸ’°' },
      ];

      return (
        <div className="flex h-screen bg-gray-50 overflow-hidden">
          <aside className="w-64 bg-white shadow-lg relative">
            <div className="p-6 border-b">
              <h1 className="text-2xl font-bold text-blue-600">Retail Manager</h1>
              <p className="text-sm text-gray-600 mt-1">Welcome, {user?.username || 'User'}</p>
            </div>
            <nav className="p-4">
              {menu.map(m => (
                <button key={m.id} onClick={() => setCurrent(m.id)} className={`w-full text-left px-4 py-3 mb-2 rounded-lg flex items-center gap-3 ${current===m.id ? 'bg-blue-600 text-white' : 'hover:bg-gray-100'}`}>
                  <span className="text-xl">{m.icon}</span>
                  <span className="font-medium">{m.label}</span>
                </button>
              ))}
            </nav>
            <div className="absolute bottom-0 left-0 right-0 p-4 border-t">
              <button onClick={logout} className="w-full px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700">Logout</button>
            </div>
          </aside>

          <main className="flex-1 flex flex-col overflow-hidden">
            <header className="bg-white border-b p-4 flex justify-between items-center">
              <div className="text-lg font-semibold">{menu.find(i=>i.id===current)?.label}</div>
              <div className="text-sm text-gray-600">Jhansi | {new Date().toLocaleDateString()}</div>
            </header>

            <section className="flex-1 overflow-auto p-6">
              {current === 'dashboard' && <Dashboard />}
              {current === 'customers' && <Customers />}
              {current === 'products' && <Products />}
              {current === 'services' && <Services />}
              {current === 'sales' && <Sales />}
            </section>

            <footer className="bg-white border-t p-3 text-center text-sm text-gray-600">
              Â© {new Date().getFullYear()} Retail Manager
            </footer>
          </main>
        </div>
      );
    }

    ReactDOM.render(<AuthProvider><App /></AuthProvider>, document.getElementById('root'));
  </script>
</body>
</html>