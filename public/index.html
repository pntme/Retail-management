<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jyoti Auto Parts</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    /* prevent page-level horizontal scroll while allowing table-level scroll */
    html, body { overflow-x: hidden; }
  </style>
</head>
<body class="bg-gray-50">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;
    // Dynamic API URL - works for both local and production
const API_URL = window.location.hostname === 'localhost'
  ? 'http://localhost:3001/api'
  : `${window.location.origin}/api`;
    const AuthContext = React.createContext();

    function AuthProvider({ children }) {
      const [token, setToken] = useState(localStorage.getItem('token'));
      const [user, setUser] = useState(() => {
        try { const u = localStorage.getItem('user'); return u ? JSON.parse(u) : null; } catch { return null; }
      });

      const login = (t, u) => { localStorage.setItem('token', t); localStorage.setItem('user', JSON.stringify(u)); setToken(t); setUser(u); };
      const logout = () => { localStorage.removeItem('token'); localStorage.removeItem('user'); setToken(null); setUser(null); };

      return <AuthContext.Provider value={{ token, user, login, logout, isAuthenticated: !!token }}>{children}</AuthContext.Provider>;
    }

    const MessageContext = React.createContext();

    function MessageProvider({ children }) {
      const [message, setMessage] = useState(null);

      const showMessage = (msg, type = 'info', title = null) => {
        setMessage({ message: msg, type, title });
      };

      const showSuccess = (msg, title = 'Success') => showMessage(msg, 'success', title);
      const showError = (msg, title = 'Error') => showMessage(msg, 'error', title);
      const showWarning = (msg, title = 'Warning') => showMessage(msg, 'warning', title);
      const showInfo = (msg, title = 'Info') => showMessage(msg, 'info', title);

      const closeMessage = () => setMessage(null);

      return (
        <MessageContext.Provider value={{ showMessage, showSuccess, showError, showWarning, showInfo }}>
          {children}
          {message && (
            <MessageModal
              title={message.title}
              message={message.message}
              type={message.type}
              onClose={closeMessage}
            />
          )}
        </MessageContext.Provider>
      );
    }

    const NavigationContext = React.createContext();

    function NavigationProvider({ children }) {
      const [current, setCurrent] = useState('dashboard');

      const navigate = (page) => {
        setCurrent(page);
      };

      return (
        <NavigationContext.Provider value={{ current, navigate }}>
          {children}
        </NavigationContext.Provider>
      );
    }

    async function apiCall(endpoint, options = {}) {
      const token = localStorage.getItem('token');
      const headers = { 'Content-Type': 'application/json', ...(token && { 'Authorization': `Bearer ${token}` }), ...options.headers };
      const res = await fetch(`${API_URL}${endpoint}`, { ...options, headers });
      if (!res.ok) {
        let err;
        try { err = await res.json(); } catch { err = { error: 'Request failed' }; }
        throw new Error(err.error || 'Request failed');
      }
      return res.json();
    }

    function Login() {
      const { login } = React.useContext(AuthContext);
      const [username, setUsername] = useState('admin');
      const [password, setPassword] = useState('admin123');
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setError(''); setLoading(true);
        try {
          const data = await apiCall('/auth/login', { method: 'POST', body: JSON.stringify({ username, password }) });
          login(data.token, data.user);
        } catch (err) { setError(err.message); } finally { setLoading(false); }
      };

      return (
        <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-500 to-purple-600">
          <div className="bg-white p-8 rounded-2xl shadow-2xl w-96">
            <div className="text-center mb-6">
              <h1 className="text-3xl font-bold text-gray-800">Jyoti Auto Parts</h1>
              <p className="text-gray-600">Welcome back</p>
            </div>
            <form onSubmit={handleSubmit}>
              <label className="block text-sm font-medium text-gray-700">Username</label>
              <input value={username} onChange={e => setUsername(e.target.value)} className="w-full px-3 py-2 border rounded mb-3" required />
              <label className="block text-sm font-medium text-gray-700">Password</label>
              <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full px-3 py-2 border rounded mb-4" required />
              {error && <div className="text-red-600 mb-3">{error}</div>}
              <button type="submit" disabled={loading} className="w-full bg-blue-600 text-white py-2 rounded">{loading ? 'Logging in...' : 'Login'}</button>
            </form>
            <div className="mt-4 text-sm text-gray-600">Default: admin / admin123</div>
          </div>
        </div>
      );
    }

    function Modal({ children, onClose, wide=false }) {
      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 p-4">
          <div className={`bg-white rounded-lg shadow-2xl ${wide ? 'max-w-5xl w-full' : 'max-w-2xl w-full'} max-h-[90vh] overflow-y-auto relative`}>
            <button onClick={onClose} className="absolute top-3 right-3 text-gray-600 hover:text-gray-900 text-2xl">Ã—</button>
            <div className="p-6">{children}</div>
          </div>
        </div>
      );
    }

    function ConfirmModal({ title, message, onConfirm, onCancel, loading = false }) {
      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 p-4">
          <div className="bg-white rounded-lg shadow-2xl max-w-md w-full relative">
            <div className="p-6">
              <h2 className="text-2xl font-bold mb-4">{title}</h2>
              <p className="text-gray-700 mb-6">{message}</p>
              <div className="flex gap-3 justify-end">
                <button onClick={onCancel} className="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition" disabled={loading}>Cancel</button>
                <ButtonLoader loading={loading} onClick={onConfirm} className="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition">Delete</ButtonLoader>
              </div>
            </div>
          </div>
        </div>
      );
    }

    function MessageModal({ title, message, type = 'info', onClose }) {
      const iconMap = {
        success: { icon: 'âœ“', color: 'text-green-500', bg: 'bg-green-50', border: 'border-green-200' },
        error: { icon: 'âœ•', color: 'text-red-500', bg: 'bg-red-50', border: 'border-red-200' },
        warning: { icon: 'âš ', color: 'text-yellow-500', bg: 'bg-yellow-50', border: 'border-yellow-200' },
        info: { icon: 'â„¹', color: 'text-blue-500', bg: 'bg-blue-50', border: 'border-blue-200' }
      };
      const config = iconMap[type] || iconMap.info;

      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 p-4">
          <div className="bg-white rounded-lg shadow-2xl max-w-md w-full relative animate-fade-in">
            <div className="p-6">
              <div className="flex items-start gap-4">
                <div className={`flex-shrink-0 w-12 h-12 rounded-full ${config.bg} ${config.border} border-2 flex items-center justify-center`}>
                  <span className={`text-2xl font-bold ${config.color}`}>{config.icon}</span>
                </div>
                <div className="flex-1">
                  <h2 className="text-xl font-bold mb-2 text-gray-800">{title || (type.charAt(0).toUpperCase() + type.slice(1))}</h2>
                  <p className="text-gray-600">{message}</p>
                </div>
              </div>
              <div className="mt-6 flex justify-end">
                <button
                  onClick={onClose}
                  className="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition font-medium"
                >
                  OK
                </button>
              </div>
            </div>
          </div>
        </div>
      );
    }

    function StatCard({ title, value, icon, color }) {
      return (
        <div className="bg-white p-6 rounded shadow hover:shadow-lg transition">
          <div className="flex items-center justify-between mb-3">
            <div className="text-2xl">{icon}</div>
            <div className={`${color} w-10 h-10 rounded-full flex items-center justify-center text-white`}>{icon}</div>
          </div>
          <div className="text-sm text-gray-600">{title}</div>
          <div className="text-2xl font-bold mt-2">{value}</div>
        </div>
      );
    }

    // Spinner component for loading states
    function Spinner({ size = 'md', color = 'blue' }) {
      const sizeClasses = {
        sm: 'w-4 h-4 border-2',
        md: 'w-8 h-8 border-3',
        lg: 'w-12 h-12 border-4',
        xl: 'w-16 h-16 border-4'
      };
      const colorClasses = {
        blue: 'border-blue-600 border-t-transparent',
        white: 'border-white border-t-transparent',
        gray: 'border-gray-600 border-t-transparent',
        green: 'border-green-600 border-t-transparent',
        red: 'border-red-600 border-t-transparent'
      };
      return (
        <div className={`${sizeClasses[size]} ${colorClasses[color]} rounded-full animate-spin`}></div>
      );
    }

    // Full-page loading overlay
    function LoadingOverlay({ message = 'Loading...', show = true }) {
      if (!show) return null;
      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
          <div className="bg-white p-8 rounded-lg shadow-2xl flex flex-col items-center space-y-4">
            <Spinner size="xl" />
            <p className="text-gray-700 font-medium text-lg">{message}</p>
          </div>
        </div>
      );
    }

    // Inline loader for buttons
    function ButtonLoader({ loading, children, ...props }) {
      return (
        <button {...props} disabled={loading || props.disabled}>
          {loading ? (
            <div className="flex items-center justify-center gap-2">
              <Spinner size="sm" color="white" />
              <span>Loading...</span>
            </div>
          ) : children}
        </button>
      );
    }

    // Section loader for content areas
    function SectionLoader({ loading, children, message = 'Loading...' }) {
      if (loading) {
        return (
          <div className="flex flex-col items-center justify-center py-12 space-y-4">
            <Spinner size="lg" />
            <p className="text-gray-600">{message}</p>
          </div>
        );
      }
      return children;
    }

    // ------------------ Customers component (enhanced) ------------------
    function Customers() {
      const { showError, showWarning, showSuccess } = React.useContext(MessageContext);
      const [customers, setCustomers] = useState([]);
      const [search, setSearch] = useState('');
      const [showForm, setShowForm] = useState(false);
      const [editing, setEditing] = useState(null);
      const [showView, setShowView] = useState(false);
      const [viewCustomer, setViewCustomer] = useState(null);
      const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
      const [deleteId, setDeleteId] = useState(null);

      // Loading states
      const [loadingCustomers, setLoadingCustomers] = useState(false);
      const [submitting, setSubmitting] = useState(false);
      const [deleting, setDeleting] = useState(false);
      const [loadingServiceHistory, setLoadingServiceHistory] = useState(false);
      const [creatingJobCard, setCreatingJobCard] = useState(false);

      // pagination
      const [page, setPage] = useState(1);
      const pageSize = 12;

      // reminders / filters
      const [reminderStart, setReminderStart] = useState('');
      const [reminderEnd, setReminderEnd] = useState('');

      // service history modal
      const [showServiceHistory, setShowServiceHistory] = useState(false);
      const [serviceHistory, setServiceHistory] = useState([]);
      const [serviceHistoryCustomer, setServiceHistoryCustomer] = useState(null);

      const initialForm = {
        name: '',
        email: '',
        phone: '',
        address: '',
        vehicle_number: '',
        vehicle_type: ''
      };

      const [form, setForm] = useState(initialForm);

      useEffect(() => { loadCustomers(); }, [search]);

      const loadCustomers = async () => {
        setLoadingCustomers(true);
        try {
          const data = await apiCall(`/customers?search=${encodeURIComponent(search)}`);
          setCustomers(data || []);
          setPage(1);
        } catch (err) { console.error(err); }
        finally { setLoadingCustomers(false); }
      };

      const normalizeVehicleNumber = (value) => {
        if (!value) return '';
        return value.toUpperCase().replace(/[^A-Z0-9]/g, '');
      };

      const onVehicleNumberChange = (value) => setForm(prev => ({ ...prev, vehicle_number: normalizeVehicleNumber(value) }));

      const validateForm = () => {
        if (!form.name.trim()) { showError('Name is required', 'Validation Error'); return false; }
        if (!form.phone.trim()) { showError('Phone is required', 'Validation Error'); return false; }
        return true;
      };

      const openCreate = () => { setEditing(null); setForm(initialForm); setShowForm(true); };
      const openEdit = (c) => {
        setEditing(c);
        setForm({
          name: c.name ?? '',
          email: c.email ?? '',
          phone: c.phone ?? '',
          address: c.address ?? '',
          vehicle_number: c.vehicle_number ?? '',
          vehicle_type: c.vehicle_type ?? ''
        });
        setShowForm(true);
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!validateForm()) return;
        setSubmitting(true);
        try {
          if (editing) {
            await apiCall(`/customers/${editing.id}`, { method: 'PUT', body: JSON.stringify(form) });
          } else {
            await apiCall('/customers', { method: 'POST', body: JSON.stringify(form) });
          }
          setShowForm(false); setEditing(null); setForm(initialForm); loadCustomers();
          showSuccess(editing ? 'Customer updated successfully' : 'Customer created successfully');
        } catch (err) { showError(err.message); }
        finally { setSubmitting(false); }
      };

      const handleDelete = async (id) => { setDeleteId(id); setShowDeleteConfirm(true); };

      const confirmDelete = async () => {
        setDeleting(true);
        try {
          await apiCall(`/customers/${deleteId}`, { method: 'DELETE' });
          loadCustomers();
          showSuccess('Customer deleted successfully');
        } catch (err) { showError(err.message); }
        finally { setDeleting(false); setShowDeleteConfirm(false); setDeleteId(null); }
      };

      const cancelDelete = () => { setShowDeleteConfirm(false); setDeleteId(null); };

      const handleView = (customer) => { setViewCustomer(customer); setShowView(true); };

      // service history
      const openServiceHistory = async (customer) => {
        setLoadingServiceHistory(true);
        setServiceHistoryCustomer(customer);
        try {
          const data = await apiCall(`/customers/${customer.id}/service-history`);
          setServiceHistory(data || []);
        } catch (err) {
          console.warn('service history not available via API, using empty list', err);
          setServiceHistory([]);
        }
        finally { setLoadingServiceHistory(false); setShowServiceHistory(true); }
      };

      // Comprehensive job card modal for creating from customer
      const [showComprehensiveJobCard, setShowComprehensiveJobCard] = useState(false);
      const [jobCardPrefilledData, setJobCardPrefilledData] = useState({});

      // View job card modal from service history
      const [showViewJobCardModal, setShowViewJobCardModal] = useState(false);
      const [viewJobCardId, setViewJobCardId] = useState(null);

      const openCreateJobCardFor = (customer) => {
        // Prepare prefilled data from customer
        const prefilledData = {
          customer_id: customer.id,
          customer_name: customer.name || '',
          customer_phone: customer.phone || '',
          customer_email: customer.email || '',
          customer_address: customer.address || '',
          registration_no: customer.vehicle_number || '',
          vehicle_type: customer.vehicle_type || ''
        };
        setJobCardPrefilledData(prefilledData);
        setShowComprehensiveJobCard(true);
      };

      // call logs inside view modal (readonly - just display)
      const [callNotes, setCallNotes] = useState([]);

      useEffect(() => {
        if (viewCustomer) {
          // attempt to load call logs
          (async () => {
            try {
              const data = await apiCall(`/customers/${viewCustomer.id}/call-logs`);
              setCallNotes(data || []);
            } catch (e) {
              setCallNotes(viewCustomer.call_logs || []);
            }
          })();
        } else {
          setCallNotes([]);
        }
      }, [viewCustomer]);

      // reminders - moved to separate component
      const getReminders = () => {
        const list = (customers || []).map(c => ({ id: c.id, name: c.name, phone: c.phone, next_service_date: c.next_service_date })).filter(i => i.next_service_date);
        if (reminderStart && reminderEnd) {
          const s = new Date(reminderStart); s.setHours(0,0,0,0);
          const e = new Date(reminderEnd); e.setHours(23,59,59,999);
          return list.filter(i => { const d = new Date(i.next_service_date); return d >= s && d <= e; });
        }
        return list;
      };

      // pagination helpers
      const totalPages = Math.max(1, Math.ceil((customers || []).length / pageSize));
      const pagedCustomers = (customers || []).slice((page-1)*pageSize, page*pageSize);

      return (
        <div>
          <div className="flex justify-between items-center mb-6">
            <h1 className="text-3xl font-bold text-gray-800">Customers</h1>
            <div className="flex items-center gap-3">
              <input
                value={search}
                onChange={e => setSearch(e.target.value)}
                placeholder="Search by name, phone, email, vehicle..."
                className="px-3 py-2 border rounded-lg w-72"
              />
              <button onClick={openCreate} className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">+ Add Customer</button>
            </div>
          </div>

          <div className="bg-white rounded-lg shadow overflow-hidden">
            <SectionLoader loading={loadingCustomers} message="Loading customers...">
              <div className="w-full overflow-x-auto">
                <table className="min-w-[900px] w-full table-auto">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Phone</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Vehicle Type</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Vehicle No.</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Address</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-200">
                    {pagedCustomers.map(c => (
                    <tr key={c.id} className="hover:bg-gray-50">
                      <td className="px-6 py-4 whitespace-nowrap">
                        <div className="flex items-center gap-3">
                          {/* view details */}
                          <button title="View" onClick={() => handleView(c)} className="text-gray-600 hover:text-gray-900">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M2.458 12C3.732 7.943 7.523 5 12 5s8.268 2.943 9.542 7c-1.274 4.057-5.065 7-9.542 7S3.732 16.057 2.458 12z" />
                            </svg>
                          </button>

                          {/* service history icon */}
                          <button title="Service History" onClick={() => openServiceHistory(c)} className="text-indigo-600 hover:text-indigo-800">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                              <path d="M8 2a1 1 0 011 1v1h2V3a1 1 0 112 0v1h1a2 2 0 012 2v1H3V6a2 2 0 012-2h1V3a1 1 0 011-1z" />
                              <path d="M3 9h14v6a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                            </svg>
                          </button>

                          {/* open job card */}
                          <button title="Create Job Card" onClick={() => openCreateJobCardFor(c)} className="text-green-600 hover:text-green-800">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                              <path fillRule="evenodd" d="M11.42 15.17L16.95 9.64a1.414 1.414 0 000-2l-1.17-1.17a1.414 1.414 0 00-2 0l-5.53 5.53-2.29-2.29a1 1 0 00-1.41 1.41l3 3c.18.18.43.29.7.29.28 0 .52-.11.71-.29zM19 11h-6a1 1 0 00-1 1v6a1 1 0 001 1h6a1 1 0 001-1v-6a1 1 0 00-1-1z" clipRule="evenodd" />
                              <path d="M10 3.5a.5.5 0 01-.5-.5.5.5 0 01.5-.5h3a.5.5 0 01.5.5.5.5 0 01-.5.5h-3zm-2.5.5a1 1 0 00-1-1H3a1 1 0 00-1 1v13a1 1 0 001 1h4a1 1 0 001-1V4zm7.5 12a1 1 0 001 1h1a1 1 0 001-1V8.5a.5.5 0 00-.5-.5h-2a.5.5 0 00-.5.5V16z" />
                            </svg>
                          </button>

                          {/* edit */}
                          <button title="Edit" onClick={() => openEdit(c)} className="text-blue-600 hover:text-blue-800">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                              <path d="M17.414 2.586a2 2 0 010 2.828L8.414 14.414a1 1 0 01-.464.263l-4 1a1 1 0 01-1.213-1.213l1-4a1 1 0 01.263-.464L14.586 2.586a2 2 0 012.828 0z" />
                            </svg>
                          </button>

                          {/* delete */}
                          <button title="Delete" onClick={() => handleDelete(c.id)} className="text-red-600 hover:text-red-800">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                              <polyline points="3 6 5 6 21 6"></polyline>
                              <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                              <line x1="10" y1="11" x2="10" y2="17"></line>
                              <line x1="14" y1="11" x2="14" y2="17"></line>
                            </svg>
                          </button>
                        </div>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap max-w-xs overflow-hidden text-ellipsis font-medium">{c.name}</td>
                      <td className="px-6 py-4 whitespace-nowrap"><a href={`tel:${c.phone}`} className="text-blue-600 hover:underline">{c.phone}</a></td>
                      <td className="px-6 py-4 whitespace-nowrap">{c.email || '-'}</td>
                      <td className="px-6 py-4 whitespace-nowrap">{c.vehicle_type || '-'}</td>
                      <td className="px-6 py-4 whitespace-nowrap font-mono">{c.vehicle_number || '-'}</td>
                      <td className="px-6 py-4 whitespace-nowrap max-w-sm overflow-hidden text-ellipsis">{c.address || '-'}</td>
                    </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </SectionLoader>
          </div>

          {/* pagination */}
          <div className="flex items-center justify-between mt-3">
            <div className="text-sm text-gray-600">Showing {(customers||[]).length === 0 ? 0 : ((page-1)*pageSize+1)} - {Math.min(page*pageSize, (customers||[]).length)} of {(customers||[]).length} customers</div>
            <div className="flex items-center gap-2">
              <button disabled={page<=1} onClick={() => setPage(p => Math.max(1, p-1))} className="px-3 py-1 border rounded disabled:opacity-50">Prev</button>
              <div className="px-3 py-1 border rounded">{page}/{totalPages}</div>
              <button disabled={page>=totalPages} onClick={() => setPage(p => Math.min(totalPages, p+1))} className="px-3 py-1 border rounded disabled:opacity-50">Next</button>
            </div>
          </div>

          {/* Create / Edit Modal */}
          {showForm && (
            <Modal onClose={() => { setShowForm(false); setEditing(null); }} wide={false}>
              <h2 className="text-2xl font-bold mb-4">{editing ? 'Edit Customer' : 'Add Customer'}</h2>
              <form onSubmit={handleSubmit}>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium mb-1">Name *</label>
                    <input type="text" value={form.name} onChange={e => setForm(prev => ({ ...prev, name: e.target.value }))} className="w-full px-3 py-2 border rounded" required />
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-1">Phone *</label>
                    <input type="text" value={form.phone} onChange={e => setForm(prev => ({ ...prev, phone: e.target.value }))} className="w-full px-3 py-2 border rounded" required />
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-1">Email</label>
                    <input type="email" value={form.email} onChange={e => setForm(prev => ({ ...prev, email: e.target.value }))} className="w-full px-3 py-2 border rounded" />
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-1">Vehicle Type</label>
                    <input type="text" value={form.vehicle_type} onChange={e => setForm(prev => ({ ...prev, vehicle_type: e.target.value }))} className="w-full px-3 py-2 border rounded" />
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-1">Vehicle Number</label>
                    <input
                      type="text"
                      value={form.vehicle_number}
                      onChange={e => onVehicleNumberChange(e.target.value)}
                      className="w-full px-3 py-2 border rounded"
                      placeholder="Alphanumeric - will be uppercased"
                    />
                    <p className="text-xs text-gray-500 mt-1">Only A-Z and 0-9 are allowed. Will be stored in uppercase.</p>
                  </div>

                  <div className="col-span-2">
                    <label className="block text-sm font-medium mb-1">Address</label>
                    <textarea value={form.address} onChange={e => setForm(prev => ({ ...prev, address: e.target.value }))} rows="3" className="w-full px-3 py-2 border rounded"></textarea>
                  </div>
                </div>

                <div className="flex justify-end gap-3 mt-4">
                  <button type="button" onClick={() => { setShowForm(false); setEditing(null); }} className="px-4 py-2 border rounded hover:bg-gray-50" disabled={submitting}>Cancel</button>
                  <ButtonLoader loading={submitting} type="submit" className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">{editing ? 'Update' : 'Create'}</ButtonLoader>
                </div>
              </form>
            </Modal>
          )}

          {/* Service History modal */}
          {showServiceHistory && (
            <Modal onClose={() => { setShowServiceHistory(false); setServiceHistory([]); setServiceHistoryCustomer(null); }} wide={true}>
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-2xl font-bold">Service History</h2>
                <button onClick={() => window.print()} className="px-3 py-2 bg-gray-200 rounded">Print</button>
              </div>

              {/* Customer Details Card */}
              {serviceHistoryCustomer && (
                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                  <h3 className="text-lg font-semibold text-blue-900 mb-2">Customer Information</h3>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                    <div><span className="font-medium text-gray-700">Name:</span> <span className="text-gray-900">{serviceHistoryCustomer.name}</span></div>
                    {serviceHistoryCustomer.phone && (
                      <div><span className="font-medium text-gray-700">Phone:</span> <span className="text-gray-900">{serviceHistoryCustomer.phone}</span></div>
                    )}
                    {serviceHistoryCustomer.email && (
                      <div><span className="font-medium text-gray-700">Email:</span> <span className="text-gray-900">{serviceHistoryCustomer.email}</span></div>
                    )}
                    {serviceHistoryCustomer.vehicle_number && (
                      <div><span className="font-medium text-gray-700">Vehicle:</span> <span className="text-gray-900">{serviceHistoryCustomer.vehicle_number}</span></div>
                    )}
                    {serviceHistoryCustomer.vehicle_type && (
                      <div><span className="font-medium text-gray-700">Vehicle Type:</span> <span className="text-gray-900">{serviceHistoryCustomer.vehicle_type}</span></div>
                    )}
                    {serviceHistoryCustomer.address && (
                      <div className="md:col-span-2"><span className="font-medium text-gray-700">Address:</span> <span className="text-gray-900">{serviceHistoryCustomer.address}</span></div>
                    )}
                  </div>
                </div>
              )}

              <SectionLoader loading={loadingServiceHistory} message="Loading service history...">
                <div className="space-y-4">
                  {serviceHistory.length === 0 ? (
                    <div className="text-gray-500">No service history available.</div>
                  ) : (
                    serviceHistory.map((s, i) => (
                      <div key={i} className="p-4 border rounded bg-white shadow-sm">
                        <div className="flex justify-between items-start mb-3">
                          <div className="flex-1">
                            <div className="font-semibold text-lg">{s.job_number}</div>
                            <div className="text-sm text-gray-600">
                              {s.created_at && new Date(s.created_at).toLocaleDateString('en-IN', {
                                year: 'numeric', month: 'long', day: 'numeric'
                              })}
                            </div>
                          </div>
                          <div className="text-right">
                            <span className={`px-2 py-1 text-xs rounded ${s.status === 'closed' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}`}>
                              {s.status}
                            </span>
                          </div>
                        </div>

                        {s.tasks && s.tasks.length > 0 && (
                          <div className="mb-3">
                            <div className="text-sm font-medium text-gray-700 mb-1">Services Performed:</div>
                            <ul className="list-disc list-inside text-sm text-gray-600">
                              {s.tasks.map((task, idx) => (
                                <li key={idx}>{task.task_description}</li>
                              ))}
                            </ul>
                          </div>
                        )}

                        {s.stock_items && s.stock_items.length > 0 && (
                          <div className="mb-3">
                            <div className="text-sm font-medium text-gray-700 mb-1">Parts Used:</div>
                            <div className="overflow-x-auto">
                              <table className="min-w-full text-sm">
                                <thead className="bg-gray-50">
                                  <tr>
                                    <th className="px-2 py-1 text-left text-xs font-semibold text-gray-700">Part Name</th>
                                    <th className="px-2 py-1 text-right text-xs font-semibold text-gray-700">Qty</th>
                                    <th className="px-2 py-1 text-right text-xs font-semibold text-gray-700">Unit Price</th>
                                    <th className="px-2 py-1 text-right text-xs font-semibold text-gray-700">Total</th>
                                  </tr>
                                </thead>
                                <tbody className="text-gray-600">
                                  {s.stock_items.map((item, idx) => (
                                    <tr key={idx} className="border-t">
                                      <td className="px-2 py-1">{item.product_name}</td>
                                      <td className="px-2 py-1 text-right">{item.quantity}</td>
                                      <td className="px-2 py-1 text-right">â‚¹{item.unit_price.toFixed(2)}</td>
                                      <td className="px-2 py-1 text-right font-semibold">â‚¹{item.total_price.toFixed(2)}</td>
                                    </tr>
                                  ))}
                                </tbody>
                              </table>
                            </div>
                          </div>
                        )}

                        {s.bills && s.bills.length > 0 && (
                          <div className="mt-3 pt-3 border-t">
                            <div className="text-sm font-medium text-gray-700 mb-2">Bills:</div>
                            {s.bills.map((bill, idx) => (
                              <div key={idx} className="flex justify-between items-center bg-gray-50 p-2 rounded mb-2">
                                <div>
                                  <div className="font-medium text-sm">{bill.bill_number}</div>
                                  <div className="text-xs text-gray-600">
                                    {new Date(bill.bill_date).toLocaleDateString('en-IN')} â€¢ â‚¹{bill.total.toFixed(2)}
                                  </div>
                                </div>
                                <div className="flex gap-2 items-center">
                                  <span className={`px-2 py-0.5 text-xs rounded ${bill.payment_status === 'paid' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`}>
                                    {bill.payment_status.toUpperCase()}
                                  </span>
                                  <button
                                    onClick={() => {
                                      const token = localStorage.getItem('token');
                                      const url = `${API_URL}/bills/${bill.id}/view?token=${encodeURIComponent(token)}`;
                                      window.open(url, '_blank');
                                    }}
                                    className="px-2 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700"
                                  >
                                    View Bill
                                  </button>
                                </div>
                              </div>
                            ))}
                          </div>
                        )}

                        {s.notes && (
                          <div className="mt-3 pt-3 border-t">
                            <div className="text-sm text-gray-600">
                              <strong>Notes:</strong> {s.notes}
                            </div>
                          </div>
                        )}
                      </div>
                    ))
                  )}
                </div>
              </SectionLoader>
            </Modal>
          )}

          {loadingServiceHistory && <LoadingOverlay message="Loading service history..." />}

          {/* Comprehensive Job Card Modal - Create */}
          <JobCardModal
            isOpen={showComprehensiveJobCard}
            onClose={() => {
              setShowComprehensiveJobCard(false);
              setJobCardPrefilledData({});
            }}
            mode="edit"
            jobCardId={null}
            prefilledData={jobCardPrefilledData}
          />

          {/* Comprehensive Job Card Modal - View from Service History */}
          <JobCardModal
            isOpen={showViewJobCardModal}
            onClose={() => {
              setShowViewJobCardModal(false);
              setViewJobCardId(null);
            }}
            mode="view"
            jobCardId={viewJobCardId}
          />

          {/* View modal */}
          {showView && viewCustomer && (
            <Modal onClose={() => { setShowView(false); setViewCustomer(null); }} wide={false}>
              <h2 className="text-2xl font-bold mb-4">Customer Details</h2>
              <div className="grid grid-cols-2 gap-4 mb-6">
                <div><div className="text-sm text-gray-500">Name</div><div className="font-medium">{viewCustomer.name}</div></div>
                <div><div className="text-sm text-gray-500">Vehicle Type</div><div className="font-medium">{viewCustomer.vehicle_type || '-'}</div></div>
                <div><div className="text-sm text-gray-500">Vehicle Number</div><div className="font-medium">{viewCustomer.vehicle_number || '-'}</div></div>
                <div><div className="text-sm text-gray-500">Phone</div><div className="font-medium"><a href={`tel:${viewCustomer.phone}`} className="text-blue-600 hover:underline">{viewCustomer.phone}</a></div></div>
                <div><div className="text-sm text-gray-500">Email</div><div className="font-medium">{viewCustomer.email || '-'}</div></div>
                <div className="col-span-2"><div className="text-sm text-gray-500">Address</div><div className="font-medium">{viewCustomer.address || '-'}</div></div>
              </div>

              <div className="border-t pt-4 mb-4">
                <h3 className="text-lg font-semibold mb-3">Service Dates</h3>
                <div className="grid grid-cols-2 gap-4">
                  <div className="p-3 bg-blue-50 rounded">
                    <div className="text-sm text-gray-600">Last Service Date</div>
                    <div className="font-medium text-lg">{viewCustomer.last_service_date ? new Date(viewCustomer.last_service_date).toLocaleDateString() : 'Not available'}</div>
                  </div>
                  <div className="p-3 bg-green-50 rounded">
                    <div className="text-sm text-gray-600">Next Service Date</div>
                    <div className="font-medium text-lg">{viewCustomer.next_service_date ? new Date(viewCustomer.next_service_date).toLocaleDateString() : 'Not available'}</div>
                  </div>
                </div>
              </div>

              <div className="border-t pt-4">
                <h3 className="text-lg font-semibold mb-3">Call Log</h3>
                <div className="space-y-3">
                  <div className="max-h-72 overflow-y-auto">
                    {callNotes.length === 0 ? (
                      <div className="text-sm text-gray-500 p-3">No call notes yet</div>
                    ) : (
                      callNotes.map((n, idx) => (
                        <div key={idx} className="p-3 border rounded bg-gray-50 mb-2">
                          <div className="text-xs text-gray-500">{new Date(n.created_at).toLocaleString()}</div>
                          <div className="mt-1 text-sm">{n.note || n.notes || n.description}</div>
                        </div>
                      ))
                    )}
                  </div>
                  <div className="text-xs text-blue-600 text-center mt-2">ðŸ’¡ Add call logs from the Reminders section</div>
                </div>
              </div>
            </Modal>
          )}

          {/* Delete Confirmation Modal */}
          {showDeleteConfirm && (
            <ConfirmModal
              title="Delete Customer"
              message="Are you sure you want to delete this customer? This action cannot be undone."
              onConfirm={confirmDelete}
              onCancel={cancelDelete}
              loading={deleting}
            />
          )}
        </div>
      );
    }
    // ------------------ end Customers ------------------

    // ------------------ Reminders component ------------------
    function Reminders() {
      const [customers, setCustomers] = useState([]);
      const [reminderStart, setReminderStart] = useState(() => {
        const d = new Date();
        d.setDate(d.getDate()); // today
        return d.toISOString().split('T')[0];
      });
      const [reminderEnd, setReminderEnd] = useState(() => {
        const d = new Date();
        d.setDate(d.getDate() + 7); // 7 days from today
        return d.toISOString().split('T')[0];
      });
      const [page, setPage] = useState(1);
      const pageSize = 12;

      // Loading states
      const [loadingCustomers, setLoadingCustomers] = useState(false);
      const [loadingServiceHistory, setLoadingServiceHistory] = useState(false);
      const [loadingCallLogs, setLoadingCallLogs] = useState(false);
      const [addingCallNote, setAddingCallNote] = useState(false);

      // service history modal
      const [showServiceHistory, setShowServiceHistory] = useState(false);
      const [serviceHistory, setServiceHistory] = useState([]);
      const [serviceHistoryCustomer, setServiceHistoryCustomer] = useState(null);

      // View job card modal from service history
      const [showViewJobCardModal, setShowViewJobCardModal] = useState(false);
      const [viewJobCardId, setViewJobCardId] = useState(null);

      // call logs modal
      const [showCallLogs, setShowCallLogs] = useState(false);
      const [callLogs, setCallLogs] = useState([]);
      const [callLogsCustomer, setCallLogsCustomer] = useState(null);
      const [newCallNote, setNewCallNote] = useState('');

      useEffect(() => { loadCustomers(); }, []);

      const loadCustomers = async () => {
        setLoadingCustomers(true);
        try {
          const data = await apiCall('/customers');
          setCustomers(data || []);
          setPage(1);
        } catch (err) { console.error(err); }
        finally { setLoadingCustomers(false); }
      };

      const getReminders = () => {
        const list = (customers || []).map(c => ({ id: c.id, name: c.name, phone: c.phone, next_service_date: c.next_service_date })).filter(i => i.next_service_date);
        if (reminderStart && reminderEnd) {
          const s = new Date(reminderStart); s.setHours(0,0,0,0);
          const e = new Date(reminderEnd); e.setHours(23,59,59,999);
          return list.filter(i => { const d = new Date(i.next_service_date); return d >= s && d <= e; });
        }
        return list;
      };

      const openServiceHistory = async (customer) => {
        setLoadingServiceHistory(true);
        setServiceHistoryCustomer(customer);
        try {
          const data = await apiCall(`/customers/${customer.id}/service-history`);
          setServiceHistory(data || []);
        } catch (err) {
          console.warn('service history not available', err);
          setServiceHistory([]);
        }
        finally { setLoadingServiceHistory(false); setShowServiceHistory(true); }
      };

      const openCallLogs = async (customer) => {
        setLoadingCallLogs(true);
        try {
          const data = await apiCall(`/customers/${customer.id}/call-logs`);
          setCallLogs(data || []);
        } catch (err) {
          console.warn('call logs not available', err);
          setCallLogs([]);
        }
        finally { setLoadingCallLogs(false); setCallLogsCustomer(customer); setShowCallLogs(true); }
      };

      const addCallNote = async () => {
        if (!newCallNote.trim() || !callLogsCustomer) return;
        setAddingCallNote(true);
        const note = { note: newCallNote.trim(), created_at: new Date().toISOString() };
        setCallLogs(prev => [note, ...prev]);
        setNewCallNote('');
        try {
          await apiCall(`/customers/${callLogsCustomer.id}/call-logs`, { method: 'POST', body: JSON.stringify(note) });
        } catch (e) {
          console.warn('Failed to persist call note', e);
        }
        finally { setAddingCallNote(false); }
      };

      const reminders = getReminders();
      const totalPages = Math.max(1, Math.ceil(reminders.length / pageSize));
      const pagedReminders = reminders.slice((page-1)*pageSize, page*pageSize);

      return (
        <div>
          <div className="mb-6">
            <h1 className="text-3xl font-bold text-gray-800 mb-4">Reminders - Service Due</h1>
            <div className="bg-white rounded-lg shadow p-4 flex items-center justify-between flex-wrap gap-3">
              <div className="flex items-center gap-3">
                <label className="text-sm font-medium">Start Date</label>
                <input type="date" value={reminderStart} onChange={e => { setReminderStart(e.target.value); setPage(1); }} className="px-3 py-2 border rounded" />
                <label className="text-sm font-medium">End Date</label>
                <input type="date" value={reminderEnd} onChange={e => { setReminderEnd(e.target.value); setPage(1); }} className="px-3 py-2 border rounded" />
                <button onClick={() => { 
                  const d = new Date();
                  setReminderStart(d.toISOString().split('T')[0]);
                  setReminderEnd(new Date(d.getTime() + 7*24*60*60*1000).toISOString().split('T')[0]);
                  setPage(1);
                }} className="px-3 py-2 bg-gray-200 rounded hover:bg-gray-300">Reset (7 days)</button>
              </div>
              <div className="text-sm font-medium text-blue-600">Total: {reminders.length} reminders</div>
            </div>
          </div>

          <div className="bg-white rounded-lg shadow overflow-hidden">
            <SectionLoader loading={loadingCustomers} message="Loading reminders...">
              <div className="w-full overflow-x-auto">
                <table className="min-w-[900px] w-full table-auto">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Phone</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Next Service Date</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-200">
                    {pagedReminders.map(r => {
                      const serviceDate = new Date(r.next_service_date);
                      const today = new Date();
                      today.setHours(0,0,0,0);
                      const daysUntil = Math.ceil((serviceDate.getTime() - today.getTime()) / (1000*60*60*24));
                      const isPast = daysUntil < 0;
                      const statusText = isPast ? `Overdue for ${Math.abs(daysUntil)} days` : `Upcoming service in ${daysUntil} days`;
                      const statusColor = isPast ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800';

                      return (
                        <tr key={r.id} className={`${isPast ? 'bg-red-50 hover:bg-red-100' : 'hover:bg-gray-50'}`}>
                          <td className="px-6 py-4 whitespace-nowrap">
                            <div className="flex items-center gap-2">
                              {/* service history */}
                              <button
                                title="Service History"
                                onClick={() => { const c = customers.find(x=>x.id===r.id); if(c) openServiceHistory(c); }}
                                className="text-indigo-600 hover:text-indigo-800">
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                  <path d="M8 2a1 1 0 011 1v1h2V3a1 1 0 112 0v1h1a2 2 0 012 2v1H3V6a2 2 0 012-2h1V3a1 1 0 011-1z" />
                                  <path d="M3 9h14v6a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                </svg>
                              </button>

                              {/* call logs */}
                              <button
                                title="Call Logs"
                                onClick={() => { const c = customers.find(x=>x.id===r.id); if(c) openCallLogs(c); }}
                                className="text-green-600 hover:text-green-800">
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                  <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773c.058.3.102.605.102.92v1.972c0 .78.545 1.437 1.276 1.782.58.305 1.316.309 1.896 0 .76-.397 1.276-1.002 1.276-1.782V8.004c0-.315.044-.62.102-.92l-1.548-.773a1 1 0 01-.54-1.06l.74-4.435A1 1 0 0110.848 2h2.153a1 1 0 011 1v2a1 1 0 11-2 0V3h-2v2a1 1 0 11-2 0V3H4v2a1 1 0 11-2 0V3z" />
                                </svg>
                              </button>
                            </div>
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap font-medium">{r.name}</td>
                          <td className="px-6 py-4 whitespace-nowrap"><a href={`tel:${r.phone}`} className="text-blue-600 hover:underline">{r.phone}</a></td>
                          <td className="px-6 py-4 whitespace-nowrap">{serviceDate.toLocaleDateString()}</td>
                          <td className="px-6 py-4 whitespace-nowrap">
                            <span className={`px-3 py-1 rounded-full text-sm font-medium ${statusColor}`}>
                              {statusText}
                            </span>
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            </SectionLoader>
          </div>

          {/* pagination */}
          <div className="flex items-center justify-between mt-3">
            <div className="text-sm text-gray-600">Showing {reminders.length === 0 ? 0 : ((page-1)*pageSize+1)} - {Math.min(page*pageSize, reminders.length)} of {reminders.length} reminders</div>
            <div className="flex items-center gap-2">
              <button disabled={page<=1} onClick={() => setPage(p => Math.max(1, p-1))} className="px-3 py-1 border rounded disabled:opacity-50">Prev</button>
              <div className="px-3 py-1 border rounded">{page}/{totalPages}</div>
              <button disabled={page>=totalPages} onClick={() => setPage(p => Math.min(totalPages, p+1))} className="px-3 py-1 border rounded disabled:opacity-50">Next</button>
            </div>
          </div>

          {/* Service History Modal */}
          {showServiceHistory && (
            <Modal onClose={() => { setShowServiceHistory(false); setServiceHistory([]); setServiceHistoryCustomer(null); }} wide={true}>
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-2xl font-bold">Service History</h2>
                <button onClick={() => window.print()} className="px-3 py-2 bg-gray-200 rounded">Print</button>
              </div>

              {/* Customer Details Card */}
              {serviceHistoryCustomer && (
                <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                  <h3 className="text-lg font-semibold text-blue-900 mb-2">Customer Information</h3>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                    <div><span className="font-medium text-gray-700">Name:</span> <span className="text-gray-900">{serviceHistoryCustomer.name}</span></div>
                    {serviceHistoryCustomer.phone && (
                      <div><span className="font-medium text-gray-700">Phone:</span> <span className="text-gray-900">{serviceHistoryCustomer.phone}</span></div>
                    )}
                    {serviceHistoryCustomer.email && (
                      <div><span className="font-medium text-gray-700">Email:</span> <span className="text-gray-900">{serviceHistoryCustomer.email}</span></div>
                    )}
                    {serviceHistoryCustomer.vehicle_number && (
                      <div><span className="font-medium text-gray-700">Vehicle:</span> <span className="text-gray-900">{serviceHistoryCustomer.vehicle_number}</span></div>
                    )}
                    {serviceHistoryCustomer.vehicle_type && (
                      <div><span className="font-medium text-gray-700">Vehicle Type:</span> <span className="text-gray-900">{serviceHistoryCustomer.vehicle_type}</span></div>
                    )}
                    {serviceHistoryCustomer.address && (
                      <div className="md:col-span-2"><span className="font-medium text-gray-700">Address:</span> <span className="text-gray-900">{serviceHistoryCustomer.address}</span></div>
                    )}
                  </div>
                </div>
              )}

              <SectionLoader loading={loadingServiceHistory} message="Loading service history...">
                <div className="space-y-4">
                  {serviceHistory.length === 0 ? (
                    <div className="text-gray-500">No service history available.</div>
                  ) : (
                    serviceHistory.map((s, i) => (
                      <div key={i} className="p-4 border rounded bg-white shadow-sm">
                        <div className="flex justify-between items-start mb-3">
                          <div className="flex-1">
                            <div className="font-semibold text-lg">{s.job_number}</div>
                            <div className="text-sm text-gray-600">
                              {s.created_at && new Date(s.created_at).toLocaleDateString('en-IN', {
                                year: 'numeric', month: 'long', day: 'numeric'
                              })}
                            </div>
                          </div>
                          <div className="text-right flex gap-2 items-center">
                            <span className={`px-2 py-1 text-xs rounded ${s.status === 'closed' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}`}>
                              {s.status}
                            </span>
                            <button
                              onClick={() => {
                                setViewJobCardId(s.id);
                                setShowViewJobCardModal(true);
                              }}
                              className="px-3 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700"
                              title="View/Print Job Card"
                            >
                              View Job Card
                            </button>
                          </div>
                        </div>

                        {/* Job Card Summary */}
                        <div className="grid grid-cols-2 gap-4 mb-3 p-3 bg-gray-50 rounded">
                          <div>
                            {s.vehicle_model && (
                              <div className="text-sm"><span className="font-medium text-gray-700">Vehicle:</span> {s.vehicle_model}</div>
                            )}
                            {s.registration_no && (
                              <div className="text-sm"><span className="font-medium text-gray-700">Reg No:</span> {s.registration_no}</div>
                            )}
                            {s.kms_run && (
                              <div className="text-sm"><span className="font-medium text-gray-700">KMs:</span> {s.kms_run}</div>
                            )}
                          </div>
                          <div>
                            {s.service_advisor_name && (
                              <div className="text-sm"><span className="font-medium text-gray-700">Advisor:</span> {s.service_advisor_name}</div>
                            )}
                            {s.technician_name && (
                              <div className="text-sm"><span className="font-medium text-gray-700">Technician:</span> {s.technician_name}</div>
                            )}
                            {s.estimated_cost && (
                              <div className="text-sm"><span className="font-medium text-gray-700">Est. Cost:</span> â‚¹{s.estimated_cost}</div>
                            )}
                          </div>
                        </div>

                        {s.tasks && s.tasks.length > 0 && (
                          <div className="mb-3">
                            <div className="text-sm font-medium text-gray-700 mb-1">Services Performed ({s.tasks.length}):</div>
                            <ul className="list-disc list-inside text-sm text-gray-600">
                              {s.tasks.slice(0, 3).map((task, idx) => (
                                <li key={idx}>{task.task_description}</li>
                              ))}
                              {s.tasks.length > 3 && (
                                <li className="text-blue-600 cursor-pointer" onClick={() => {
                                  const token = localStorage.getItem('token');
                                  const url = `${API_URL}/job-cards/${s.id}/view?token=${encodeURIComponent(token)}`;
                                  window.open(url, '_blank');
                                }}>
                                  ... and {s.tasks.length - 3} more (click to view full job card)
                                </li>
                              )}
                            </ul>
                          </div>
                        )}

                        {s.stock_items && s.stock_items.length > 0 && (
                          <div className="mb-3">
                            <div className="text-sm font-medium text-gray-700 mb-1">Parts Used ({s.stock_items.length}):</div>
                            {s.stock_items.length <= 3 ? (
                              <div className="overflow-x-auto">
                                <table className="min-w-full text-sm">
                                  <thead className="bg-gray-50">
                                    <tr>
                                      <th className="px-2 py-1 text-left text-xs font-semibold text-gray-700">Part Name</th>
                                      <th className="px-2 py-1 text-right text-xs font-semibold text-gray-700">Qty</th>
                                      <th className="px-2 py-1 text-right text-xs font-semibold text-gray-700">Total</th>
                                    </tr>
                                  </thead>
                                  <tbody className="text-gray-600">
                                    {s.stock_items.map((item, idx) => (
                                      <tr key={idx} className="border-t">
                                        <td className="px-2 py-1">{item.product_name}</td>
                                        <td className="px-2 py-1 text-right">{item.quantity}</td>
                                        <td className="px-2 py-1 text-right font-semibold">â‚¹{item.total_price.toFixed(2)}</td>
                                      </tr>
                                    ))}
                                  </tbody>
                                </table>
                              </div>
                            ) : (
                              <div className="text-sm text-gray-600">
                                {s.stock_items.slice(0, 3).map((item, idx) => (
                                  <div key={idx}>{item.product_name} (x{item.quantity}) - â‚¹{item.total_price.toFixed(2)}</div>
                                ))}
                                <div className="text-blue-600 cursor-pointer mt-1" onClick={() => {
                                  const token = localStorage.getItem('token');
                                  const url = `${API_URL}/job-cards/${s.id}/view?token=${encodeURIComponent(token)}`;
                                  window.open(url, '_blank');
                                }}>
                                  ... and {s.stock_items.length - 3} more parts (click to view full job card)
                                </div>
                              </div>
                            )}
                          </div>
                        )}

                        {s.bills && s.bills.length > 0 && (
                          <div className="mt-3 pt-3 border-t">
                            <div className="text-sm font-medium text-gray-700 mb-2">Bills:</div>
                            {s.bills.map((bill, idx) => (
                              <div key={idx} className="flex justify-between items-center bg-gray-50 p-2 rounded mb-2">
                                <div>
                                  <div className="font-medium text-sm">{bill.bill_number}</div>
                                  <div className="text-xs text-gray-600">
                                    {new Date(bill.bill_date).toLocaleDateString('en-IN')} â€¢ â‚¹{bill.total.toFixed(2)}
                                  </div>
                                </div>
                                <div className="flex gap-2 items-center">
                                  <span className={`px-2 py-0.5 text-xs rounded ${bill.payment_status === 'paid' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`}>
                                    {bill.payment_status.toUpperCase()}
                                  </span>
                                  <button
                                    onClick={() => {
                                      const token = localStorage.getItem('token');
                                      const url = `${API_URL}/bills/${bill.id}/view?token=${encodeURIComponent(token)}`;
                                      window.open(url, '_blank');
                                    }}
                                    className="px-2 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700"
                                  >
                                    View Bill
                                  </button>
                                </div>
                              </div>
                            ))}
                          </div>
                        )}

                        {s.remarks && (
                          <div className="mt-3 pt-3 border-t">
                            <div className="text-sm text-gray-600">
                              <strong>Remarks:</strong> {s.remarks.length > 100 ? s.remarks.substring(0, 100) + '...' : s.remarks}
                            </div>
                          </div>
                        )}
                      </div>
                    ))
                  )}
                </div>
              </SectionLoader>
            </Modal>
          )}

          {/* Call Logs Modal */}
          {showCallLogs && callLogsCustomer && (
            <Modal onClose={() => { setShowCallLogs(false); setCallLogsCustomer(null); setCallLogs([]); setNewCallNote(''); }} wide={false}>
              <h2 className="text-2xl font-bold mb-4">Call Logs - {callLogsCustomer.name}</h2>
              <div className="space-y-3">
                <div className="bg-blue-50 p-3 rounded border border-blue-200">
                  <label className="text-sm font-medium block mb-2">Add New Call Log</label>
                  <div className="flex gap-2">
                    <input
                      value={newCallNote}
                      onChange={e => setNewCallNote(e.target.value)}
                      placeholder="Enter call notes..."
                      className="flex-1 px-3 py-2 border rounded"
                      disabled={addingCallNote}
                    />
                    <ButtonLoader
                      loading={addingCallNote}
                      onClick={addCallNote}
                      className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                      Add
                    </ButtonLoader>
                  </div>
                </div>

                <div className="border-t pt-3">
                  <h3 className="text-sm font-semibold mb-2">Call History</h3>
                  <SectionLoader loading={loadingCallLogs} message="Loading call logs...">
                    <div className="max-h-96 overflow-y-auto">
                      {callLogs.length === 0 ? (
                        <div className="text-sm text-gray-500 p-3">No call logs yet</div>
                      ) : (
                        callLogs.map((log, idx) => (
                          <div key={idx} className="p-3 border rounded bg-gray-50 mb-2">
                            <div className="text-xs text-gray-500">{new Date(log.created_at).toLocaleString()}</div>
                            <div className="text-sm text-gray-600 mt-1">By: {log.created_by || 'Unknown'}</div>
                            <div className="mt-2 text-sm">{log.note || log.notes}</div>
                          </div>
                        ))
                      )}
                    </div>
                  </SectionLoader>
                </div>
              </div>
            </Modal>
          )}

          {/* Comprehensive Job Card Modal - View from Service History */}
          <JobCardModal
            isOpen={showViewJobCardModal}
            onClose={() => {
              setShowViewJobCardModal(false);
              setViewJobCardId(null);
            }}
            mode="view"
            jobCardId={viewJobCardId}
          />
        </div>
      );
    }
    // ------------------ end Reminders ------------------

    function Dashboard() {
      const { user } = React.useContext(AuthContext);
      const { navigate } = React.useContext(NavigationContext);
      const [stats, setStats] = useState(null);
      const [loadingStats, setLoadingStats] = useState(false);

      useEffect(() => {
        loadDashboardData();
      }, []);

      const loadDashboardData = async () => {
        setLoadingStats(true);
        try {
          const d = await apiCall('/dashboard/stats');
          setStats(d);
        } catch (e) {
          console.error(e);
        } finally {
          setLoadingStats(false);
        }
      };

      return (
        <div className="space-y-6">
          {/* Header */}
          <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
            <div>
              <h1 className="text-2xl lg:text-3xl font-bold text-gray-800">Dashboard</h1>
              <p className="text-sm text-gray-500 mt-1">Welcome back, {user?.username || 'User'} â€” {new Date().toLocaleDateString('en-IN', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
            </div>
            <button
              onClick={loadDashboardData}
              className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm flex items-center gap-2"
            >
              <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
              Refresh
            </button>
          </div>

          <SectionLoader loading={loadingStats} message="Loading dashboard...">
            {/* Key Metrics Cards */}
            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 lg:gap-6">
              {/* Today's Sales */}
              <div className="bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-xl shadow-lg text-white transform hover:scale-105 transition-transform">
                <div className="flex items-center justify-between mb-4">
                  <div className="bg-white bg-opacity-20 p-3 rounded-lg">
                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                  </div>
                </div>
                <div className="text-sm font-medium opacity-90">Today's Sales</div>
                <div className="text-3xl font-bold mt-2">â‚¹{(stats?.today_sales ?? 0).toFixed(2)}</div>
                <div className="text-xs opacity-75 mt-2">{stats?.today_transactions ?? 0} transactions</div>
              </div>

              {/* Monthly Sales */}
              <div className="bg-gradient-to-br from-green-500 to-green-600 p-6 rounded-xl shadow-lg text-white transform hover:scale-105 transition-transform">
                <div className="flex items-center justify-between mb-4">
                  <div className="bg-white bg-opacity-20 p-3 rounded-lg">
                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                  </div>
                </div>
                <div className="text-sm font-medium opacity-90">Monthly Sales</div>
                <div className="text-3xl font-bold mt-2">â‚¹{(stats?.monthly_sales ?? 0).toFixed(2)}</div>
                <div className="text-xs opacity-75 mt-2">Last 30 days</div>
              </div>

              {/* Total Customers */}
              <div className="bg-gradient-to-br from-purple-500 to-purple-600 p-6 rounded-xl shadow-lg text-white transform hover:scale-105 transition-transform">
                <div className="flex items-center justify-between mb-4">
                  <div className="bg-white bg-opacity-20 p-3 rounded-lg">
                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                  </div>
                </div>
                <div className="text-sm font-medium opacity-90">Total Customers</div>
                <div className="text-3xl font-bold mt-2">{stats?.total_customers ?? 0}</div>
                <div className="text-xs opacity-75 mt-2">{stats?.active_services ?? 0} active services</div>
              </div>

              {/* Low Stock Alert */}
              <div className="bg-gradient-to-br from-orange-500 to-orange-600 p-6 rounded-xl shadow-lg text-white transform hover:scale-105 transition-transform">
                <div className="flex items-center justify-between mb-4">
                  <div className="bg-white bg-opacity-20 p-3 rounded-lg">
                    <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                    </svg>
                  </div>
                </div>
                <div className="text-sm font-medium opacity-90">Low Stock Items</div>
                <div className="text-3xl font-bold mt-2">{stats?.low_stock_items ?? 0}</div>
                <div className="text-xs opacity-75 mt-2">Needs attention</div>
              </div>
            </div>

            {/* Service Reminders */}
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              {/* Upcoming Services */}
              <div className="bg-white p-6 rounded-xl shadow-lg">
                <div className="flex items-center justify-between mb-4">
                  <div className="flex items-center gap-3">
                    <div className="bg-blue-100 p-2 rounded-lg">
                      <svg className="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                      </svg>
                    </div>
                    <div>
                      <h3 className="text-lg font-bold text-gray-800">Upcoming Services</h3>
                      <p className="text-xs text-gray-500">Next 7 days</p>
                    </div>
                  </div>
                  <div className="bg-blue-100 text-blue-600 px-3 py-1 rounded-full text-xs font-semibold">
                    {stats?.upcoming_count ?? 0}
                  </div>
                </div>
                <div className="space-y-2 max-h-80 overflow-y-auto">
                  {stats?.upcoming_services && stats.upcoming_services.length > 0 ? (
                    stats.upcoming_services.slice(0, 10).map(s => (
                      <div key={s.id} className="p-3 border border-gray-200 rounded-lg hover:bg-blue-50 hover:border-blue-300 transition-colors">
                        <div className="flex justify-between items-start">
                          <div className="flex-1">
                            <div className="font-medium text-gray-800">{s.name}</div>
                            <div className="text-sm text-gray-500 mt-1">{s.phone}</div>
                          </div>
                          <div className="text-right">
                            <div className="text-xs font-medium text-blue-600">{new Date(s.next_service_date).toLocaleDateString('en-IN', { month: 'short', day: 'numeric' })}</div>
                          </div>
                        </div>
                      </div>
                    ))
                  ) : (
                    <div className="text-center py-8 text-gray-400">
                      <svg className="w-12 h-12 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                      </svg>
                      <p className="text-sm">No upcoming services</p>
                    </div>
                  )}
                </div>
              </div>

              {/* Overdue Services */}
              <div className="bg-white p-6 rounded-xl shadow-lg">
                <div className="flex items-center justify-between mb-4">
                  <div className="flex items-center gap-3">
                    <div className="bg-red-100 p-2 rounded-lg">
                      <svg className="w-5 h-5 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                    </div>
                    <div>
                      <h3 className="text-lg font-bold text-gray-800">Overdue Services</h3>
                      <p className="text-xs text-gray-500">Past 7 days</p>
                    </div>
                  </div>
                  <div className="bg-red-100 text-red-600 px-3 py-1 rounded-full text-xs font-semibold">
                    {stats?.overdue_count ?? 0}
                  </div>
                </div>
                <div className="space-y-2 max-h-80 overflow-y-auto">
                  {stats?.overdue_services && stats.overdue_services.length > 0 ? (
                    stats.overdue_services.slice(0, 10).map(s => (
                      <div key={s.id} className="p-3 border border-gray-200 rounded-lg hover:bg-red-50 hover:border-red-300 transition-colors">
                        <div className="flex justify-between items-start">
                          <div className="flex-1">
                            <div className="font-medium text-gray-800">{s.name}</div>
                            <div className="text-sm text-gray-500 mt-1">{s.phone}</div>
                          </div>
                          <div className="text-right">
                            <div className="text-xs font-medium text-red-600">{new Date(s.next_service_date).toLocaleDateString('en-IN', { month: 'short', day: 'numeric' })}</div>
                            <div className="text-xs text-red-500 mt-1">Overdue</div>
                          </div>
                        </div>
                      </div>
                    ))
                  ) : (
                    <div className="text-center py-8 text-gray-400">
                      <svg className="w-12 h-12 mx-auto mb-2 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                      </svg>
                      <p className="text-sm">No overdue services</p>
                    </div>
                  )}
                </div>
              </div>
            </div>

            {/* Quick Actions */}
            <div className="bg-gradient-to-r from-indigo-500 to-purple-600 p-6 rounded-xl shadow-lg">
              <h3 className="text-lg font-bold text-white mb-4">Quick Actions</h3>
              <div className="grid grid-cols-2 sm:grid-cols-4 gap-3">
                <button
                  onClick={() => navigate('customers')}
                  className="bg-white bg-opacity-20 hover:bg-opacity-30 backdrop-blur-sm text-white p-4 rounded-lg transition-all flex flex-col items-center gap-2"
                >
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />
                  </svg>
                  <span className="text-sm font-medium">Add Customer</span>
                </button>
                <button
                  onClick={() => navigate('jobcards')}
                  className="bg-white bg-opacity-20 hover:bg-opacity-30 backdrop-blur-sm text-white p-4 rounded-lg transition-all flex flex-col items-center gap-2"
                >
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                  </svg>
                  <span className="text-sm font-medium">New Job Card</span>
                </button>
                <button
                  onClick={() => navigate('sales')}
                  className="bg-white bg-opacity-20 hover:bg-opacity-30 backdrop-blur-sm text-white p-4 rounded-lg transition-all flex flex-col items-center gap-2"
                >
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <span className="text-sm font-medium">Make Sale</span>
                </button>
                <button
                  onClick={() => navigate('stock')}
                  className="bg-white bg-opacity-20 hover:bg-opacity-30 backdrop-blur-sm text-white p-4 rounded-lg transition-all flex flex-col items-center gap-2"
                >
                  <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                  </svg>
                  <span className="text-sm font-medium">Add Stock</span>
                </button>
              </div>
            </div>
          </SectionLoader>
        </div>
      );
    }

    // Products Component - Transaction-based inventory
    function Products() {
      const [products, setProducts] = useState([]);
      const [filteredProducts, setFilteredProducts] = useState([]);
      const [showForm, setShowForm] = useState(false);
      const [editing, setEditing] = useState(null);
      const [showView, setShowView] = useState(false);
      const [viewProduct, setViewProduct] = useState(null);
      const [searchTerm, setSearchTerm] = useState('');
      const [rackFilter, setRackFilter] = useState('');
      const [allRacks, setAllRacks] = useState([]);
      const [showPurchase, setShowPurchase] = useState(false);
      const [purchaseProduct, setPurchaseProduct] = useState(null);
      const [showHistory, setShowHistory] = useState(false);
      const [historyProduct, setHistoryProduct] = useState(null);
      const [transactions, setTransactions] = useState([]);

      // Loading states
      const [loadingProducts, setLoadingProducts] = useState(false);
      const [submitting, setSubmitting] = useState(false);
      const [deleting, setDeleting] = useState(false);
      const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
      const [deleteId, setDeleteId] = useState(null);

      const initialForm = {
        name: '',
        sell_price: '',
        rack_id: '',
        additional_info: ''
      };

      const initialPurchaseForm = {
        quantity: '',
        unit_cost: '',
        reference_no: '',
        notes: ''
      };

      const [form, setForm] = useState(initialForm);
      const [purchaseForm, setPurchaseForm] = useState(initialPurchaseForm);

      useEffect(() => { loadProducts(); }, []);

      useEffect(() => {
        filterProducts();
      }, [products, searchTerm, rackFilter]);

      const loadProducts = async () => {
        setLoadingProducts(true);
        try {
          const data = await apiCall('/products');
          setProducts(data);

          // Extract unique rack IDs
          const racks = [...new Set(data.map(p => p.rack_id).filter(r => r))].sort();
          setAllRacks(racks);
        } catch (err) { console.error(err); }
        finally { setLoadingProducts(false); }
      };

      const filterProducts = () => {
        let filtered = products;

        // Filter by search term (name)
        if (searchTerm.trim()) {
          const term = searchTerm.toLowerCase();
          filtered = filtered.filter(p => 
            p.name.toLowerCase().includes(term)
          );
        }

        // Filter by rack
        if (rackFilter) {
          filtered = filtered.filter(p => p.rack_id === rackFilter);
        }

        setFilteredProducts(filtered);
      };

      const validateForm = () => {
        if (!form.name.trim()) { alert('Product name is required'); return false; }
        if (!form.sell_price || isNaN(form.sell_price) || parseFloat(form.sell_price) <= 0) {
          alert('Sell price is required and must be a positive number'); return false;
        }
        if (!form.quantity || isNaN(form.quantity) || parseInt(form.quantity) < 0) {
          alert('Quantity is required and must be a non-negative number'); return false;
        }
        if (!form.purchase_price || isNaN(form.purchase_price) || parseFloat(form.purchase_price) <= 0) {
          alert('Purchase price is required and must be a positive number'); return false;
        }
        return true;
      };

      const openCreate = () => { setEditing(null); setForm(initialForm); setShowForm(true); };
      const openEdit = (p) => {
        setEditing(p);
        setForm({
          name: p.name ?? '',
          sell_price: p.sell_price ?? '',
          quantity: p.quantity ?? '',
          purchase_price: p.purchase_price ?? '',
          rack_id: p.rack_id ?? '',
          additional_info: p.additional_info ?? ''
        });
        setShowForm(true);
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!validateForm()) return;
        setSubmitting(true);
        try {
          const payload = {
            name: form.name,
            sell_price: parseFloat(form.sell_price),
            quantity: parseInt(form.quantity),
            purchase_price: parseFloat(form.purchase_price),
            rack_id: form.rack_id || null,
            additional_info: form.additional_info || null
          };
          if (editing) {
            await apiCall(`/products/${editing.id}`, { method: 'PUT', body: JSON.stringify(payload) });
          } else {
            await apiCall('/products', { method: 'POST', body: JSON.stringify(payload) });
          }
          setShowForm(false); setEditing(null); setForm(initialForm); loadProducts();
        } catch (err) { alert(err.message); }
        finally { setSubmitting(false); }
      };

      const handleDelete = async (id) => { setDeleteId(id); setShowDeleteConfirm(true); };

      const confirmDelete = async () => {
        setDeleting(true);
        try { await apiCall(`/products/${deleteId}`, { method: 'DELETE' }); loadProducts(); } catch (err) { alert(err.message); }
        finally { setDeleting(false); setShowDeleteConfirm(false); setDeleteId(null); }
      };

      const cancelDelete = () => { setShowDeleteConfirm(false); setDeleteId(null); };

      const handleView = (product) => { setViewProduct(product); setShowView(true); };

      const calculateTotals = (product) => {
        const totalPurchasePrice = parseFloat(product.purchase_price) * parseInt(product.quantity);
        const expectedTotalSellPrice = parseFloat(product.sell_price) * parseInt(product.quantity);
        const potentialProfit = expectedTotalSellPrice - totalPurchasePrice;
        return { totalPurchasePrice, expectedTotalSellPrice, potentialProfit };
      };

      const clearFilters = () => {
        setSearchTerm('');
        setRackFilter('');
      };

      return (
        <div>
          <div className="flex justify-between items-center mb-4">
            <h1 className="text-3xl font-bold text-gray-800">Products & Inventory</h1>
            <button onClick={openCreate} className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">+ Add Product</button>
          </div>

          {/* New System Banner */}
          <div className="bg-gradient-to-r from-green-500 to-blue-500 rounded-lg p-4 mb-6 text-white shadow-lg">
            <div className="flex items-center justify-between">
              <div>
                <h3 className="font-bold text-lg mb-1">âœ¨ New: Advanced Stock Management Available!</h3>
                <p className="text-sm">Track multiple purchases at different prices â€¢ Weighted average costing â€¢ Document management â€¢ Complete audit trail</p>
              </div>
              <a 
                href="#" 
                onClick={(e) => { e.preventDefault(); window.location.href = '/test.html'; }} 
                className="bg-white text-blue-600 px-6 py-2 rounded-lg hover:bg-gray-100 font-bold whitespace-nowrap ml-4"
              >
                Open Stock Management â†’
              </a>
            </div>
          </div>

          {/* Search and Filter Bar */}
          <div className="bg-white rounded-lg shadow p-4 mb-6">
            <div className="flex flex-wrap gap-4 items-end">
              <div className="flex-1 min-w-[250px]">
                <label className="block text-sm font-medium text-gray-700 mb-1">Search Products</label>
                <input
                  type="text"
                  value={searchTerm}
                  onChange={e => setSearchTerm(e.target.value)}
                  placeholder="Search by product name..."
                  className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                />
              </div>
              
              <div className="min-w-[200px]">
                <label className="block text-sm font-medium text-gray-700 mb-1">Filter by Rack</label>
                <select
                  value={rackFilter}
                  onChange={e => setRackFilter(e.target.value)}
                  className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                >
                  <option value="">All Racks</option>
                  {allRacks.map(rack => (
                    <option key={rack} value={rack}>{rack}</option>
                  ))}
                </select>
              </div>

              {(searchTerm || rackFilter) && (
                <button
                  onClick={clearFilters}
                  className="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600"
                >
                  Clear Filters
                </button>
              )}

              <div className="text-sm text-gray-600 py-2">
                Showing {filteredProducts.length} of {products.length} products
              </div>
            </div>
          </div>

          <div className="bg-white rounded-lg shadow overflow-hidden">
            <SectionLoader loading={loadingProducts} message="Loading products...">
              <div className="w-full overflow-x-auto">
                <table className="min-w-[1100px] w-full table-auto">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Product Name</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Unit Sell Price (â‚¹)</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Quantity</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Unit Purchase Price (â‚¹)</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total Purchase (â‚¹)</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Expected Total Sell (â‚¹)</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Rack ID</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-200">
                    {filteredProducts.map(p => {
                      const { totalPurchasePrice, expectedTotalSellPrice } = calculateTotals(p);
                      return (
                        <tr key={p.id} className="hover:bg-gray-50">
                          <td className="px-6 py-4 whitespace-nowrap">
                            <div className="flex items-center gap-3">
                              <button title="View" onClick={() => handleView(p)} className="text-gray-600 hover:text-gray-900">
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M2.458 12C3.732 7.943 7.523 5 12 5s8.268 2.943 9.542 7c-1.274 4.057-5.065 7-9.542 7S3.732 16.057 2.458 12z" />
                                </svg>
                              </button>
                              <button title="Edit" onClick={() => openEdit(p)} className="text-blue-600 hover:text-blue-800">
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                  <path d="M17.414 2.586a2 2 0 010 2.828L8.414 14.414a1 1 0 01-.464.263l-4 1a1 1 0 01-1.213-1.213l1-4a1 1 0 01.263-.464L14.586 2.586a2 2 0 012.828 0z" />
                                </svg>
                              </button>
                              <button title="Delete" onClick={() => handleDelete(p.id)} className="text-red-600 hover:text-red-800">
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                  <path fillRule="evenodd" d="M6 2a1 1 0 00-1 1v1H3a1 1 0 100 2h14a1 1 0 100-2h-2V3a1 1 0 00-1-1H6zm2 6a1 1 0 10-2 0v7a1 1 0 102 0V8zm6 0a1 1 0 10-2 0v7a1 1 0 102 0V8z" clipRule="evenodd" />
                                </svg>
                              </button>
                            </div>
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap max-w-xs overflow-hidden text-ellipsis font-medium">{p.name}</td>
                          <td className="px-6 py-4 whitespace-nowrap">â‚¹{parseFloat(p.sell_price).toFixed(2)}</td>
                          <td className="px-6 py-4 whitespace-nowrap">{p.quantity}</td>
                          <td className="px-6 py-4 whitespace-nowrap">â‚¹{parseFloat(p.purchase_price).toFixed(2)}</td>
                          <td className="px-6 py-4 whitespace-nowrap font-medium text-orange-600">â‚¹{totalPurchasePrice.toFixed(2)}</td>
                          <td className="px-6 py-4 whitespace-nowrap font-medium text-green-600">â‚¹{expectedTotalSellPrice.toFixed(2)}</td>
                          <td className="px-6 py-4 whitespace-nowrap">{p.rack_id || '-'}</td>
                        </tr>
                      );
                    })}
                    {filteredProducts.length === 0 && (
                      <tr>
                        <td colSpan="9" className="px-6 py-8 text-center text-gray-500">
                          No products found. {searchTerm || rackFilter ? 'Try adjusting your filters.' : 'Add your first product to get started.'}
                        </td>
                      </tr>
                    )}
                  </tbody>
                </table>
              </div>
            </SectionLoader>
          </div>

          {/* Create / Edit Modal */}
          {showForm && (
            <Modal onClose={() => { setShowForm(false); setEditing(null); }} wide={false}>
              <h2 className="text-2xl font-bold mb-4">{editing ? 'Edit Product' : 'Add Product'}</h2>
              <form onSubmit={handleSubmit}>
                <div className="grid grid-cols-2 gap-4">
                  <div className="col-span-2">
                    <label className="block text-sm font-medium mb-1">Product Name *</label>
                    <input type="text" value={form.name} onChange={e => setForm(prev => ({ ...prev, name: e.target.value }))} className="w-full px-3 py-2 border rounded" required />
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-1">Unit Sell Price (â‚¹) *</label>
                    <input type="number" step="0.01" min="0" value={form.sell_price} onChange={e => setForm(prev => ({ ...prev, sell_price: e.target.value }))} className="w-full px-3 py-2 border rounded" required />
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-1">Quantity *</label>
                    <input type="number" min="0" value={form.quantity} onChange={e => setForm(prev => ({ ...prev, quantity: e.target.value }))} className="w-full px-3 py-2 border rounded" required />
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-1">Unit Purchase Price (â‚¹) *</label>
                    <input type="number" step="0.01" min="0" value={form.purchase_price} onChange={e => setForm(prev => ({ ...prev, purchase_price: e.target.value }))} className="w-full px-3 py-2 border rounded" required />
                  </div>

                  <div className="col-span-2">
                    <label className="block text-sm font-medium mb-1">Rack ID</label>
                    <input type="text" value={form.rack_id} onChange={e => setForm(prev => ({ ...prev, rack_id: e.target.value }))} className="w-full px-3 py-2 border rounded" placeholder="e.g., A-1, B-2" />
                  </div>

                  {/* Show calculated totals if editing or if values entered */}
                  {(form.sell_price && form.quantity && form.purchase_price) && (
                    <div className="col-span-2 bg-gray-50 p-4 rounded-lg">
                      <div className="text-sm font-medium text-gray-700 mb-2">Calculated Values:</div>
                      <div className="grid grid-cols-2 gap-3 text-sm">
                        <div>
                          <span className="text-gray-600">Total Purchase Price:</span>
                          <span className="ml-2 font-medium text-orange-600">â‚¹{(parseFloat(form.purchase_price || 0) * parseInt(form.quantity || 0)).toFixed(2)}</span>
                        </div>
                        <div>
                          <span className="text-gray-600">Expected Total Sell Price:</span>
                          <span className="ml-2 font-medium text-green-600">â‚¹{(parseFloat(form.sell_price || 0) * parseInt(form.quantity || 0)).toFixed(2)}</span>
                        </div>
                        <div className="col-span-2">
                          <span className="text-gray-600">Potential Profit:</span>
                          <span className="ml-2 font-medium text-blue-600">â‚¹{((parseFloat(form.sell_price || 0) * parseInt(form.quantity || 0)) - (parseFloat(form.purchase_price || 0) * parseInt(form.quantity || 0))).toFixed(2)}</span>
                        </div>
                      </div>
                    </div>
                  )}

                  <div className="col-span-2">
                    <label className="block text-sm font-medium mb-1">Additional Info</label>
                    <textarea value={form.additional_info} onChange={e => setForm(prev => ({ ...prev, additional_info: e.target.value }))} rows="3" className="w-full px-3 py-2 border rounded"></textarea>
                  </div>
                </div>

                <div className="flex justify-end gap-3 mt-4">
                  <button type="button" onClick={() => { setShowForm(false); setEditing(null); }} className="px-4 py-2 border rounded hover:bg-gray-50" disabled={submitting}>Cancel</button>
                  <ButtonLoader loading={submitting} type="submit" className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">{editing ? 'Update' : 'Create'}</ButtonLoader>
                </div>
              </form>
            </Modal>
          )}

          {/* View modal */}
          {showView && viewProduct && (
            <Modal onClose={() => { setShowView(false); setViewProduct(null); }} wide={false}>
              <h2 className="text-2xl font-bold mb-4">Product Details</h2>
              <div className="grid grid-cols-2 gap-4">
                <div className="col-span-2"><div className="text-sm text-gray-500">Product Name</div><div className="font-medium text-lg">{viewProduct.name}</div></div>
                
                <div className="col-span-2 bg-blue-50 p-3 rounded">
                  <div className="text-sm font-medium text-blue-800 mb-2">Pricing Information</div>
                  <div className="grid grid-cols-2 gap-3">
                    <div><div className="text-xs text-gray-600">Unit Sell Price</div><div className="font-medium">â‚¹{parseFloat(viewProduct.sell_price).toFixed(2)}</div></div>
                    <div><div className="text-xs text-gray-600">Quantity</div><div className="font-medium">{viewProduct.quantity}</div></div>
                    <div><div className="text-xs text-gray-600">Unit Purchase Price</div><div className="font-medium">â‚¹{parseFloat(viewProduct.purchase_price).toFixed(2)}</div></div>
                  </div>
                </div>

                <div className="col-span-2 bg-green-50 p-3 rounded">
                  <div className="text-sm font-medium text-green-800 mb-2">Total Values</div>
                  <div className="grid grid-cols-2 gap-3">
                    <div><div className="text-xs text-gray-600">Total Purchase Price</div><div className="font-medium text-orange-600">â‚¹{calculateTotals(viewProduct).totalPurchasePrice.toFixed(2)}</div></div>
                    <div><div className="text-xs text-gray-600">Expected Total Sell Price</div><div className="font-medium text-green-600">â‚¹{calculateTotals(viewProduct).expectedTotalSellPrice.toFixed(2)}</div></div>
                    <div className="col-span-2"><div className="text-xs text-gray-600">Potential Profit (Before Discount)</div><div className="font-medium text-blue-600">â‚¹{calculateTotals(viewProduct).potentialProfit.toFixed(2)}</div></div>
                  </div>
                </div>

                <div><div className="text-sm text-gray-500">Rack ID</div><div className="font-medium">{viewProduct.rack_id || '-'}</div></div>
                <div className="col-span-2"><div className="text-sm text-gray-500">Additional Info</div><div className="font-medium">{viewProduct.additional_info || '-'}</div></div>
                
                <div className="col-span-2 mt-2 p-3 bg-yellow-50 rounded">
                  <div className="text-xs text-yellow-800">
                    <strong>Note:</strong> Customer discounts can be applied during sales transactions. The expected total sell price shown is before any discounts.
                  </div>
                </div>
              </div>
            </Modal>
          )}

          {/* Delete Confirmation Modal */}
          {showDeleteConfirm && (
            <ConfirmModal
              title="Delete Product"
              message="Are you sure you want to delete this product? This action cannot be undone."
              onConfirm={confirmDelete}
              onCancel={cancelDelete}
              loading={deleting}
            />
          )}
        </div>
      );
    }


    function Sales() {
      const [mode, setMode] = useState(''); // 'jobcard' or 'direct'
      const [loading, setLoading] = useState(false);

      // Job Card mode states
      const [jobCards, setJobCards] = useState([]);
      const [searchTerm, setSearchTerm] = useState('');
      const [selectedJobCard, setSelectedJobCard] = useState(null);
      const [jobCardDetails, setJobCardDetails] = useState(null);

      // Direct Sell mode states
      const [customers, setCustomers] = useState([]);
      const [customerSearch, setCustomerSearch] = useState('');
      const [selectedCustomer, setSelectedCustomer] = useState(null);
      const [showNewCustomerForm, setShowNewCustomerForm] = useState(false);
      const [newCustomer, setNewCustomer] = useState({ name: '', email: '', phone: '', address: '' });

      // Common states for both modes
      const [products, setProducts] = useState([]);
      const [productSearch, setProductSearch] = useState('');
      const [selectedItems, setSelectedItems] = useState([]);
      const [showProductSearch, setShowProductSearch] = useState(false);
      const [discount, setDiscount] = useState(0);
      const [paymentMethod, setPaymentMethod] = useState('cash');
      const [showBillModal, setShowBillModal] = useState(false);
      const [billGenerated, setBillGenerated] = useState(false);

      // Fetch open job cards for Job Card mode
      const fetchJobCards = async () => {
        setLoading(true);
        try {
          const data = await apiCall('/job-cards?status=open');
          setJobCards(data);
        } catch (error) {
          console.error('Error fetching job cards:', error);
        }
        setLoading(false);
      };

      // Fetch customers for Direct Sell mode
      const fetchCustomers = async () => {
        setLoading(true);
        try {
          const data = await apiCall('/customers');
          setCustomers(data);
        } catch (error) {
          console.error('Error fetching customers:', error);
        }
        setLoading(false);
      };

      // Fetch products for stock selection
      const fetchProducts = async () => {
        try {
          const data = await apiCall('/products');
          setProducts(data);
        } catch (error) {
          console.error('Error fetching products:', error);
        }
      };

      // Load job card details when selected
      const loadJobCardDetails = async (jobCardId) => {
        setLoading(true);
        try {
          const data = await apiCall(`/job-cards/${jobCardId}`);
          setJobCardDetails(data);
          setSelectedJobCard(data);
        } catch (error) {
          console.error('Error fetching job card details:', error);
        }
        setLoading(false);
      };

      // Filter job cards by search term
      const filteredJobCards = jobCards.filter(jc =>
        jc.vehicle_number?.toLowerCase().includes(searchTerm.toLowerCase()) ||
        jc.customer_name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
        jc.customer_phone?.includes(searchTerm) ||
        jc.customer_email?.toLowerCase().includes(searchTerm.toLowerCase())
      );

      // Filter customers by search term
      const filteredCustomers = customers.filter(c =>
        c.name?.toLowerCase().includes(customerSearch.toLowerCase()) ||
        c.phone?.includes(customerSearch) ||
        c.email?.toLowerCase().includes(customerSearch.toLowerCase())
      );

      // Filter products by search term
      const filteredProducts = products.filter(p =>
        p.name?.toLowerCase().includes(productSearch.toLowerCase())
      );

      // Calculate available quantity for a product
      const getAvailableQuantity = (productId) => {
        const product = products.find(p => p.id === productId);
        return product?.quantity || 0;
      };

      // Add item to cart
      const addItem = (product) => {
        const existing = selectedItems.find(item => item.product_id === product.id);
        if (existing) {
          setSelectedItems(selectedItems.map(item =>
            item.product_id === product.id
              ? { ...item, quantity: item.quantity + 1 }
              : item
          ));
        } else {
          // Ensure unit_price is a valid number, default to 0 if not
          const unitPrice = parseFloat(product.sell_price) || 0;

          // Warn if product has no price set
          if (unitPrice === 0) {
            alert(`Warning: "${product.name}" has no selling price set (â‚¹0.00). You can edit the price in the cart.`);
          }

          setSelectedItems([...selectedItems, {
            product_id: product.id,
            product_name: product.name,
            unit_price: unitPrice,
            quantity: 1
          }]);
        }
        setShowProductSearch(false);
        setProductSearch('');
      };

      // Update item quantity
      const updateQuantity = (productId, quantity) => {
        if (quantity <= 0) {
          setSelectedItems(selectedItems.filter(item => item.product_id !== productId));
        } else {
          const available = getAvailableQuantity(productId);
          if (quantity > available) {
            alert(`Only ${available} units available in stock`);
            return;
          }
          setSelectedItems(selectedItems.map(item =>
            item.product_id === productId
              ? { ...item, quantity: parseInt(quantity) }
              : item
          ));
        }
      };

      // Update item price
      const updatePrice = (productId, price) => {
        // Ensure price is a valid number
        const validPrice = parseFloat(price) || 0;
        setSelectedItems(selectedItems.map(item =>
          item.product_id === productId
            ? { ...item, unit_price: validPrice }
            : item
        ));
      };

      // Remove item from cart
      const removeItem = (productId) => {
        setSelectedItems(selectedItems.filter(item => item.product_id !== productId));
      };

      // Calculate totals
      const calculateTotals = () => {
        const subtotal = selectedItems.reduce((sum, item) => sum + (item.quantity * item.unit_price), 0);
        const discountAmount = discount || 0;
        const total = subtotal - discountAmount;
        return { subtotal, discountAmount, total };
      };

      // Create new customer for Direct Sell
      const createNewCustomer = async () => {
        if (!newCustomer.name || !newCustomer.phone) {
          alert('Name and phone are required');
          return;
        }
        setLoading(true);
        try {
          const created = await apiCall('/customers', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(newCustomer)
          });
          setSelectedCustomer(created);
          setShowNewCustomerForm(false);
          setNewCustomer({ name: '', email: '', phone: '', address: '' });
        } catch (error) {
          console.error('Error creating customer:', error);
          alert('Failed to create customer');
        }
        setLoading(false);
      };

      // Generate bill and complete sale
      const generateBill = async () => {
        if (selectedItems.length === 0) {
          alert('Please add at least one item');
          return;
        }

        const customerId = mode === 'jobcard' ? selectedJobCard?.customer_id : selectedCustomer?.id;
        if (!customerId) {
          alert('Please select a customer');
          return;
        }

        const { total } = calculateTotals();

        setLoading(true);
        try {
          if (mode === 'jobcard' && selectedJobCard) {
            // For job card mode: Add stock items to job card first, then complete it
            // This prevents duplicate bills
            for (const item of selectedItems) {
              await apiCall(`/job-cards/${selectedJobCard.id}/stock-items`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  product_id: item.product_id,
                  quantity: item.quantity,
                  unit_price: item.unit_price,
                  notes: null
                })
              });
            }

            // Now complete the job card (this will auto-generate ONE bill)
            await apiCall(`/job-cards/${selectedJobCard.id}/complete`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                labour_charge: 0,
                discount: discount || 0
              })
            });
          } else {
            // For direct sell mode: Create a sale (this will auto-generate ONE bill)
            const saleData = {
              customer_id: customerId,
              items: selectedItems,
              discount: discount || 0,
              tax: 0,
              payment_method: paymentMethod
            };

            await apiCall('/sales', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(saleData)
            });
          }

          setBillGenerated(true);
          setShowBillModal(true);
        } catch (error) {
          console.error('Error generating bill:', error);
          alert('Failed to generate bill: ' + (error.message || 'Unknown error'));
        }
        setLoading(false);
      };

      // Reset form
      const resetForm = () => {
        setMode('');
        setSelectedJobCard(null);
        setJobCardDetails(null);
        setSelectedCustomer(null);
        setSelectedItems([]);
        setDiscount(0);
        setPaymentMethod('cash');
        setBillGenerated(false);
        setShowBillModal(false);
        setSearchTerm('');
        setCustomerSearch('');
      };

      React.useEffect(() => {
        if (mode === 'jobcard') {
          fetchJobCards();
        } else if (mode === 'direct') {
          fetchCustomers();
        }
        fetchProducts();
      }, [mode]);

      // Mode Selection Screen
      if (!mode) {
        return (
          <div>
            <h1 className="text-3xl font-bold mb-6">Sales & Billing</h1>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <button
                onClick={() => setMode('jobcard')}
                className="bg-white rounded-lg p-8 shadow hover:shadow-lg transition-shadow border-2 border-transparent hover:border-blue-500"
              >
                <div className="text-6xl mb-4">ðŸ”§</div>
                <h2 className="text-2xl font-bold mb-2">Sell by Job Card</h2>
                <p className="text-gray-600">
                  Select from open job cards and complete the sale with stock items
                </p>
              </button>
              <button
                onClick={() => setMode('direct')}
                className="bg-white rounded-lg p-8 shadow hover:shadow-lg transition-shadow border-2 border-transparent hover:border-green-500"
              >
                <div className="text-6xl mb-4">ðŸ’°</div>
                <h2 className="text-2xl font-bold mb-2">Direct Sell</h2>
                <p className="text-gray-600">
                  Sell directly to any customer (registered or walk-in)
                </p>
              </button>
            </div>
          </div>
        );
      }

      // Common Bill Modal
      const BillModal = () => {
        const { subtotal, discountAmount, total } = calculateTotals();
        const customer = mode === 'jobcard' ? selectedJobCard : selectedCustomer;

        return (
          <Modal onClose={() => { setShowBillModal(false); if (billGenerated) resetForm(); }}>
            <div className="bg-white rounded-lg p-6 max-w-2xl w-full max-h-[90vh] overflow-auto">
              <h2 className="text-2xl font-bold mb-4 text-center">
                {billGenerated ? 'Bill Generated Successfully' : 'Bill Preview'}
              </h2>

              <div className="border-b pb-4 mb-4">
                <h3 className="font-bold text-lg mb-2">Customer Details</h3>
                <p><strong>Name:</strong> {customer?.name || customer?.customer_name}</p>
                <p><strong>Phone:</strong> {customer?.phone || customer?.customer_phone}</p>
                {mode === 'jobcard' && (
                  <p><strong>Vehicle:</strong> {customer?.vehicle_number}</p>
                )}
              </div>

              <div className="mb-4">
                <h3 className="font-bold text-lg mb-2">Items</h3>
                <table className="w-full">
                  <thead className="bg-gray-100">
                    <tr>
                      <th className="p-2 text-left">Product</th>
                      <th className="p-2 text-right">Qty</th>
                      <th className="p-2 text-right">Price</th>
                      <th className="p-2 text-right">Total</th>
                    </tr>
                  </thead>
                  <tbody>
                    {selectedItems.map(item => (
                      <tr key={item.product_id} className="border-b">
                        <td className="p-2">{item.product_name}</td>
                        <td className="p-2 text-right">{item.quantity}</td>
                        <td className="p-2 text-right">â‚¹{item.unit_price.toFixed(2)}</td>
                        <td className="p-2 text-right">â‚¹{(item.quantity * item.unit_price).toFixed(2)}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>

              <div className="border-t pt-4">
                <div className="flex justify-between mb-2">
                  <span>Subtotal:</span>
                  <span>â‚¹{subtotal.toFixed(2)}</span>
                </div>
                {discountAmount > 0 && (
                  <div className="flex justify-between mb-2 text-green-600">
                    <span>Discount:</span>
                    <span>- â‚¹{discountAmount.toFixed(2)}</span>
                  </div>
                )}
                <div className="flex justify-between font-bold text-xl border-t pt-2">
                  <span>Total:</span>
                  <span>â‚¹{total.toFixed(2)}</span>
                </div>
                <div className="flex justify-between mt-2">
                  <span>Payment Method:</span>
                  <span className="capitalize">{paymentMethod}</span>
                </div>
              </div>

              <div className="mt-6 flex gap-3">
                {!billGenerated ? (
                  <>
                    <button
                      onClick={() => setShowBillModal(false)}
                      className="flex-1 px-4 py-2 bg-gray-300 rounded hover:bg-gray-400"
                    >
                      Cancel
                    </button>
                    <button
                      onClick={generateBill}
                      disabled={loading}
                      className="flex-1 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 disabled:bg-gray-400"
                    >
                      {loading ? 'Processing...' : 'Confirm & Generate Bill'}
                    </button>
                  </>
                ) : (
                  <button
                    onClick={() => { setShowBillModal(false); resetForm(); }}
                    className="flex-1 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                  >
                    Done
                  </button>
                )}
              </div>
            </div>
          </Modal>
        );
      };

      // Job Card Selection Screen
      if (mode === 'jobcard' && !selectedJobCard) {
        return (
          <div>
            <div className="flex justify-between items-center mb-6">
              <h1 className="text-3xl font-bold">Sell by Job Card</h1>
              <button
                onClick={resetForm}
                className="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400"
              >
                Back
              </button>
            </div>

            <div className="bg-white rounded-lg p-6 shadow mb-6">
              <input
                type="text"
                placeholder="Search by vehicle number, customer name, phone, or email..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                className="w-full p-3 border rounded"
              />
            </div>

            {loading ? (
              <div className="text-center py-8"><Spinner /></div>
            ) : (
              <div className="grid grid-cols-1 gap-4">
                {filteredJobCards.length === 0 ? (
                  <div className="bg-white rounded-lg p-6 shadow text-center text-gray-500">
                    No open job cards found
                  </div>
                ) : (
                  filteredJobCards.map(jc => (
                    <div
                      key={jc.id}
                      className="bg-white rounded-lg p-6 shadow hover:shadow-lg transition-shadow cursor-pointer"
                      onClick={() => loadJobCardDetails(jc.id)}
                    >
                      <div className="flex justify-between items-start">
                        <div>
                          <h3 className="font-bold text-lg">{jc.job_number}</h3>
                          <p className="text-gray-600">Customer: {jc.customer_name}</p>
                          <p className="text-gray-600">Vehicle: {jc.vehicle_number}</p>
                          <p className="text-gray-600">Phone: {jc.customer_phone}</p>
                        </div>
                        <div className="text-right">
                          <span className="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">
                            {jc.status}
                          </span>
                          <p className="text-sm text-gray-500 mt-2">
                            {new Date(jc.created_at).toLocaleDateString()}
                          </p>
                        </div>
                      </div>
                    </div>
                  ))
                )}
              </div>
            )}
          </div>
        );
      }

      // Direct Sell - Customer Selection Screen
      if (mode === 'direct' && !selectedCustomer) {
        return (
          <div>
            <div className="flex justify-between items-center mb-6">
              <h1 className="text-3xl font-bold">Direct Sell - Select Customer</h1>
              <button
                onClick={resetForm}
                className="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400"
              >
                Back
              </button>
            </div>

            {!showNewCustomerForm ? (
              <>
                <div className="bg-white rounded-lg p-6 shadow mb-6">
                  <div className="flex gap-3">
                    <input
                      type="text"
                      placeholder="Search by customer name, phone, or email..."
                      value={customerSearch}
                      onChange={(e) => setCustomerSearch(e.target.value)}
                      className="flex-1 p-3 border rounded"
                    />
                    <button
                      onClick={() => setShowNewCustomerForm(true)}
                      className="px-6 py-3 bg-green-600 text-white rounded hover:bg-green-700"
                    >
                      New Customer
                    </button>
                  </div>
                </div>

                {loading ? (
                  <div className="text-center py-8"><Spinner /></div>
                ) : (
                  <div className="grid grid-cols-1 gap-4">
                    {filteredCustomers.map(customer => (
                      <div
                        key={customer.id}
                        className="bg-white rounded-lg p-6 shadow hover:shadow-lg transition-shadow cursor-pointer"
                        onClick={() => setSelectedCustomer(customer)}
                      >
                        <div className="flex justify-between items-start">
                          <div>
                            <h3 className="font-bold text-lg">{customer.name}</h3>
                            <p className="text-gray-600">Phone: {customer.phone}</p>
                            {customer.email && <p className="text-gray-600">Email: {customer.email}</p>}
                            {customer.vehicle_number && (
                              <p className="text-gray-600">Vehicle: {customer.vehicle_number}</p>
                            )}
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </>
            ) : (
              <div className="bg-white rounded-lg p-6 shadow">
                <h2 className="text-xl font-bold mb-4">Create New Customer</h2>
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium mb-1">Name *</label>
                    <input
                      type="text"
                      value={newCustomer.name}
                      onChange={(e) => setNewCustomer({...newCustomer, name: e.target.value})}
                      className="w-full p-2 border rounded"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-1">Phone *</label>
                    <input
                      type="tel"
                      value={newCustomer.phone}
                      onChange={(e) => setNewCustomer({...newCustomer, phone: e.target.value})}
                      className="w-full p-2 border rounded"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-1">Email</label>
                    <input
                      type="email"
                      value={newCustomer.email}
                      onChange={(e) => setNewCustomer({...newCustomer, email: e.target.value})}
                      className="w-full p-2 border rounded"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-1">Address</label>
                    <textarea
                      value={newCustomer.address}
                      onChange={(e) => setNewCustomer({...newCustomer, address: e.target.value})}
                      className="w-full p-2 border rounded"
                      rows="3"
                    />
                  </div>
                  <div className="flex gap-3">
                    <button
                      onClick={() => setShowNewCustomerForm(false)}
                      className="flex-1 px-4 py-2 bg-gray-300 rounded hover:bg-gray-400"
                    >
                      Cancel
                    </button>
                    <button
                      onClick={createNewCustomer}
                      disabled={loading}
                      className="flex-1 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:bg-gray-400"
                    >
                      {loading ? 'Creating...' : 'Create & Continue'}
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      }

      // Main Sales Screen (both modes after selection)
      const customer = mode === 'jobcard' ? selectedJobCard : selectedCustomer;
      const { subtotal, discountAmount, total } = calculateTotals();

      return (
        <div>
          <div className="flex justify-between items-center mb-6">
            <h1 className="text-3xl font-bold">
              {mode === 'jobcard' ? 'Job Card Sale' : 'Direct Sale'}
            </h1>
            <button
              onClick={resetForm}
              className="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400"
            >
              Cancel
            </button>
          </div>

          {/* Customer Info */}
          <div className="bg-white rounded-lg p-6 shadow mb-6">
            <h2 className="text-xl font-bold mb-3">Customer Information</h2>
            <div className="grid grid-cols-2 gap-4">
              <div>
                <p className="text-sm text-gray-600">Name</p>
                <p className="font-medium">{customer?.name || customer?.customer_name}</p>
              </div>
              <div>
                <p className="text-sm text-gray-600">Phone</p>
                <p className="font-medium">{customer?.phone || customer?.customer_phone}</p>
              </div>
              {mode === 'jobcard' && (
                <>
                  <div>
                    <p className="text-sm text-gray-600">Vehicle Number</p>
                    <p className="font-medium">{customer?.vehicle_number}</p>
                  </div>
                  <div>
                    <p className="text-sm text-gray-600">Job Card Number</p>
                    <p className="font-medium">{customer?.job_number}</p>
                  </div>
                </>
              )}
            </div>
          </div>

          {/* Stock Items */}
          <div className="bg-white rounded-lg p-6 shadow mb-6">
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-xl font-bold">Stock Items</h2>
              <button
                onClick={() => setShowProductSearch(true)}
                className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
              >
                + Add Item
              </button>
            </div>

            {selectedItems.length === 0 ? (
              <p className="text-gray-500 text-center py-8">No items added yet</p>
            ) : (
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead className="bg-gray-100">
                    <tr>
                      <th className="p-3 text-left">Product</th>
                      <th className="p-3 text-right">Quantity</th>
                      <th className="p-3 text-right">Unit Price</th>
                      <th className="p-3 text-right">Total</th>
                      <th className="p-3"></th>
                    </tr>
                  </thead>
                  <tbody>
                    {selectedItems.map(item => (
                      <tr key={item.product_id} className="border-b">
                        <td className="p-3">{item.product_name}</td>
                        <td className="p-3 text-right">
                          <input
                            type="number"
                            value={item.quantity}
                            onChange={(e) => updateQuantity(item.product_id, e.target.value)}
                            className="w-20 p-1 border rounded text-right"
                            min="1"
                          />
                        </td>
                        <td className="p-3 text-right">
                          <input
                            type="number"
                            value={item.unit_price}
                            onChange={(e) => updatePrice(item.product_id, e.target.value)}
                            className="w-24 p-1 border rounded text-right"
                            min="0"
                            step="0.01"
                          />
                        </td>
                        <td className="p-3 text-right">
                          â‚¹{(item.quantity * item.unit_price).toFixed(2)}
                        </td>
                        <td className="p-3 text-right">
                          <button
                            onClick={() => removeItem(item.product_id)}
                            className="text-red-600 hover:text-red-800"
                          >
                            Remove
                          </button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>

          {/* Billing Summary */}
          <div className="bg-white rounded-lg p-6 shadow mb-6">
            <h2 className="text-xl font-bold mb-4">Billing Summary</h2>
            <div className="space-y-3">
              <div className="flex justify-between">
                <span>Subtotal:</span>
                <span className="font-medium">â‚¹{subtotal.toFixed(2)}</span>
              </div>
              <div className="flex justify-between items-center">
                <span>Discount:</span>
                <input
                  type="number"
                  value={discount}
                  onChange={(e) => setDiscount(parseFloat(e.target.value) || 0)}
                  className="w-32 p-2 border rounded text-right"
                  min="0"
                  step="0.01"
                  placeholder="0.00"
                />
              </div>
              <div className="flex justify-between items-center">
                <span>Payment Method:</span>
                <select
                  value={paymentMethod}
                  onChange={(e) => setPaymentMethod(e.target.value)}
                  className="p-2 border rounded"
                >
                  <option value="cash">Cash</option>
                  <option value="card">Card</option>
                  <option value="upi">UPI</option>
                  <option value="cheque">Cheque</option>
                </select>
              </div>
              <div className="flex justify-between text-xl font-bold border-t pt-3">
                <span>Total:</span>
                <span>â‚¹{total.toFixed(2)}</span>
              </div>
            </div>
          </div>

          {/* Actions */}
          <div className="flex gap-3">
            <button
              onClick={resetForm}
              className="flex-1 px-6 py-3 bg-gray-300 rounded hover:bg-gray-400"
            >
              Cancel
            </button>
            <button
              onClick={() => setShowBillModal(true)}
              disabled={selectedItems.length === 0}
              className="flex-1 px-6 py-3 bg-green-600 text-white rounded hover:bg-green-700 disabled:bg-gray-400"
            >
              Generate Bill
            </button>
          </div>

          {/* Product Search Modal */}
          {showProductSearch && (
            <Modal onClose={() => { setShowProductSearch(false); setProductSearch(''); }}>
              <div className="bg-white rounded-lg p-6 max-w-2xl w-full max-h-[80vh] overflow-auto">
                <h2 className="text-2xl font-bold mb-4">Add Product</h2>
                <input
                  type="text"
                  placeholder="Search products..."
                  value={productSearch}
                  onChange={(e) => setProductSearch(e.target.value)}
                  className="w-full p-3 border rounded mb-4"
                  autoFocus
                />
                <div className="space-y-2">
                  {filteredProducts.length === 0 ? (
                    <p className="text-gray-500 text-center py-4">No products found</p>
                  ) : (
                    filteredProducts.map(product => {
                      const available = getAvailableQuantity(product.id);
                      return (
                        <div
                          key={product.id}
                          onClick={() => available > 0 && addItem(product)}
                          className={`p-4 border rounded ${
                            available > 0
                              ? 'cursor-pointer hover:bg-gray-50'
                              : 'opacity-50 cursor-not-allowed'
                          }`}
                        >
                          <div className="flex justify-between items-center">
                            <div>
                              <p className="font-medium">{product.name}</p>
                              <p className="text-sm text-gray-600">
                                Available: {available} units
                              </p>
                            </div>
                            <div className="text-right">
                              <p className="font-bold">â‚¹{product.sell_price}</p>
                              {available <= 0 && (
                                <span className="text-xs text-red-600">Out of stock</span>
                              )}
                            </div>
                          </div>
                        </div>
                      );
                    })
                  )}
                </div>
              </div>
            </Modal>
          )}

          {/* Bill Modal */}
          {showBillModal && <BillModal />}
        </div>
      );
    }

    function StockManagement() {
      const [products, setProducts] = useState([]);
      const [selectedProduct, setSelectedProduct] = useState(null);
      const [transactions, setTransactions] = useState([]);
      const [showAddProduct, setShowAddProduct] = useState(false);
      const [showAddPurchase, setShowAddPurchase] = useState(false);
      const [showAdjustment, setShowAdjustment] = useState(false);
      const [showUploadDoc, setShowUploadDoc] = useState(false);
      const [uploadTransaction, setUploadTransaction] = useState(null);
      const [searchTerm, setSearchTerm] = useState('');
      const [rackFilter, setRackFilter] = useState('');
      const [allRacks, setAllRacks] = useState([]);

      // Loading states
      const [loadingProducts, setLoadingProducts] = useState(false);
      const [loadingTransactions, setLoadingTransactions] = useState(false);
      const [submittingProduct, setSubmittingProduct] = useState(false);
      const [submittingPurchase, setSubmittingPurchase] = useState(false);
      const [submittingAdjustment, setSubmittingAdjustment] = useState(false);
      const [uploadingDocument, setUploadingDocument] = useState(false);

      // Modal state for alerts and confirmations
      const [modalMessage, setModalMessage] = useState('');
      const [modalType, setModalType] = useState('info'); // 'info', 'error', 'success', 'confirm'
      const [showModal, setShowModal] = useState(false);
      const [modalAction, setModalAction] = useState(null);
      const [deleteProductId, setDeleteProductId] = useState(null);

      const [productForm, setProductForm] = useState({
        name: '', sell_price: '', rack_id: '', additional_info: ''
      });

      const [purchaseForm, setPurchaseForm] = useState({
        quantity: '', unit_cost: '', new_sell_price: '', vendor: '', reference_no: '', notes: ''
      });

      const [adjustmentForm, setAdjustmentForm] = useState({
        type: 'ADJUSTMENT_OUT', quantity: '', reason: 'DEFECTED', notes: ''
      });

      const [uploadFile, setUploadFile] = useState(null);

      useEffect(() => { loadProducts(); }, []);

      const loadProducts = async () => {
        setLoadingProducts(true);
        try {
          const data = await apiCall('/products');
          setProducts(data);
          const racks = [...new Set(data.map(p => p.rack_id).filter(r => r))].sort();
          setAllRacks(racks);
        } catch (err) { console.error(err); }
        finally { setLoadingProducts(false); }
      };

      const loadTransactions = async (productId) => {
        setLoadingTransactions(true);
        try {
          const data = await apiCall(`/inventory-transactions/product/${productId}`);
          // Fetch documents for all transactions
          const docPromises = data.map(t =>
            apiCall(`/documents/INVENTORY_TRANSACTION/${t.id}`).then(docs => ({ id: t.id, docs: docs || [] })).catch(() => ({ id: t.id, docs: [] }))
          );
          const docsArr = await Promise.all(docPromises);
          const docsMap = Object.fromEntries(docsArr.map(d => [d.id, d.docs[0] || null]));
          // Merge document_path, document_id, and document_name into each transaction
          const merged = data.map(t => ({
            ...t,
            document_path: docsMap[t.id]?.file_path || null,
            document_id: docsMap[t.id]?.id || null,
            document_name: docsMap[t.id]?.file_name || null
          }));
          setTransactions(merged);
        } catch (err) { console.error(err); }
        finally { setLoadingTransactions(false); }
      };

      // Helper function to show modal messages
      const showMessage = (message, type = 'info', action = null) => {
        setModalMessage(message);
        setModalType(type);
        setModalAction(() => action);
        setShowModal(true);
      };

      const handleAddProduct = async (e) => {
        e.preventDefault();
        if (!productForm.name.trim()) { showMessage('Product name is required', 'error'); return; }
        if (!productForm.sell_price || parseFloat(productForm.sell_price) <= 0) { showMessage('Valid sell price is required', 'error'); return; }

        setSubmittingProduct(true);
        try {
          await apiCall('/products', {
            method: 'POST',
            body: JSON.stringify({
              name: productForm.name,
              sell_price: parseFloat(productForm.sell_price),
              rack_id: productForm.rack_id,
              additional_info: productForm.additional_info
            })
          });
          setShowAddProduct(false);
          setProductForm({ name: '', sell_price: '', rack_id: '', additional_info: '' });
          loadProducts();
        } catch (err) { showMessage(err.message, 'error'); }
        finally { setSubmittingProduct(false); }
      };

      const handleAddPurchase = async (e) => {
        e.preventDefault();
        if (!purchaseForm.quantity || parseInt(purchaseForm.quantity) <= 0) { showMessage('Valid quantity is required', 'error'); return; }
        if (!purchaseForm.unit_cost || parseFloat(purchaseForm.unit_cost) <= 0) { showMessage('Valid unit cost is required', 'error'); return; }

        setSubmittingPurchase(true);
        try {
          const requestData = {
            product_id: selectedProduct.id,
            transaction_type: 'PURCHASE',
            quantity: parseInt(purchaseForm.quantity),
            unit_cost: parseFloat(purchaseForm.unit_cost),
            vendor: purchaseForm.vendor,
            reference_no: purchaseForm.reference_no,
            notes: purchaseForm.notes
          };

          // If new sell price provided, update product sell price
          if (purchaseForm.new_sell_price && parseFloat(purchaseForm.new_sell_price) > 0) {
            await apiCall(`/products/${selectedProduct.id}`, {
              method: 'PUT',
              body: JSON.stringify({
                ...selectedProduct,
                sell_price: parseFloat(purchaseForm.new_sell_price)
              })
            });
          }

          const result = await apiCall('/inventory-transactions', {
            method: 'POST',
            body: JSON.stringify(requestData)
          });

          setShowAddPurchase(false);
          setPurchaseForm({ quantity: '', unit_cost: '', new_sell_price: '', vendor: '', reference_no: '', notes: '' });

          // Reload product to get updated values
          const updatedProduct = await apiCall(`/products/${selectedProduct.id}`);
          setSelectedProduct(updatedProduct);
          await loadTransactions(selectedProduct.id);
          loadProducts();
        } catch (err) { alert(err.message); }
        finally { setSubmittingPurchase(false); }
      };

      const handleAdjustment = async (e) => {
        e.preventDefault();
        if (!adjustmentForm.quantity || parseInt(adjustmentForm.quantity) <= 0) { showMessage('Valid quantity is required', 'error'); return; }

        setSubmittingAdjustment(true);
        try {
          await apiCall('/inventory-transactions', {
            method: 'POST',
            body: JSON.stringify({
              product_id: selectedProduct.id,
              transaction_type: adjustmentForm.type,
              quantity: parseInt(adjustmentForm.quantity),
              notes: `${adjustmentForm.reason}: ${adjustmentForm.notes}`
            })
          });
          setShowAdjustment(false);
          setAdjustmentForm({ type: 'ADJUSTMENT_OUT', quantity: '', reason: 'DEFECTED', notes: '' });

          const updatedProduct = await apiCall(`/products/${selectedProduct.id}`);
          setSelectedProduct(updatedProduct);
          await loadTransactions(selectedProduct.id);
          loadProducts();
        } catch (err) { alert(err.message); }
        finally { setSubmittingAdjustment(false); }
      };

      const handleFileUpload = async (e) => {
        e.preventDefault();
        if (!uploadFile) { showMessage('Please select a file', 'error'); return; }

        const formData = new FormData();
        formData.append('file', uploadFile);
        formData.append('document_type', 'TRANSACTION');
        formData.append('related_entity_type', 'INVENTORY_TRANSACTION');
        formData.append('related_entity_id', uploadTransaction.id);
        formData.append('notes', '');

        setUploadingDocument(true);
        try {
          const res = await fetch(`${API_URL}/documents/upload`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
            body: formData
          });

          if (!res.ok) throw new Error('Upload failed');

          showMessage('Document uploaded successfully!', 'success');
          setShowUploadDoc(false);
          setUploadFile(null);
          setUploadTransaction(null);
          await loadTransactions(selectedProduct.id);
        } catch (err) { showMessage(err.message, 'error'); }
        finally { setUploadingDocument(false); }
      };

      const handleDeleteDocument = async (transactionId) => {
        try {
          await apiCall(`/inventory-transactions/${transactionId}/document`, { method: 'DELETE' });
          showMessage('Document deleted successfully!', 'success');
          await loadTransactions(selectedProduct.id);
        } catch (err) { showMessage(err.message, 'error'); }
      };

      const handleDownloadDocument = async (documentId, fileName) => {
        try {
          const response = await fetch(`${API_URL}/documents/download/${documentId}`, {
            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
          });
          if (!response.ok) throw new Error(`Download failed: ${response.statusText}`);
          
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = fileName || 'document';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          window.URL.revokeObjectURL(url);
        } catch (err) { showMessage(`Download error: ${err.message}`, 'error'); }
      };

      const openProductDetails = async (product) => {
        setSelectedProduct(product);
        await loadTransactions(product.id);
      };

      const filteredProducts = products.filter(p => {
        const matchesSearch = !searchTerm || p.name.toLowerCase().includes(searchTerm.toLowerCase());
        const matchesRack = !rackFilter || p.rack_id === rackFilter;
        return matchesSearch && matchesRack;
      });

      if (selectedProduct) {
        const totalSell = selectedProduct.quantity * selectedProduct.sell_price;
        const totalCost = selectedProduct.quantity * selectedProduct.purchase_price;
        const margin = totalSell - totalCost;
        const marginPerUnit = selectedProduct.sell_price - selectedProduct.purchase_price;

        return (
          <div>
            <div className="flex justify-between items-center mb-6">
              <button onClick={() => setSelectedProduct(null)} className="text-blue-600 hover:text-blue-800 flex items-center gap-2">
                <span>â†</span> Back to Products
              </button>
              <div className="flex gap-2">
                <button onClick={() => setShowAddPurchase(true)} className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">+ Add Purchase</button>
                <button onClick={() => setShowAdjustment(true)} className="bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700">âš  Adjust Stock</button>
              </div>
            </div>

            <div className="bg-white rounded-lg shadow p-6 mb-6">
              <h1 className="text-2xl font-bold text-gray-800 mb-2">{selectedProduct.name}</h1>
              <p className="text-gray-600 mb-4">Rack: {selectedProduct.rack_id || 'N/A'}</p>

              <div className="grid grid-cols-4 gap-4 mb-4">
                <div className="bg-blue-50 p-4 rounded">
                  <div className="text-sm text-gray-600">Current Stock</div>
                  <div className="text-2xl font-bold text-blue-600">{selectedProduct.quantity} units</div>
                </div>
                <div className="bg-green-50 p-4 rounded">
                  <div className="text-sm text-gray-600">Unit Sell Price</div>
                  <div className="text-2xl font-bold text-green-600">â‚¹{selectedProduct.sell_price}</div>
                </div>
                <div className="bg-purple-50 p-4 rounded">
                  <div className="text-sm text-gray-600">Avg Unit Cost</div>
                  <div className="text-2xl font-bold text-purple-600">â‚¹{selectedProduct.purchase_price.toFixed(2)}</div>
                </div>
                <div className="bg-yellow-50 p-4 rounded">
                  <div className="text-sm text-gray-600">Unit Margin</div>
                  <div className="text-2xl font-bold text-yellow-600">â‚¹{marginPerUnit.toFixed(2)}</div>
                </div>
              </div>

              <div className="grid grid-cols-3 gap-4 pt-4 border-t">
                <div>
                  <div className="text-sm text-gray-600">Total Purchase Price</div>
                  <div className="text-xl font-bold text-gray-800">â‚¹{totalCost.toFixed(2)}</div>
                </div>
                <div>
                  <div className="text-sm text-gray-600">Expected Total Sell</div>
                  <div className="text-xl font-bold text-gray-800">â‚¹{totalSell.toFixed(2)}</div>
                </div>
                <div>
                  <div className="text-sm text-gray-600">Total Margin</div>
                  <div className="text-xl font-bold text-green-600">â‚¹{margin.toFixed(2)}</div>
                </div>
              </div>
            </div>

            <div className="bg-white rounded-lg shadow">
              <div className="p-6 border-b">
                <h2 className="text-xl font-bold">Transaction History</h2>
              </div>
              <SectionLoader loading={loadingTransactions} message="Loading transaction history...">
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead className="bg-gray-50">
                      <tr>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Quantity</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Unit Cost</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Vendor</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Reference</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Document</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Notes</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-200">
                    {transactions.length === 0 ? (
                      <tr>
                        <td colSpan="10" className="px-6 py-8 text-center text-gray-500">
                          No transactions yet. Add your first purchase!
                        </td>
                      </tr>
                    ) : (
                      transactions.map(t => (
                        <tr key={t.id} className="hover:bg-gray-50">
                          <td className="px-6 py-4 text-sm font-mono text-gray-600">#{t.id}</td>
                          <td className="px-6 py-4 text-sm">{new Date(t.transaction_date).toLocaleString()}</td>
                          <td className="px-6 py-4">
                            <span className={`px-2 py-1 text-xs rounded ${
                              t.transaction_type === 'PURCHASE' ? 'bg-green-100 text-green-800' :
                              t.transaction_type === 'SALE' ? 'bg-blue-100 text-blue-800' :
                              'bg-orange-100 text-orange-800'
                            }`}>
                              {t.transaction_type}
                            </span>
                          </td>
                          <td className="px-6 py-4 text-sm font-medium">{t.quantity}</td>
                          <td className="px-6 py-4 text-sm">{t.unit_cost ? `â‚¹${t.unit_cost}` : '-'}</td>
                          <td className="px-6 py-4 text-sm font-medium">{t.unit_cost ? `â‚¹${(t.quantity * t.unit_cost).toFixed(2)}` : '-'}</td>
                          <td className="px-6 py-4 text-sm">{t.vendor || '-'}</td>
                          <td className="px-6 py-4 text-sm">{t.reference_no || '-'}</td>
                          <td className="px-6 py-4 text-sm">
                            {t.document_path ? (
                              <div className="flex items-center gap-3">
                                <button onClick={() => handleDownloadDocument(t.document_id, t.document_name)} title="Download Document" className="text-blue-600 hover:text-blue-800 transition">
                                  <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fillRule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clipRule="evenodd" />
                                  </svg>
                                </button>
                                <button
                                  onClick={(e) => {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    if (confirm('Delete this document? This action cannot be undone.')) {
                                      handleDeleteDocument(t.id);
                                    }
                                  }}
                                  title="Delete Document"
                                  className="text-red-600 hover:text-red-800 transition">
                                  <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clipRule="evenodd" />
                                  </svg>
                                </button>
                              </div>
                            ) : (
                              <button onClick={() => { setUploadTransaction(t); setShowUploadDoc(true); }} title="Upload Document" className="text-green-600 hover:text-green-800 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                  <path d="M5.5 13a3.5 3.5 0 01-.369-6.98 4 4 0 117.753-1.3A4.5 4.5 0 1113.5 13H11V9.413l1.293 1.293a1 1 0 001.414-1.414l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13H5.5z" />
                                </svg>
                              </button>
                            )}
                          </td>
                          <td className="px-6 py-4 text-sm text-gray-600">{t.notes || '-'}</td>
                        </tr>
                      ))
                    )}
                    </tbody>
                  </table>
                </div>
              </SectionLoader>
            </div>

            {showAddPurchase && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-lg shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
                  <div className="p-6 border-b">
                    <h3 className="text-xl font-bold">Add Purchase</h3>
                    <p className="text-sm text-gray-600 mt-1">Add stock for {selectedProduct.name}</p>
                  </div>
                  <form onSubmit={handleAddPurchase} className="p-6">
                    <div className="space-y-4">
                      <div>
                        <label className="block text-sm font-medium mb-1">Quantity *</label>
                        <input type="number" value={purchaseForm.quantity} onChange={e => setPurchaseForm({...purchaseForm, quantity: e.target.value})} className="w-full px-3 py-2 border rounded" required />
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-1">Unit Cost (â‚¹) *</label>
                        <input type="number" step="0.01" value={purchaseForm.unit_cost} onChange={e => setPurchaseForm({...purchaseForm, unit_cost: e.target.value})} className="w-full px-3 py-2 border rounded" required />
                      </div>
                      <div className="bg-yellow-50 p-3 rounded">
                        <label className="block text-sm font-medium mb-1">New Sell Price (â‚¹) - Optional</label>
                        <input type="number" step="0.01" value={purchaseForm.new_sell_price} onChange={e => setPurchaseForm({...purchaseForm, new_sell_price: e.target.value})} className="w-full px-3 py-2 border rounded" placeholder={`Current: â‚¹${selectedProduct.sell_price}`} />
                        <p className="text-xs text-gray-600 mt-1">Leave empty to keep current price</p>
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-1">Vendor</label>
                        <input value={purchaseForm.vendor} onChange={e => setPurchaseForm({...purchaseForm, vendor: e.target.value})} className="w-full px-3 py-2 border rounded" />
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-1">Invoice/Reference No</label>
                        <input value={purchaseForm.reference_no} onChange={e => setPurchaseForm({...purchaseForm, reference_no: e.target.value})} className="w-full px-3 py-2 border rounded" />
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-1">Notes</label>
                        <textarea value={purchaseForm.notes} onChange={e => setPurchaseForm({...purchaseForm, notes: e.target.value})} className="w-full px-3 py-2 border rounded" rows="2"></textarea>
                      </div>
                      {purchaseForm.quantity && purchaseForm.unit_cost && (
                        <div className="bg-blue-50 p-3 rounded">
                          <div className="text-sm font-medium">Total Purchase: â‚¹{(parseInt(purchaseForm.quantity) * parseFloat(purchaseForm.unit_cost)).toFixed(2)}</div>
                          {purchaseForm.new_sell_price && (
                            <div className="text-sm text-green-600 mt-1">New margin per unit: â‚¹{(parseFloat(purchaseForm.new_sell_price) - parseFloat(purchaseForm.unit_cost)).toFixed(2)}</div>
                          )}
                        </div>
                      )}
                    </div>
                    <div className="flex gap-3 mt-6">
                      <button type="button" onClick={() => setShowAddPurchase(false)} className="flex-1 px-4 py-2 border rounded hover:bg-gray-50" disabled={submittingPurchase}>Cancel</button>
                      <ButtonLoader loading={submittingPurchase} type="submit" className="flex-1 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Add Purchase</ButtonLoader>
                    </div>
                  </form>
                </div>
              </div>
            )}

            {showAdjustment && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-lg shadow-xl max-w-md w-full">
                  <div className="p-6 border-b">
                    <h3 className="text-xl font-bold">Stock Adjustment</h3>
                  </div>
                  <form onSubmit={handleAdjustment} className="p-6">
                    <div className="space-y-4">
                      <div>
                        <label className="block text-sm font-medium mb-1">Adjustment Type *</label>
                        <select value={adjustmentForm.type} onChange={e => setAdjustmentForm({...adjustmentForm, type: e.target.value})} className="w-full px-3 py-2 border rounded">
                          <option value="ADJUSTMENT_OUT">Decrease Stock (OUT)</option>
                          <option value="ADJUSTMENT_IN">Increase Stock (IN)</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-1">Quantity *</label>
                        <input type="number" value={adjustmentForm.quantity} onChange={e => setAdjustmentForm({...adjustmentForm, quantity: e.target.value})} className="w-full px-3 py-2 border rounded" required />
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-1">Reason *</label>
                        <select value={adjustmentForm.reason} onChange={e => setAdjustmentForm({...adjustmentForm, reason: e.target.value})} className="w-full px-3 py-2 border rounded">
                          <option value="DEFECTED">Defected</option>
                          <option value="RETURNED">Returned by Customer</option>
                          <option value="DAMAGED">Damaged</option>
                          <option value="LOST">Lost/Stolen</option>
                          <option value="EXPIRED">Expired</option>
                          <option value="FOUND">Found (Extra Stock)</option>
                          <option value="OTHER">Other</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-1">Additional Notes</label>
                        <textarea value={adjustmentForm.notes} onChange={e => setAdjustmentForm({...adjustmentForm, notes: e.target.value})} className="w-full px-3 py-2 border rounded" rows="2" placeholder="Describe the reason..."></textarea>
                      </div>
                    </div>
                    <div className="flex gap-3 mt-6">
                      <button type="button" onClick={() => setShowAdjustment(false)} className="flex-1 px-4 py-2 border rounded hover:bg-gray-50" disabled={submittingAdjustment}>Cancel</button>
                      <ButtonLoader loading={submittingAdjustment} type="submit" className="flex-1 px-4 py-2 bg-orange-600 text-white rounded hover:bg-orange-700">Adjust Stock</ButtonLoader>
                    </div>
                  </form>
                </div>
              </div>
            )}

            {showUploadDoc && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-lg shadow-xl max-w-md w-full">
                  <div className="p-6 border-b">
                    <h3 className="text-xl font-bold">Upload Document</h3>
                    <p className="text-sm text-gray-600 mt-1">Transaction #{uploadTransaction?.id}</p>
                  </div>
                  <form onSubmit={handleFileUpload} className="p-6">
                    <div className="space-y-4">
                      <div>
                        <label className="block text-sm font-medium mb-1">Select Document *</label>
                        <input type="file" onChange={e => setUploadFile(e.target.files[0])} className="w-full px-3 py-2 border rounded" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" required />
                        <p className="text-xs text-gray-600 mt-1">Supported: PDF, JPG, PNG, DOC, DOCX</p>
                      </div>
                      {uploadFile && (
                        <div className="bg-blue-50 p-3 rounded text-sm">
                          <div className="font-medium">Selected: {uploadFile.name}</div>
                          <div className="text-gray-600">Size: {(uploadFile.size / 1024).toFixed(2)} KB</div>
                        </div>
                      )}
                    </div>
                    <div className="flex gap-3 mt-6">
                      <button type="button" onClick={() => { setShowUploadDoc(false); setUploadFile(null); setUploadTransaction(null); }} className="flex-1 px-4 py-2 border rounded hover:bg-gray-50" disabled={uploadingDocument}>Cancel</button>
                      <ButtonLoader loading={uploadingDocument} type="submit" className="flex-1 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Upload</ButtonLoader>
                    </div>
                  </form>
                </div>
              </div>
            )}
          </div>
        );
      }

      return (
        <div>
          <div className="flex justify-between items-center mb-6">
            <h1 className="text-3xl font-bold text-gray-800">Stock Management</h1>
            <button onClick={() => setShowAddProduct(true)} className="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">+ Add Product</button>
          </div>

          <div className="bg-white rounded-lg shadow p-4 mb-6">
            <div className="flex gap-4">
              <input
                type="text"
                placeholder="Search products..."
                value={searchTerm}
                onChange={e => setSearchTerm(e.target.value)}
                className="flex-1 px-4 py-2 border rounded-lg"
              />
              <select value={rackFilter} onChange={e => setRackFilter(e.target.value)} className="px-4 py-2 border rounded-lg">
                <option value="">All Racks</option>
                {allRacks.map(rack => <option key={rack} value={rack}>{rack}</option>)}
              </select>
              {(searchTerm || rackFilter) && (
                <button onClick={() => { setSearchTerm(''); setRackFilter(''); }} className="px-4 py-2 text-gray-600 hover:text-gray-800">
                  Clear
                </button>
              )}
            </div>
          </div>

          <div className="bg-white rounded-lg shadow overflow-hidden">
            <SectionLoader loading={loadingProducts} message="Loading products...">
              <table className="w-full">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Product Name</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Current Stock</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sell Price (â‚¹)</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Avg Cost (â‚¹)</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Rack</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-gray-200">
                  {filteredProducts.length === 0 ? (
                    <tr>
                      <td colSpan="6" className="px-6 py-12 text-center text-gray-500">
                        {products.length === 0 ? (
                          <div>
                            <p className="text-lg font-medium mb-2">No products yet</p>
                            <p className="text-sm">Click "Add Product" to get started</p>
                          </div>
                        ) : (
                          <div>No products match your search</div>
                        )}
                      </td>
                    </tr>
                  ) : (
                    filteredProducts.map(p => (
                      <tr key={p.id} className="hover:bg-gray-50 cursor-pointer" onClick={() => openProductDetails(p)}>
                        <td className="px-6 py-4 font-medium text-blue-600">{p.name}</td>
                        <td className="px-6 py-4">
                          <span className={`font-bold ${p.quantity === 0 ? 'text-red-600' : p.quantity < 10 ? 'text-orange-600' : 'text-green-600'}`}>
                            {p.quantity}
                          </span>
                        </td>
                        <td className="px-6 py-4">â‚¹{p.sell_price}</td>
                        <td className="px-6 py-4">â‚¹{p.purchase_price.toFixed(2)}</td>
                        <td className="px-6 py-4 text-gray-600">{p.rack_id || '-'}</td>
                        <td className="px-6 py-4">
                          <button onClick={(e) => { e.stopPropagation(); openProductDetails(p); }} className="text-blue-600 hover:text-blue-800">
                            View Details â†’
                          </button>
                        </td>
                      </tr>
                    ))
                  )}
                </tbody>
              </table>
            </SectionLoader>
          </div>

          <div className="mt-4 text-sm text-gray-600">
            Showing {filteredProducts.length} of {products.length} products
          </div>

          {showAddProduct && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-lg shadow-xl max-w-md w-full">
                <div className="p-6 border-b">
                  <h3 className="text-xl font-bold">Add New Product</h3>
                  <p className="text-sm text-gray-600 mt-1">Stock will be added through purchase transactions</p>
                </div>
                <form onSubmit={handleAddProduct} className="p-6">
                  <div className="space-y-4">
                    <div>
                      <label className="block text-sm font-medium mb-1">Product Name *</label>
                      <input value={productForm.name} onChange={e => setProductForm({...productForm, name: e.target.value})} className="w-full px-3 py-2 border rounded" required />
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1">Sell Price (â‚¹) *</label>
                      <input type="number" step="0.01" value={productForm.sell_price} onChange={e => setProductForm({...productForm, sell_price: e.target.value})} className="w-full px-3 py-2 border rounded" required />
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1">Rack ID</label>
                      <input value={productForm.rack_id} onChange={e => setProductForm({...productForm, rack_id: e.target.value})} className="w-full px-3 py-2 border rounded" placeholder="e.g., A-1, B-2" />
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1">Additional Info</label>
                      <textarea value={productForm.additional_info} onChange={e => setProductForm({...productForm, additional_info: e.target.value})} className="w-full px-3 py-2 border rounded" rows="2"></textarea>
                    </div>
                  </div>
                  <div className="flex gap-3 mt-6">
                    <button type="button" onClick={() => setShowAddProduct(false)} className="flex-1 px-4 py-2 border rounded hover:bg-gray-50" disabled={submittingProduct}>Cancel</button>
                    <ButtonLoader loading={submittingProduct} type="submit" className="flex-1 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Add Product</ButtonLoader>
                  </div>
                </form>
              </div>
            </div>
          )}

          {/* Modal Popup Component */}
          {showModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-lg shadow-xl max-w-md w-full">
                <div className={`p-6 border-b flex items-start gap-4 ${
                  modalType === 'error' ? 'border-red-300 bg-red-50' :
                  modalType === 'success' ? 'border-green-300 bg-green-50' :
                  modalType === 'confirm' ? 'border-blue-300 bg-blue-50' :
                  'border-blue-300 bg-blue-50'
                }`}>
                  <div className={`flex-shrink-0 h-6 w-6 rounded-full flex items-center justify-center text-white ${
                    modalType === 'error' ? 'bg-red-500' :
                    modalType === 'success' ? 'bg-green-500' :
                    modalType === 'confirm' ? 'bg-blue-500' :
                    'bg-blue-500'
                  }`}>
                    {modalType === 'error' && '!'}
                    {modalType === 'success' && 'âœ“'}
                    {(modalType === 'info' || modalType === 'confirm') && 'i'}
                  </div>
                  <div className="flex-1">
                    <p className="text-sm text-gray-700">{modalMessage}</p>
                  </div>
                </div>
                <div className="p-6 flex gap-3">
                  {modalType === 'confirm' ? (
                    <>
                      <button 
                        onClick={() => { setShowModal(false); }} 
                        className="flex-1 px-4 py-2 border rounded hover:bg-gray-50">
                        Cancel
                      </button>
                      <button
                        onClick={() => {
                          if (modalAction) {
                            const action = modalAction();
                            if (action) action();
                          }
                          setShowModal(false);
                        }}
                        className="flex-1 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                        Confirm
                      </button>
                    </>
                  ) : (
                    <button 
                      onClick={() => setShowModal(false)} 
                      className="w-full px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                      OK
                    </button>
                  )}
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // Comprehensive Job Card Modal Component
    function JobCardModal({ isOpen, onClose, mode = 'view', jobCardId = null, prefilledData = {} }) {
      const { showError, showSuccess } = React.useContext(MessageContext);
      const [loading, setLoading] = useState(false);
      const [saving, setSaving] = useState(false);

      // Form state - all 48+ fields
      const [formData, setFormData] = useState({
        job_number: '',
        vehicle_tag_no: '',
        in_date: new Date().toISOString().split('T')[0],
        in_time: new Date().toTimeString().split(' ')[0].substring(0, 5),
        exp_delivery_date: '',
        exp_delivery_time: '',
        out_date: '',
        out_time: '',
        priority_booked_vehicle: false,
        priority_customer_waiting: false,
        priority_repeat_job: false,
        customer_name: '',
        customer_address: '',
        customer_phone: '',
        customer_email: '',
        vehicle_model: '',
        vehicle_type: '',
        frame_no: '',
        engine_no: '',
        colour: '',
        registration_no: '',
        kms_run: '',
        service_type_paid: false,
        service_type_general: false,
        service_type_amc: false,
        service_type_accidental: false,
        service_type_complaint: false,
        fuel_level: 0,
        psf_done_yes: false,
        psf_done_no: false,
        remarks: '',
        estimated_cost: '',
        payment_cash: false,
        payment_card: false,
        payment_credit: false,
        payment_warranty: false,
        invoice_no: '',
        amount_rs: '',
        gate_pass_no: '',
        service_advisor_name: '',
        technician_name: '',
        additional_voice: '',
        final_service_remarks: '',
        test_ride_opening: '',
        test_ride_closing: '',
        customer_signature_date: ''
      });

      const isViewMode = mode === 'view';

      // Load job card data when modal opens
      useEffect(() => {
        if (isOpen && jobCardId) {
          loadJobCardData();
        } else if (isOpen && Object.keys(prefilledData).length > 0) {
          setFormData(prev => ({ ...prev, ...prefilledData }));
          if (!prefilledData.job_number) {
            setFormData(prev => ({ ...prev, job_number: 'AUTO' }));
          }
        } else if (isOpen && !jobCardId) {
          setFormData(prev => ({ ...prev, job_number: 'AUTO' }));
        }
      }, [isOpen, jobCardId, prefilledData]);

      const loadJobCardData = async () => {
        setLoading(true);
        try {
          const response = await fetch(`${API_URL}/job-cards/${jobCardId}`, {
            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
          });
          if (!response.ok) throw new Error('Failed to load job card');
          const data = await response.json();

          // Map backend field names to form data
          setFormData({
            job_number: data.job_number || '',
            vehicle_tag_no: data.vehicle_tag_no || '',
            in_date: data.in_date || '',
            in_time: data.in_time || '',
            exp_delivery_date: data.exp_delivery_date || '',
            exp_delivery_time: data.exp_delivery_time || '',
            out_date: data.out_date || '',
            out_time: data.out_time || '',
            priority_booked_vehicle: !!data.priority_booked_vehicle,
            priority_customer_waiting: !!data.priority_customer_waiting,
            priority_repeat_job: !!data.priority_repeat_job,
            customer_name: data.customer_name || '',
            customer_address: data.customer_address || '',
            customer_phone: data.customer_phone || '',
            customer_email: data.customer_email || '',
            vehicle_model: data.vehicle_model || '',
            vehicle_type: data.vehicle_type || '',
            frame_no: data.frame_no || '',
            engine_no: data.engine_no || '',
            colour: data.colour || '',
            registration_no: data.registration_no || data.vehicle_number || '',
            kms_run: data.kms_run || '',
            service_type_paid: !!data.service_type_paid,
            service_type_general: !!data.service_type_general,
            service_type_amc: !!data.service_type_amc,
            service_type_accidental: !!data.service_type_accidental,
            service_type_complaint: !!data.service_type_complaint,
            fuel_level: data.fuel_level || 0,
            psf_done_yes: !!data.psf_done_yes,
            psf_done_no: !!data.psf_done_no,
            remarks: data.remarks || '',
            estimated_cost: data.estimated_cost || '',
            payment_cash: !!data.payment_cash,
            payment_card: !!data.payment_card,
            payment_credit: !!data.payment_credit,
            payment_warranty: !!data.payment_warranty,
            invoice_no: data.invoice_no || '',
            amount_rs: data.amount_rs || '',
            gate_pass_no: data.gate_pass_no || '',
            service_advisor_name: data.service_advisor_name || '',
            technician_name: data.technician_name || '',
            additional_voice: data.additional_voice || '',
            final_service_remarks: data.final_service_remarks || '',
            test_ride_opening: data.test_ride_opening || '',
            test_ride_closing: data.test_ride_closing || '',
            customer_signature_date: data.customer_signature_date || ''
          });
        } catch (error) {
          console.error('Error loading job card:', error);
          showError('Failed to load job card: ' + error.message);
          onClose();
        } finally {
          setLoading(false);
        }
      };

      const handleSave = async () => {
        // Validation
        if (!formData.customer_name) {
          showError('Please enter customer name');
          return;
        }
        if (!formData.registration_no) {
          showError('Please enter vehicle registration number');
          return;
        }

        setSaving(true);
        try {
          const payload = {
            ...formData,
            priority_booked_vehicle: formData.priority_booked_vehicle ? 1 : 0,
            priority_customer_waiting: formData.priority_customer_waiting ? 1 : 0,
            priority_repeat_job: formData.priority_repeat_job ? 1 : 0,
            service_type_paid: formData.service_type_paid ? 1 : 0,
            service_type_general: formData.service_type_general ? 1 : 0,
            service_type_amc: formData.service_type_amc ? 1 : 0,
            service_type_accidental: formData.service_type_accidental ? 1 : 0,
            service_type_complaint: formData.service_type_complaint ? 1 : 0,
            psf_done_yes: formData.psf_done_yes ? 1 : 0,
            psf_done_no: formData.psf_done_no ? 1 : 0,
            payment_cash: formData.payment_cash ? 1 : 0,
            payment_card: formData.payment_card ? 1 : 0,
            payment_credit: formData.payment_credit ? 1 : 0,
            payment_warranty: formData.payment_warranty ? 1 : 0,
            kms_run: parseInt(formData.kms_run) || null,
            estimated_cost: parseFloat(formData.estimated_cost) || 0,
            amount_rs: parseFloat(formData.amount_rs) || 0
          };

          let response;
          if (jobCardId) {
            // Update existing job card
            response = await fetch(`${API_URL}/job-cards/${jobCardId}`, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
              },
              body: JSON.stringify(payload)
            });
          } else {
            // Create new job card - need to find/create customer first
            let customerId = prefilledData.customer_id || null;

            if (!customerId) {
              // Try to find existing customer
              const searchResponse = await fetch(`${API_URL}/customers?search=${encodeURIComponent(formData.customer_phone || formData.registration_no)}`, {
                headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
              });
              const customers = await searchResponse.json();

              if (customers && customers.length > 0) {
                customerId = customers[0].id;
              } else {
                // Create new customer
                const customerResponse = await fetch(`${API_URL}/customers`, {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                  },
                  body: JSON.stringify({
                    name: formData.customer_name,
                    phone: formData.customer_phone,
                    email: formData.customer_email || null,
                    address: formData.customer_address || null,
                    vehicle_number: formData.registration_no,
                    vehicle_type: formData.vehicle_type || null
                  })
                });
                const customerData = await customerResponse.json();
                if (!customerResponse.ok) {
                  throw new Error(customerData.error || 'Failed to create customer');
                }
                customerId = customerData.id;
              }
            }

            // Create job card
            response = await fetch(`${API_URL}/job-cards`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
              },
              body: JSON.stringify({
                customer_id: customerId,
                vehicle_number: formData.registration_no,
                ...payload
              })
            });
          }

          const data = await response.json();
          if (!response.ok) {
            throw new Error(data.error || 'Failed to save job card');
          }

          showSuccess('Job card saved successfully!');
          onClose();
          // Reload the page to show updated data
          window.location.hash = window.location.hash; // Trigger refresh
          window.location.reload();
        } catch (error) {
          console.error('Error saving job card:', error);
          showError('Failed to save job card: ' + error.message);
        } finally {
          setSaving(false);
        }
      };

      const handlePrint = () => {
        window.print();
      };

      const updateField = (field, value) => {
        setFormData(prev => ({ ...prev, [field]: value }));
      };

      const toggleFuelLevel = (level) => {
        if (!isViewMode) {
          setFormData(prev => ({ ...prev, fuel_level: level }));
        }
      };

      if (!isOpen) return null;

      return (
        <div className="fixed inset-0 z-50 overflow-y-auto bg-black bg-opacity-50">
          <div className="min-h-screen px-4 py-6">
            <div className="bg-white rounded-lg shadow-2xl max-w-6xl mx-auto relative">
              {/* Close button */}
              <button
                onClick={onClose}
                className="absolute top-4 right-4 text-gray-600 hover:text-gray-900 text-3xl font-bold z-10 no-print"
              >
                Ã—
              </button>

              {/* Action buttons */}
              {!loading && (
                <div className="border-b p-4 flex justify-center gap-3 no-print">
                  {!isViewMode && (
                    <button
                      onClick={handleSave}
                      disabled={saving}
                      className="px-6 py-2 bg-green-600 text-white rounded hover:bg-green-700 disabled:opacity-50"
                    >
                      {saving ? 'Saving...' : 'Save Job Card'}
                    </button>
                  )}
                  <button
                    onClick={handlePrint}
                    className="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                  >
                    Print Job Card
                  </button>
                  <button
                    onClick={onClose}
                    className="px-6 py-2 border rounded hover:bg-gray-100"
                  >
                    Close
                  </button>
                </div>
              )}

              {/* Job Card Form */}
              {loading ? (
                <div className="p-20 text-center">
                  <div className="text-xl">Loading job card...</div>
                </div>
              ) : (
                <div className="p-8" style={{ fontFamily: 'Arial, sans-serif' }}>
                  {/* Header Section */}
                  <div className="border-2 border-black p-4 mb-0">
                    <div className="flex justify-between items-start mb-2">
                      <div>
                        <h2 className="text-2xl font-bold mb-1">JYOTI AUTO PARTS</h2>
                        <p className="text-xs">Near Hata Road Petrol Pump</p>
                        <p className="text-xs">Se 200 Meter Aage, Purwa Chauraha, Deoria</p>
                        <p className="text-xs">GSTIN: 09ZPDP5217B1ZW</p>
                      </div>
                      <div className="text-right">
                        <div className="flex items-center justify-end mb-2">
                          <label className="font-bold text-xs mr-2">JOB CARD No.</label>
                          <input
                            type="text"
                            value={formData.job_number}
                            readOnly
                            className="w-24 border-b border-black px-1 py-0.5 font-bold text-base bg-gray-50"
                          />
                        </div>
                        <div className="flex items-center justify-end">
                          <label className="font-bold text-xs mr-2">Vehicle Tag No.</label>
                          <input
                            type="text"
                            value={formData.vehicle_tag_no}
                            onChange={(e) => updateField('vehicle_tag_no', e.target.value)}
                            readOnly={isViewMode}
                            className={`w-24 border-b border-black px-1 py-0.5 text-xs ${isViewMode ? 'bg-gray-50' : ''}`}
                          />
                        </div>
                      </div>
                    </div>

                    <div className="text-center bg-gray-200 py-2 my-2 font-bold">JOB CARD</div>

                    <div className="grid grid-cols-3 gap-2 mb-2 text-xs">
                      <div className="flex items-center">
                        <label className="font-bold mr-2 whitespace-nowrap">In Date/Time:</label>
                        <input type="date" value={formData.in_date} onChange={(e) => updateField('in_date', e.target.value)} readOnly={isViewMode} className={`flex-1 border-b border-black px-1 text-xs ${isViewMode ? 'bg-gray-50' : ''}`} />
                        <input type="time" value={formData.in_time} onChange={(e) => updateField('in_time', e.target.value)} readOnly={isViewMode} className={`w-20 border-b border-black px-1 ml-1 text-xs ${isViewMode ? 'bg-gray-50' : ''}`} />
                      </div>
                      <div className="flex items-center">
                        <label className="font-bold mr-2 whitespace-nowrap">Exp. Delivery:</label>
                        <input type="date" value={formData.exp_delivery_date} onChange={(e) => updateField('exp_delivery_date', e.target.value)} readOnly={isViewMode} className={`flex-1 border-b border-black px-1 text-xs ${isViewMode ? 'bg-gray-50' : ''}`} />
                        <input type="time" value={formData.exp_delivery_time} onChange={(e) => updateField('exp_delivery_time', e.target.value)} readOnly={isViewMode} className={`w-20 border-b border-black px-1 ml-1 text-xs ${isViewMode ? 'bg-gray-50' : ''}`} />
                      </div>
                      <div className="flex items-center">
                        <label className="font-bold mr-2 whitespace-nowrap">Out Date/Time:</label>
                        <input type="date" value={formData.out_date} onChange={(e) => updateField('out_date', e.target.value)} readOnly={isViewMode} className={`flex-1 border-b border-black px-1 text-xs ${isViewMode ? 'bg-gray-50' : ''}`} />
                        <input type="time" value={formData.out_time} onChange={(e) => updateField('out_time', e.target.value)} readOnly={isViewMode} className={`w-20 border-b border-black px-1 ml-1 text-xs ${isViewMode ? 'bg-gray-50' : ''}`} />
                      </div>
                    </div>

                    <div className="flex gap-4 items-center text-xs">
                      <strong>PRIORITY IDENTIFICATION:</strong>
                      <label className="flex items-center gap-1">
                        <input type="checkbox" checked={formData.priority_booked_vehicle} onChange={(e) => updateField('priority_booked_vehicle', e.target.checked)} disabled={isViewMode} className="w-4 h-4" />
                        <span>Booked Vehicle</span>
                      </label>
                      <label className="flex items-center gap-1">
                        <input type="checkbox" checked={formData.priority_customer_waiting} onChange={(e) => updateField('priority_customer_waiting', e.target.checked)} disabled={isViewMode} className="w-4 h-4" />
                        <span>Customer Waiting</span>
                      </label>
                      <label className="flex items-center gap-1">
                        <input type="checkbox" checked={formData.priority_repeat_job} onChange={(e) => updateField('priority_repeat_job', e.target.checked)} disabled={isViewMode} className="w-4 h-4" />
                        <span>Repeat Job</span>
                      </label>
                    </div>
                  </div>

                  {/* Customer & Vehicle Details */}
                  <div className="grid grid-cols-2 border-2 border-black border-t-0">
                    <div className="border-r-2 border-black p-2">
                      <div className="bg-gray-200 text-center font-bold text-xs py-1 -mx-2 mb-2">CUSTOMER DETAILS</div>
                      <div className="space-y-1 text-xs">
                        <div className="flex"><label className="font-bold w-24">Name:</label><input value={formData.customer_name} onChange={(e) => updateField('customer_name', e.target.value)} readOnly={isViewMode} className={`flex-1 border-b border-gray-400 px-1 ${isViewMode ? 'bg-gray-50' : ''}`} /></div>
                        <div className="flex"><label className="font-bold w-24">Address:</label><textarea value={formData.customer_address} onChange={(e) => updateField('customer_address', e.target.value)} readOnly={isViewMode} rows="2" className={`flex-1 border-b border-gray-400 px-1 ${isViewMode ? 'bg-gray-50' : ''}`} /></div>
                        <div className="flex"><label className="font-bold w-24">Phone No.:</label><input value={formData.customer_phone} onChange={(e) => updateField('customer_phone', e.target.value)} readOnly={isViewMode} className={`flex-1 border-b border-gray-400 px-1 ${isViewMode ? 'bg-gray-50' : ''}`} /></div>
                        <div className="flex"><label className="font-bold w-24">E-Mail:</label><input type="email" value={formData.customer_email} onChange={(e) => updateField('customer_email', e.target.value)} readOnly={isViewMode} className={`flex-1 border-b border-gray-400 px-1 ${isViewMode ? 'bg-gray-50' : ''}`} /></div>
                      </div>
                    </div>
                    <div className="p-2">
                      <div className="bg-gray-200 text-center font-bold text-xs py-1 -mx-2 mb-2">VEHICLE DETAILS</div>
                      <div className="space-y-1 text-xs">
                        <div className="flex"><label className="font-bold w-32">MODEL:</label><input value={formData.vehicle_model} onChange={(e) => updateField('vehicle_model', e.target.value)} readOnly={isViewMode} className={`flex-1 border-b border-gray-400 px-1 ${isViewMode ? 'bg-gray-50' : ''}`} /></div>
                        <div className="flex"><label className="font-bold w-32">TYPE:</label><input value={formData.vehicle_type} onChange={(e) => updateField('vehicle_type', e.target.value)} readOnly={isViewMode} className={`flex-1 border-b border-gray-400 px-1 ${isViewMode ? 'bg-gray-50' : ''}`} /></div>
                        <div className="flex"><label className="font-bold w-32">FRAME NO.:</label><input value={formData.frame_no} onChange={(e) => updateField('frame_no', e.target.value)} readOnly={isViewMode} className={`flex-1 border-b border-gray-400 px-1 ${isViewMode ? 'bg-gray-50' : ''}`} /></div>
                        <div className="flex"><label className="font-bold w-32">ENGINE NO.:</label><input value={formData.engine_no} onChange={(e) => updateField('engine_no', e.target.value)} readOnly={isViewMode} className={`flex-1 border-b border-gray-400 px-1 ${isViewMode ? 'bg-gray-50' : ''}`} /></div>
                        <div className="flex"><label className="font-bold w-32">COLOUR:</label><input value={formData.colour} onChange={(e) => updateField('colour', e.target.value)} readOnly={isViewMode} className={`flex-1 border-b border-gray-400 px-1 ${isViewMode ? 'bg-gray-50' : ''}`} /></div>
                        <div className="flex"><label className="font-bold w-32">REGISTRATION NO:</label><input value={formData.registration_no} onChange={(e) => updateField('registration_no', e.target.value)} readOnly={isViewMode} className={`flex-1 border-b border-gray-400 px-1 ${isViewMode ? 'bg-gray-50' : ''}`} /></div>
                        <div className="flex"><label className="font-bold w-32">KMS RUN:</label><input type="number" value={formData.kms_run} onChange={(e) => updateField('kms_run', e.target.value)} readOnly={isViewMode} className={`flex-1 border-b border-gray-400 px-1 ${isViewMode ? 'bg-gray-50' : ''}`} /></div>
                      </div>
                    </div>
                  </div>

                  {/* Service Type & Condition */}
                  <div className="grid grid-cols-12 border-2 border-black border-t-0">
                    <div className="col-span-3 border-r-2 border-black p-2">
                      <div className="bg-gray-200 text-center font-bold text-xs py-1 -mx-2 mb-2">TYPE OF SERVICE</div>
                      <div className="space-y-1 text-xs">
                        <label className="flex items-center gap-1"><input type="checkbox" checked={formData.service_type_paid} onChange={(e) => updateField('service_type_paid', e.target.checked)} disabled={isViewMode} className="w-3.5 h-3.5" /><span>Paid Service</span></label>
                        <label className="flex items-center gap-1"><input type="checkbox" checked={formData.service_type_general} onChange={(e) => updateField('service_type_general', e.target.checked)} disabled={isViewMode} className="w-3.5 h-3.5" /><span>General Repair</span></label>
                        <label className="flex items-center gap-1"><input type="checkbox" checked={formData.service_type_amc} onChange={(e) => updateField('service_type_amc', e.target.checked)} disabled={isViewMode} className="w-3.5 h-3.5" /><span>AMC</span></label>
                        <label className="flex items-center gap-1"><input type="checkbox" checked={formData.service_type_accidental} onChange={(e) => updateField('service_type_accidental', e.target.checked)} disabled={isViewMode} className="w-3.5 h-3.5" /><span>Accidental</span></label>
                        <label className="flex items-center gap-1"><input type="checkbox" checked={formData.service_type_complaint} onChange={(e) => updateField('service_type_complaint', e.target.checked)} disabled={isViewMode} className="w-3.5 h-3.5" /><span>Complaint</span></label>
                      </div>
                    </div>
                    <div className="col-span-5 border-r-2 border-black p-2">
                      <div className="bg-gray-200 text-center font-bold text-xs py-1 -mx-2 mb-2">PHYSICAL & PAINT CONDITION OF VEHICLE</div>
                      <div className="flex justify-center items-center min-h-28">
                        <div className="flex gap-2 text-3xl">
                          <div className="text-center"><div>ðŸ›µ</div><div className="text-xs mt-1">Left</div></div>
                          <div className="text-center"><div>ðŸ›µ</div><div className="text-xs mt-1">Right</div></div>
                          <div className="text-center"><div>ðŸï¸</div><div className="text-xs mt-1">Left</div></div>
                          <div className="text-center"><div>ðŸï¸</div><div className="text-xs mt-1">Right</div></div>
                        </div>
                      </div>
                    </div>
                    <div className="col-span-4 p-2">
                      <div className="bg-gray-200 text-center font-bold text-xs py-1 -mx-2 mb-2">Fuel Level</div>
                      <div className="flex items-center gap-1 mt-2 text-xs">
                        <span>E</span>
                        <div className="flex gap-0.5">
                          {[1, 2, 3, 4].map(level => (
                            <div
                              key={level}
                              onClick={() => toggleFuelLevel(level)}
                              className={`w-8 h-4 border border-black cursor-pointer ${formData.fuel_level >= level ? 'bg-black' : 'bg-white'} ${isViewMode ? 'cursor-default' : ''}`}
                            />
                          ))}
                        </div>
                        <span>F</span>
                      </div>
                      <div className="mt-2 text-xs">
                        <strong>PSF Done:</strong>
                        <div className="flex gap-3 mt-1">
                          <label className="flex items-center gap-1"><input type="checkbox" checked={formData.psf_done_yes} onChange={(e) => updateField('psf_done_yes', e.target.checked)} disabled={isViewMode} className="w-3.5 h-3.5" /><span>Yes</span></label>
                          <label className="flex items-center gap-1"><input type="checkbox" checked={formData.psf_done_no} onChange={(e) => updateField('psf_done_no', e.target.checked)} disabled={isViewMode} className="w-3.5 h-3.5" /><span>No</span></label>
                        </div>
                      </div>
                      <div className="mt-2">
                        <label className="text-xs font-bold block mb-1">Remarks:</label>
                        <textarea value={formData.remarks} onChange={(e) => updateField('remarks', e.target.value)} readOnly={isViewMode} className={`w-full h-9 border border-gray-400 text-xs p-1 ${isViewMode ? 'bg-gray-50' : ''}`} />
                      </div>
                    </div>
                  </div>

                  {/* Bottom Section */}
                  <div className="grid grid-cols-2 border-2 border-black border-t-0">
                    <div className="border-r-2 border-black p-2">
                      <div className="mb-2 text-xs">
                        <strong>Service Advisor Name:</strong>
                        <input value={formData.service_advisor_name} onChange={(e) => updateField('service_advisor_name', e.target.value)} readOnly={isViewMode} className={`w-full border-b border-gray-400 mt-1 px-1 ${isViewMode ? 'bg-gray-50' : ''}`} />
                      </div>
                      <div className="mb-2 text-xs">
                        <strong>Technician Name:</strong>
                        <input value={formData.technician_name} onChange={(e) => updateField('technician_name', e.target.value)} readOnly={isViewMode} className={`w-full border-b border-gray-400 mt-1 px-1 ${isViewMode ? 'bg-gray-50' : ''}`} />
                      </div>
                      <div className="text-xs p-2 border border-gray-400 min-h-16">
                        <p>I certify that the work has been done to my satisfaction and I have taken the delivery of my vehicle.</p>
                      </div>
                    </div>
                    <div className="p-2">
                      <div className="mb-2 text-xs">
                        <strong>Estimated Cost Rs.</strong>
                        <input type="number" value={formData.estimated_cost} onChange={(e) => updateField('estimated_cost', e.target.value)} readOnly={isViewMode} className={`w-full border-b border-gray-400 mt-1 px-1 ${isViewMode ? 'bg-gray-50' : ''}`} />
                      </div>
                      <div className="mb-2 text-xs">
                        <strong>Payment Details:</strong>
                        <div className="flex gap-3 mt-2">
                          <label className="flex items-center gap-1"><input type="checkbox" checked={formData.payment_cash} onChange={(e) => updateField('payment_cash', e.target.checked)} disabled={isViewMode} className="w-3.5 h-3.5" /><span>Cash</span></label>
                          <label className="flex items-center gap-1"><input type="checkbox" checked={formData.payment_card} onChange={(e) => updateField('payment_card', e.target.checked)} disabled={isViewMode} className="w-3.5 h-3.5" /><span>Card</span></label>
                          <label className="flex items-center gap-1"><input type="checkbox" checked={formData.payment_credit} onChange={(e) => updateField('payment_credit', e.target.checked)} disabled={isViewMode} className="w-3.5 h-3.5" /><span>Credit</span></label>
                          <label className="flex items-center gap-1"><input type="checkbox" checked={formData.payment_warranty} onChange={(e) => updateField('payment_warranty', e.target.checked)} disabled={isViewMode} className="w-3.5 h-3.5" /><span>Warranty</span></label>
                        </div>
                      </div>
                      <div className="space-y-1 text-xs mt-3">
                        <div className="flex"><label className="font-bold w-28">Invoice No.</label><input value={formData.invoice_no} onChange={(e) => updateField('invoice_no', e.target.value)} readOnly={isViewMode} className={`flex-1 border-b border-gray-400 px-1 ${isViewMode ? 'bg-gray-50' : ''}`} /></div>
                        <div className="flex"><label className="font-bold w-28">Amount Rs.</label><input type="number" value={formData.amount_rs} onChange={(e) => updateField('amount_rs', e.target.value)} readOnly={isViewMode} className={`flex-1 border-b border-gray-400 px-1 ${isViewMode ? 'bg-gray-50' : ''}`} /></div>
                        <div className="flex"><label className="font-bold w-28">Gate Pass No.</label><input value={formData.gate_pass_no} onChange={(e) => updateField('gate_pass_no', e.target.value)} readOnly={isViewMode} className={`flex-1 border-b border-gray-400 px-1 ${isViewMode ? 'bg-gray-50' : ''}`} /></div>
                      </div>
                    </div>
                  </div>

                  {/* Signature Section */}
                  <div className="grid grid-cols-2 border-2 border-black border-t-0 p-4">
                    <div className="text-center">
                      <div className="text-xs mb-1">
                        <strong>Date:</strong>
                        <input type="date" value={formData.customer_signature_date} onChange={(e) => updateField('customer_signature_date', e.target.value)} readOnly={isViewMode} className={`border-b border-gray-400 ml-2 ${isViewMode ? 'bg-gray-50' : ''}`} />
                      </div>
                      <div className="border-t border-black pt-1 mt-10 text-xs">Customer's Signature</div>
                    </div>
                    <div className="text-center">
                      <div className="border-t border-black pt-1 mt-14 text-xs">Cashier's Signature</div>
                    </div>
                  </div>

                  {/* Gate Pass */}
                  <div className="border-2 border-black mt-4 p-4">
                    <div className="flex justify-between items-start border-b border-dashed border-black pb-2 mb-2">
                      <div>
                        <h2 className="text-xl font-bold">JYOTI AUTO PARTS</h2>
                        <p className="text-xs">Near Hata Road Petrol Pump Se 200 Meter Aage, Purwa Chauraha, Deoria</p>
                      </div>
                      <div className="text-center">
                        <strong className="text-sm">Customer's Copy/Gate Pass</strong>
                      </div>
                      <div className="text-right">
                        <strong className="text-sm">JOB CARD No.</strong>
                        <span className="text-base ml-2">{formData.job_number}</span>
                      </div>
                    </div>
                    <div className="text-xs">
                      <p><strong>Workshop Timing:</strong> 09:30 am to 7:00 pm</p>
                      <p><strong>Lunch:</strong> 2:00 pm to 2:30 pm</p>
                      <p><strong>Weekly off:</strong> Saturday</p>
                    </div>
                    <div className="grid grid-cols-2 gap-4 mt-3 text-xs">
                      <div className="space-y-1">
                        <div className="flex"><label className="font-bold w-32">Date:</label><span className="flex-1 border-b border-gray-400">{formData.in_date}</span></div>
                        <div className="flex"><label className="font-bold w-32">Vehicle No:</label><span className="flex-1 border-b border-gray-400">{formData.registration_no}</span></div>
                      </div>
                      <div className="space-y-1">
                        <div className="flex"><label className="font-bold w-40">Estimated Delivery Time:</label><span className="flex-1 border-b border-gray-400">{formData.exp_delivery_date} {formData.exp_delivery_time}</span></div>
                        <div className="flex"><label className="font-bold w-40">Estimated Cost Rs.:</label><span className="flex-1 border-b border-gray-400">{formData.estimated_cost}</span></div>
                      </div>
                    </div>
                    <div className="grid grid-cols-2 gap-4 mt-3 text-xs">
                      <div className="flex"><label className="font-bold w-40">Service Advisor Name:</label><span className="flex-1 border-b border-gray-400">{formData.service_advisor_name}</span></div>
                      <div className="text-right border-t border-black pt-1">Customer Signature</div>
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>

          <style>{`
            @media print {
              .no-print {
                display: none !important;
              }
              body {
                background: white;
              }
              .fixed {
                position: relative;
              }
            }
          `}</style>
        </div>
      );
    }

    function JobCards() {
      const { showError, showSuccess } = React.useContext(MessageContext);
      const [jobCards, setJobCards] = useState([]);
      const [filteredJobCards, setFilteredJobCards] = useState([]);
      const [searchTerm, setSearchTerm] = useState('');
      const [statusFilter, setStatusFilter] = useState('');
      const [fromDate, setFromDate] = useState(() => new Date().toISOString().split('T')[0]);
      const [toDate, setToDate] = useState(() => new Date().toISOString().split('T')[0]);
      const [page, setPage] = useState(1);
      const pageSize = 10;
      const [showCreateModal, setShowCreateModal] = useState(false);
      const [showViewModal, setShowViewModal] = useState(false);
      const [showAddStockModal, setShowAddStockModal] = useState(false);
      const [showBillingModal, setShowBillingModal] = useState(false);
      const [showRejectModal, setShowRejectModal] = useState(false);
      const [currentJobCard, setCurrentJobCard] = useState(null);
      const [products, setProducts] = useState([]);

      // Comprehensive job card modal states
      const [showComprehensiveModal, setShowComprehensiveModal] = useState(false);
      const [comprehensiveModalMode, setComprehensiveModalMode] = useState('view');
      const [comprehensiveJobCardId, setComprehensiveJobCardId] = useState(null);

      // Task management states
      const [showAddTaskModal, setShowAddTaskModal] = useState(false);
      const [newTaskDescription, setNewTaskDescription] = useState('');
      const [editingTaskId, setEditingTaskId] = useState(null);
      const [editingTaskDescription, setEditingTaskDescription] = useState('');

      // Loading states
      const [loadingJobCards, setLoadingJobCards] = useState(false);
      const [loadingJobCard, setLoadingJobCard] = useState(false);
      const [creatingJobCard, setCreatingJobCard] = useState(false);
      const [addingStockItem, setAddingStockItem] = useState(false);
      const [completingJobCard, setCompletingJobCard] = useState(false);
      const [rejectingJobCard, setRejectingJobCard] = useState(false);
      const [addingTask, setAddingTask] = useState(false);
      const [updatingTask, setUpdatingTask] = useState(false);
      const [deletingTask, setDeletingTask] = useState(false);
      
      // Create job card form states
      const [customerSearch, setCustomerSearch] = useState('');
      const [customerResults, setCustomerResults] = useState([]);
      const [selectedCustomer, setSelectedCustomer] = useState(null);
      const [vehicleNumber, setVehicleNumber] = useState('');
      const [tasks, setTasks] = useState(['']);
      const [assignee, setAssignee] = useState('');
      const [notes, setNotes] = useState('');
      
      // Stock item form states
      const [stockProductId, setStockProductId] = useState('');
      const [stockQuantity, setStockQuantity] = useState(1);
      const [stockUnitPrice, setStockUnitPrice] = useState(0);
      const [stockNotes, setStockNotes] = useState('');
      
      // Billing form states
      const [labourCharge, setLabourCharge] = useState(0);
      const [lastServiceDate, setLastServiceDate] = useState('');
      const [nextServiceDate, setNextServiceDate] = useState('');
      
      // Reject form state
      const [rejectReason, setRejectReason] = useState('');

      useEffect(() => {
        loadJobCards();
        loadProducts();
      }, [fromDate, toDate]);

      useEffect(() => {
        filterJobCards();
      }, [jobCards, searchTerm, statusFilter]);

      const loadJobCards = async () => {
        setLoadingJobCards(true);
        try {
          const params = new URLSearchParams();
          if (fromDate) params.append('from_date', fromDate);
          if (toDate) params.append('to_date', toDate);

          const response = await fetch(`${API_URL}/job-cards?${params.toString()}`, {
            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
          });
          const data = await response.json();
          setJobCards(data);
          setPage(1); // Reset to first page when data changes
        } catch (error) {
          console.error('Error loading job cards:', error);
        }
        finally { setLoadingJobCards(false); }
      };

      const loadProducts = async () => {
        try {
          const response = await fetch(`${API_URL}/products`, {
            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
          });
          const data = await response.json();
          setProducts(data);
        } catch (error) {
          console.error('Error loading products:', error);
        }
      };

      const filterJobCards = () => {
        let filtered = [...jobCards];
        
        if (searchTerm) {
          filtered = filtered.filter(job => 
            job.job_number.toLowerCase().includes(searchTerm.toLowerCase()) ||
            job.vehicle_number.toLowerCase().includes(searchTerm.toLowerCase()) ||
            job.customer_name.toLowerCase().includes(searchTerm.toLowerCase())
          );
        }
        
        if (statusFilter) {
          filtered = filtered.filter(job => job.status === statusFilter);
        }
        
        setFilteredJobCards(filtered);
      };

      const searchCustomers = async (search) => {
        if (search.length < 2) {
          setCustomerResults([]);
          return;
        }
        
        try {
          const response = await fetch(`${API_URL}/job-cards/search-customer?search=${encodeURIComponent(search)}`, {
            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
          });
          const data = await response.json();
          setCustomerResults(data);
        } catch (error) {
          console.error('Error searching customers:', error);
        }
      };

      const handleCustomerSearch = (value) => {
        setCustomerSearch(value);
        searchCustomers(value);
      };

      const selectCustomer = (customer) => {
        setSelectedCustomer(customer);
        setCustomerSearch(customer.name);
        setVehicleNumber(customer.vehicle_number || '');
        setCustomerResults([]);
      };

      const createJobCard = async () => {
        if (!selectedCustomer) {
          showError('Please select a customer', 'Validation Error');
          return;
        }

        if (!vehicleNumber) {
          showError('Please enter vehicle number', 'Validation Error');
          return;
        }

        const validTasks = tasks.filter(t => t.trim().length > 0);
        if (validTasks.length === 0) {
          showError('Please add at least one task', 'Validation Error');
          return;
        }

        setCreatingJobCard(true);
        try {
          const response = await fetch(`${API_URL}/job-cards`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify({
              customer_id: selectedCustomer.id,
              vehicle_number: vehicleNumber,
              tasks: validTasks,
              assignee: assignee || null,
              notes: notes || null
            })
          });

          const data = await response.json();
          if (data.error) {
            showError(data.error);
          } else {
            closeCreateModal();
            loadJobCards();
            showSuccess('Job card created successfully');
          }
        } catch (error) {
          console.error('Error creating job card:', error);
          showError('Failed to create job card');
        }
        finally { setCreatingJobCard(false); }
      };

      const viewJobCard = async (id, jobStatus = null) => {
        // Open comprehensive job card modal
        // Edit mode for 'open' jobs, view mode for 'closed' jobs
        const mode = jobStatus === 'open' ? 'edit' : 'view';
        setComprehensiveJobCardId(id);
        setComprehensiveModalMode(mode);
        setShowComprehensiveModal(true);
      };

      const addStockItem = async () => {
        if (!stockProductId || !stockQuantity || !stockUnitPrice) {
          showError('Please fill all required fields', 'Validation Error');
          return;
        }

        setAddingStockItem(true);
        try {
          const response = await fetch(`${API_URL}/job-cards/${currentJobCard.id}/stock-items`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify({
              product_id: stockProductId,
              quantity: stockQuantity,
              unit_price: stockUnitPrice,
              notes: stockNotes || null
            })
          });

          const data = await response.json();
          if (data.error) {
            showError(data.error);
          } else {
            setShowAddStockModal(false);
            resetStockForm();
            viewJobCard(currentJobCard.id);
            showSuccess('Stock item added successfully');
          }
        } catch (error) {
          console.error('Error adding stock item:', error);
          showError('Failed to add stock item');
        }
        finally { setAddingStockItem(false); }
      };

      const completeJobCard = async () => {
        setCompletingJobCard(true);
        try {
          const response = await fetch(`${API_URL}/job-cards/${currentJobCard.id}/complete`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify({
              labour_charge: labourCharge,
              last_service_date: lastServiceDate || null,
              next_service_date: nextServiceDate || null
            })
          });

          const data = await response.json();
          if (data.error) {
            showError(data.error);
          } else {
            setShowBillingModal(false);
            setShowViewModal(false);
            loadJobCards();
            showSuccess('Job card completed and bill generated successfully');
          }
        } catch (error) {
          console.error('Error completing job card:', error);
          showError('Failed to complete job card');
        }
        finally { setCompletingJobCard(false); }
      };

      const rejectJobCard = async () => {
        if (!rejectReason.trim()) {
          showError('Please enter rejection reason', 'Validation Error');
          return;
        }

        setRejectingJobCard(true);
        try {
          const response = await fetch(`${API_URL}/job-cards/${currentJobCard.id}/reject`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify({ reason: rejectReason })
          });

          const data = await response.json();
          if (data.error) {
            showError(data.error);
          } else {
            setShowRejectModal(false);
            setShowViewModal(false);
            loadJobCards();
            showSuccess('Job card rejected successfully');
          }
        } catch (error) {
          console.error('Error rejecting job card:', error);
          showError('Failed to reject job card');
        }
        finally { setRejectingJobCard(false); }
      };

      const addTask = async () => {
        if (!newTaskDescription.trim()) {
          showError('Please enter task description', 'Validation Error');
          return;
        }

        setAddingTask(true);
        try {
          const response = await fetch(`${API_URL}/job-cards/${currentJobCard.id}/tasks`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify({ task_description: newTaskDescription.trim() })
          });

          const data = await response.json();
          if (data.error) {
            showError(data.error);
          } else {
            setShowAddTaskModal(false);
            setNewTaskDescription('');
            viewJobCard(currentJobCard.id);
            showSuccess('Task added successfully');
          }
        } catch (error) {
          console.error('Error adding task:', error);
          showError('Failed to add task');
        }
        finally { setAddingTask(false); }
      };

      const updateTask = async (taskId) => {
        if (!editingTaskDescription.trim()) {
          showError('Please enter task description', 'Validation Error');
          return;
        }

        setUpdatingTask(true);
        try {
          const response = await fetch(`${API_URL}/job-cards/${currentJobCard.id}/tasks/${taskId}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify({ task_description: editingTaskDescription.trim() })
          });

          const data = await response.json();
          if (data.error) {
            showError(data.error);
          } else {
            setEditingTaskId(null);
            setEditingTaskDescription('');
            viewJobCard(currentJobCard.id);
            showSuccess('Task updated successfully');
          }
        } catch (error) {
          console.error('Error updating task:', error);
          showError('Failed to update task');
        }
        finally { setUpdatingTask(false); }
      };

      const deleteTask = async (taskId) => {
        if (!confirm('Are you sure you want to delete this task?')) return;

        setDeletingTask(true);
        try {
          const response = await fetch(`${API_URL}/job-cards/${currentJobCard.id}/tasks/${taskId}`, {
            method: 'DELETE',
            headers: {
              'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
          });

          const data = await response.json();
          if (data.error) {
            showError(data.error);
          } else {
            viewJobCard(currentJobCard.id);
            showSuccess('Task deleted successfully');
          }
        } catch (error) {
          console.error('Error deleting task:', error);
          showError('Failed to delete task');
        }
        finally { setDeletingTask(false); }
      };

      const printJobCard = () => {
        if (!currentJobCard) return;
        
        const stockTotal = currentJobCard.stock_items.reduce((sum, item) => sum + item.total_price, 0);
        const jobLabourCharge = currentJobCard.labour_charge || labourCharge || 0;
        const grandTotal = stockTotal + parseFloat(jobLabourCharge);
        
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
          <html>
            <head>
              <title>Job Card - ${currentJobCard.job_number}</title>
              <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                h1 { text-align: center; color: #333; }
                .header { margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 10px; }
                .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
                .info-item { margin-bottom: 10px; }
                .info-item strong { display: block; color: #666; font-size: 12px; }
                .info-item span { font-size: 16px; }
                table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
                th { background: #f5f5f5; font-weight: bold; }
                .total-row { font-weight: bold; background: #f9f9f9; }
                .tasks { margin: 20px 0; }
                .task-item { padding: 8px; background: #f9f9f9; margin: 5px 0; border-left: 3px solid #667eea; }
                .footer { margin-top: 40px; text-align: center; font-size: 12px; color: #666; }
                @media print {
                  button { display: none; }
                }
              </style>
            </head>
            <body>
              <div class="header">
                <h1>ðŸ”§ Job Card</h1>
                <p style="text-align: center; color: #666;">${currentJobCard.job_number}</p>
              </div>
              
              <div class="info-grid">
                <div class="info-item">
                  <strong>Customer</strong>
                  <span>${currentJobCard.customer_name}</span>
                </div>
                <div class="info-item">
                  <strong>Vehicle Number</strong>
                  <span>${currentJobCard.vehicle_number}</span>
                </div>
                <div class="info-item">
                  <strong>Status</strong>
                  <span style="text-transform: uppercase;">${currentJobCard.status}</span>
                </div>
                <div class="info-item">
                  <strong>Assignee</strong>
                  <span>${currentJobCard.assignee || 'Not assigned'}</span>
                </div>
                <div class="info-item">
                  <strong>Created Date</strong>
                  <span>${new Date(currentJobCard.created_at).toLocaleString()}</span>
                </div>
                ${currentJobCard.closed_at ? `
                  <div class="info-item">
                    <strong>Closed Date</strong>
                    <span>${new Date(currentJobCard.closed_at).toLocaleString()}</span>
                  </div>
                ` : ''}
              </div>
              
              ${currentJobCard.notes ? `
                <div style="margin: 20px 0; padding: 15px; background: #f9f9f9; border-radius: 5px;">
                  <strong>Notes:</strong>
                  <p style="margin: 5px 0 0 0;">${currentJobCard.notes}</p>
                </div>
              ` : ''}
              
              <h3>Tasks</h3>
              <div class="tasks">
                ${currentJobCard.tasks.map(task => `
                  <div class="task-item">${task.task_description}</div>
                `).join('')}
              </div>
              
              <h3>Stock Items & Parts</h3>
              <table>
                <thead>
                  <tr>
                    <th>Product</th>
                    <th>Quantity</th>
                    <th>Unit Price</th>
                    <th>Total</th>
                  </tr>
                </thead>
                <tbody>
                  ${currentJobCard.stock_items.map(item => `
                    <tr>
                      <td>${item.product_name}</td>
                      <td>${item.quantity}</td>
                      <td>â‚¹${item.unit_price.toFixed(2)}</td>
                      <td>â‚¹${item.total_price.toFixed(2)}</td>
                    </tr>
                  `).join('')}
                  <tr class="total-row">
                    <td colspan="3">Parts Subtotal</td>
                    <td>â‚¹${stockTotal.toFixed(2)}</td>
                  </tr>
                  <tr class="total-row">
                    <td colspan="3">Labour Charges</td>
                    <td>â‚¹${parseFloat(jobLabourCharge).toFixed(2)}</td>
                  </tr>
                  <tr class="total-row" style="font-size: 18px;">
                    <td colspan="3">GRAND TOTAL</td>
                    <td>â‚¹${grandTotal.toFixed(2)}</td>
                  </tr>
                </tbody>
              </table>
              
              <div class="footer">
                <p>Thank you for your business!</p>
                <p>Generated on ${new Date().toLocaleString()}</p>
              </div>
              
              <div style="text-align: center; margin: 20px;">
                <button onclick="window.print()" style="padding: 10px 30px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">Print</button>
                <button onclick="window.close()" style="padding: 10px 30px; background: #6b7280; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-left: 10px;">Close</button>
              </div>
            </body>
          </html>
        `);
        printWindow.document.close();
      };

      const closeCreateModal = () => {
        setShowCreateModal(false);
        setCustomerSearch('');
        setSelectedCustomer(null);
        setVehicleNumber('');
        setTasks(['']);
        setAssignee('');
        setNotes('');
        setCustomerResults([]);
      };

      const resetStockForm = () => {
        setStockProductId('');
        setStockQuantity(1);
        setStockUnitPrice(0);
        setStockNotes('');
      };

      return (
        <div className="p-6">
          <h1 className="text-3xl font-bold text-gray-800 mb-6">ðŸ”§ Job Cards Management</h1>
          
          <div className="bg-white rounded-lg shadow p-6 mb-6">
            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 items-end mb-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">From Date</label>
                <input
                  type="date"
                  className="w-full px-4 py-2 border rounded-lg"
                  value={fromDate}
                  onChange={(e) => setFromDate(e.target.value)}
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">To Date</label>
                <input
                  type="date"
                  className="w-full px-4 py-2 border rounded-lg"
                  value={toDate}
                  onChange={(e) => setToDate(e.target.value)}
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Status</label>
                <select
                  className="w-full px-4 py-2 border rounded-lg"
                  value={statusFilter}
                  onChange={(e) => setStatusFilter(e.target.value)}
                >
                  <option value="">All Status</option>
                  <option value="open">Open</option>
                  <option value="closed">Closed</option>
                  <option value="rejected">Rejected</option>
                </select>
              </div>
              <div className="lg:col-span-2">
                <label className="block text-sm font-medium text-gray-700 mb-1">Search</label>
                <input
                  type="text"
                  placeholder="Job number, vehicle, customer..."
                  className="w-full px-4 py-2 border rounded-lg"
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                />
              </div>
            </div>
            <div className="flex justify-end">
              <button
                onClick={() => {
                  setComprehensiveJobCardId(null);
                  setComprehensiveModalMode('edit');
                  setShowComprehensiveModal(true);
                }}
                className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
              >
                + Create Job Card
              </button>
            </div>
          </div>

          <SectionLoader loading={loadingJobCards} message="Loading job cards...">
            {filteredJobCards.length === 0 ? (
              <div className="text-center py-20 text-gray-500">
                <div className="text-6xl mb-4">ðŸ“‹</div>
                <h3 className="text-xl font-semibold mb-2">No job cards found</h3>
                <p>Create your first job card to get started</p>
              </div>
            ) : (
              <>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                  {(() => {
                    const totalPages = Math.max(1, Math.ceil(filteredJobCards.length / pageSize));
                    const pagedJobCards = filteredJobCards.slice((page - 1) * pageSize, page * pageSize);
                    return pagedJobCards.map(job => (
                  <div
                    key={job.id}
                    className={`bg-white rounded-lg shadow p-6 cursor-pointer hover:shadow-lg transition border-l-4 ${
                      job.status === 'open' ? 'border-green-500' :
                      job.status === 'closed' ? 'border-gray-500' : 'border-red-500'
                    }`}
                    onClick={() => viewJobCard(job.id, job.status)}
                  >
                    <div className="flex justify-between items-start mb-4">
                      <div className="text-lg font-bold text-blue-600">{job.job_number}</div>
                      <span className={`px-3 py-1 rounded-full text-xs font-semibold uppercase ${
                        job.status === 'open' ? 'bg-green-100 text-green-800' :
                        job.status === 'closed' ? 'bg-gray-100 text-gray-800' : 'bg-red-100 text-red-800'
                      }`}>
                        {job.status}
                      </span>
                    </div>
                    <div className="space-y-2 text-sm">
                      <div>
                        <strong className="text-gray-600">Customer:</strong>
                        <div>{job.customer_name}</div>
                      </div>
                      <div>
                        <strong className="text-gray-600">Vehicle:</strong>
                        <div>{job.vehicle_number}</div>
                      </div>
                      {job.assignee && (
                        <div>
                          <strong className="text-gray-600">Assignee:</strong>
                          <div>{job.assignee}</div>
                        </div>
                      )}
                      <div>
                        <strong className="text-gray-600">Created:</strong>
                        <div>{new Date(job.created_at).toLocaleDateString()}</div>
                      </div>
                    </div>
                  </div>
                    ));
                  })()}
                </div>

                {/* Pagination Controls */}
                <div className="mt-6 flex justify-center items-center gap-4">
                  <button
                    disabled={page <= 1}
                    onClick={() => setPage(p => Math.max(1, p - 1))}
                    className="px-4 py-2 border rounded-lg disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50"
                  >
                    Previous
                  </button>
                  <span className="text-gray-700">
                    Page {page} of {Math.max(1, Math.ceil(filteredJobCards.length / pageSize))}
                  </span>
                  <button
                    disabled={page >= Math.ceil(filteredJobCards.length / pageSize)}
                    onClick={() => setPage(p => Math.min(Math.ceil(filteredJobCards.length / pageSize), p + 1))}
                    className="px-4 py-2 border rounded-lg disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50"
                  >
                    Next
                  </button>
                </div>
              </>
            )}
          </SectionLoader>

          {/* Comprehensive Job Card Modal */}
          <JobCardModal
            isOpen={showComprehensiveModal}
            onClose={() => {
              setShowComprehensiveModal(false);
              setComprehensiveJobCardId(null);
              setComprehensiveModalMode('view');
            }}
            mode={comprehensiveModalMode}
            jobCardId={comprehensiveJobCardId}
          />

        </div>
      );
    }

    // ------------------ Bills component ------------------
    function Bills() {
      const [bills, setBills] = useState([]);
      const [loading, setLoading] = useState(false);
      const todayDate = new Date().toISOString().split('T')[0];
      const [filters, setFilters] = useState({ from: todayDate, to: todayDate, payment_status: '', search: '' });
      const [viewBill, setViewBill] = useState(null);
      const [page, setPage] = useState(1);
      const pageSize = 10;

      useEffect(() => { loadBills(); }, [filters]);

      const loadBills = async () => {
        setLoading(true);
        try {
          const params = new URLSearchParams();
          if (filters.from) params.append('from', filters.from);
          if (filters.to) params.append('to', filters.to);
          if (filters.payment_status) params.append('payment_status', filters.payment_status);
          if (filters.search) params.append('search', filters.search);

          const data = await apiCall(`/bills?${params.toString()}`);
          setBills(data || []);
        } catch (err) {
          alert('Error loading bills: ' + err.message);
        } finally {
          setLoading(false);
        }
      };

      const handleViewBill = (billId) => {
        const token = localStorage.getItem('token');
        const url = `${API_URL}/bills/${billId}/view?token=${encodeURIComponent(token)}`;
        window.open(url, '_blank');
      };

      const handleMarkPaid = async (billId) => {
        if (!confirm('Mark this bill as paid?')) return;
        try {
          await apiCall(`/bills/${billId}/mark-paid`, { method: 'POST' });
          loadBills();
        } catch (err) {
          alert('Error: ' + err.message);
        }
      };

      const getBadgeColor = (status) => {
        if (status === 'paid') return 'bg-green-100 text-green-800';
        if (status === 'unpaid') return 'bg-yellow-100 text-yellow-800';
        return 'bg-gray-100 text-gray-800';
      };

      return (
        <div>
          <div className="mb-6">
            <h1 className="text-3xl font-bold text-gray-800">Bills & Invoices</h1>
            <p className="text-gray-600">View and manage all bills</p>
          </div>

          {/* Filters */}
          <div className="bg-white p-4 rounded-lg shadow mb-6">
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">From Date</label>
                <input
                  type="date"
                  value={filters.from}
                  onChange={e => setFilters({...filters, from: e.target.value})}
                  className="w-full px-3 py-2 border rounded"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">To Date</label>
                <input
                  type="date"
                  value={filters.to}
                  onChange={e => setFilters({...filters, to: e.target.value})}
                  className="w-full px-3 py-2 border rounded"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Payment Status</label>
                <select
                  value={filters.payment_status}
                  onChange={e => setFilters({...filters, payment_status: e.target.value})}
                  className="w-full px-3 py-2 border rounded"
                >
                  <option value="">All</option>
                  <option value="paid">Paid</option>
                  <option value="unpaid">Unpaid</option>
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Search</label>
                <input
                  type="text"
                  placeholder="Bill number or job number..."
                  value={filters.search}
                  onChange={e => setFilters({...filters, search: e.target.value})}
                  className="w-full px-3 py-2 border rounded"
                />
              </div>
            </div>
            <div className="mt-4 flex gap-2">
              <button
                onClick={loadBills}
                className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
              >
                Apply Filters
              </button>
              <button
                onClick={() => {
                  const todayDate = new Date().toISOString().split('T')[0];
                  setFilters({ from: todayDate, to: todayDate, payment_status: '', search: '' });
                  setPage(1);
                }}
                className="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300"
              >
                Reset to Today
              </button>
            </div>
          </div>

          {/* Bills Table */}
          <SectionLoader loading={loading} message="Loading bills...">
            {bills.length === 0 ? (
            <div className="bg-white rounded-lg shadow p-12 text-center">
              <div className="text-gray-400 text-5xl mb-4">ðŸ“„</div>
              <p className="text-gray-600">No bills found</p>
            </div>
          ) : (
            <div className="bg-white rounded-lg shadow overflow-hidden">
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Bill Number</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Job Number</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Customer</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                      <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Total</th>
                      <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Status</th>
                      <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Actions</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-200">
                    {(() => {
                      const totalPages = Math.max(1, Math.ceil(bills.length / pageSize));
                      const pagedBills = bills.slice((page - 1) * pageSize, page * pageSize);
                      return pagedBills.map(bill => (
                      <tr key={bill.id} className="hover:bg-gray-50">
                        <td className="px-6 py-4 text-sm font-medium text-gray-900">{bill.bill_number}</td>
                        <td className="px-6 py-4 text-sm text-gray-600">{bill.job_number}</td>
                        <td className="px-6 py-4 text-sm text-gray-600">
                          <div>{bill.customer_data.name}</div>
                          <div className="text-xs text-gray-400">{bill.customer_data.phone}</div>
                        </td>
                        <td className="px-6 py-4 text-sm text-gray-600">
                          {new Date(bill.bill_date).toLocaleDateString('en-IN')}
                        </td>
                        <td className="px-6 py-4 text-sm font-medium text-right text-gray-900">
                          â‚¹{bill.total.toFixed(2)}
                        </td>
                        <td className="px-6 py-4 text-center">
                          <span className={`px-2 py-1 text-xs font-medium rounded-full ${getBadgeColor(bill.payment_status)}`}>
                            {bill.payment_status.toUpperCase()}
                          </span>
                        </td>
                        <td className="px-6 py-4 text-center">
                          <div className="flex justify-center gap-2">
                            <button
                              onClick={() => handleViewBill(bill.id)}
                              className="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700"
                            >
                              View
                            </button>
                            {bill.payment_status === 'unpaid' && (
                              <button
                                onClick={() => handleMarkPaid(bill.id)}
                                className="px-3 py-1 text-sm bg-green-600 text-white rounded hover:bg-green-700"
                              >
                                Mark Paid
                              </button>
                            )}
                          </div>
                        </td>
                      </tr>
                      ));
                    })()}
                  </tbody>
                </table>
              </div>

              {/* Pagination */}
              <div className="bg-white px-6 py-4 border-t flex justify-center items-center gap-4">
                <button
                  disabled={page <= 1}
                  onClick={() => setPage(p => Math.max(1, p - 1))}
                  className="px-4 py-2 border rounded disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50"
                >
                  Previous
                </button>
                <span className="text-gray-700">
                  Page {page} of {Math.max(1, Math.ceil(bills.length / pageSize))}
                </span>
                <button
                  disabled={page >= Math.ceil(bills.length / pageSize)}
                  onClick={() => setPage(p => Math.min(Math.ceil(bills.length / pageSize), p + 1))}
                  className="px-4 py-2 border rounded disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50"
                >
                  Next
                </button>
              </div>

              {/* Summary */}
              <div className="bg-gray-50 px-6 py-4 border-t">
                <div className="flex justify-between items-center">
                  <div className="text-sm text-gray-600">
                    Total Bills: <span className="font-semibold">{bills.length}</span>
                  </div>
                  <div className="text-sm text-gray-600">
                    Total Amount: <span className="font-semibold text-lg">
                      â‚¹{bills.reduce((sum, b) => sum + b.total, 0).toFixed(2)}
                    </span>
                  </div>
                  <div className="text-sm text-gray-600">
                    Unpaid: <span className="font-semibold text-yellow-600">
                      â‚¹{bills.filter(b => b.payment_status === 'unpaid').reduce((sum, b) => sum + b.total, 0).toFixed(2)}
                    </span>
                  </div>
                </div>
              </div>
            </div>
            )}
          </SectionLoader>
        </div>
      );
    }

    // ------------------ Profit & Loss component ------------------
    function ProfitLoss() {
      const { showError } = React.useContext(MessageContext);
      const [loading, setLoading] = useState(false);
      const [data, setData] = useState(null);
      const [filters, setFilters] = useState({
        from: new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0],
        to: new Date().toISOString().split('T')[0]
      });

      useEffect(() => { loadReport(); }, []);

      const loadReport = async () => {
        setLoading(true);
        try {
          const params = new URLSearchParams(filters);
          const result = await apiCall(`/reports/profit-loss?${params.toString()}`);
          setData(result);
        } catch (err) {
          showError('Error loading report: ' + err.message);
        } finally {
          setLoading(false);
        }
      };

      const downloadReport = () => {
        window.print();
      };

      if (loading) {
        return (
          <div className="flex items-center justify-center h-64">
            <div className="text-gray-600">Loading report...</div>
          </div>
        );
      }

      return (
        <div>
          <div className="mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
            <div>
              <h1 className="text-2xl lg:text-3xl font-bold text-gray-800">Profit & Loss Report</h1>
              <p className="text-sm lg:text-base text-gray-600">Financial performance overview</p>
            </div>
            <button
              onClick={downloadReport}
              className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm lg:text-base"
            >
              ðŸ“„ Download/Print Report
            </button>
          </div>

          {/* Filters */}
          <div className="bg-white p-4 rounded-lg shadow mb-6">
            <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">From Date</label>
                <input
                  type="date"
                  value={filters.from}
                  onChange={e => setFilters({...filters, from: e.target.value})}
                  className="w-full px-3 py-2 border rounded text-sm lg:text-base"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">To Date</label>
                <input
                  type="date"
                  value={filters.to}
                  onChange={e => setFilters({...filters, to: e.target.value})}
                  className="w-full px-3 py-2 border rounded text-sm lg:text-base"
                />
              </div>
              <div className="flex items-end">
                <button
                  onClick={loadReport}
                  className="w-full px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm lg:text-base"
                >
                  Generate Report
                </button>
              </div>
            </div>
          </div>

          {data && (
            <>
              {/* Summary Cards */}
              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div className="bg-white p-4 lg:p-6 rounded-lg shadow">
                  <div className="text-xs lg:text-sm text-gray-600 mb-1">Total Revenue</div>
                  <div className="text-xl lg:text-2xl font-bold text-green-600">â‚¹{data.summary.total_revenue.toFixed(2)}</div>
                  <div className="text-xs text-gray-500 mt-1">{data.summary.bill_count} bills</div>
                </div>

                <div className="bg-white p-4 lg:p-6 rounded-lg shadow">
                  <div className="text-xs lg:text-sm text-gray-600 mb-1">Total Costs</div>
                  <div className="text-xl lg:text-2xl font-bold text-red-600">â‚¹{data.summary.total_costs.toFixed(2)}</div>
                  <div className="text-xs text-gray-500 mt-1">Inventory purchases</div>
                </div>

                <div className={`bg-white p-4 lg:p-6 rounded-lg shadow ${data.summary.profit_loss >= 0 ? 'border-l-4 border-green-500' : 'border-l-4 border-red-500'}`}>
                  <div className="text-xs lg:text-sm text-gray-600 mb-1">Net Profit/Loss</div>
                  <div className={`text-xl lg:text-2xl font-bold ${data.summary.profit_loss >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                    â‚¹{data.summary.profit_loss.toFixed(2)}
                  </div>
                  <div className="text-xs text-gray-500 mt-1">
                    {data.summary.profit_loss >= 0 ? 'Profit' : 'Loss'}
                  </div>
                </div>

                <div className="bg-white p-4 lg:p-6 rounded-lg shadow">
                  <div className="text-xs lg:text-sm text-gray-600 mb-1">Profit Margin</div>
                  <div className="text-xl lg:text-2xl font-bold text-blue-600">{data.summary.profit_margin}%</div>
                  <div className="text-xs text-gray-500 mt-1">Revenue percentage</div>
                </div>
              </div>
            </>
          )}
        </div>
      );
    }

    function App() {
      const { isAuthenticated, logout, user } = React.useContext(AuthContext);
      const { current, navigate } = React.useContext(NavigationContext);
      const [sidebarCollapsed, setSidebarCollapsed] = useState(false);
      if (!isAuthenticated) return <Login />;

      const menu = [
        { id: 'dashboard', label: 'Dashboard', icon: 'ðŸ“Š' },
        { id: 'reminders', label: 'Reminders', icon: 'ðŸ””' },
        { id: 'customers', label: 'Customers', icon: 'ðŸ‘¥' },
        { id: 'jobcards', label: 'Job Cards', icon: 'ðŸ”§' },
        { id: 'sales', label: 'Sales', icon: 'ðŸ’°' },
        { id: 'bills', label: 'Bills', icon: 'ðŸ“„' },
        { id: 'stock', label: 'Stock Management', icon: 'ðŸ“¦' },
        { id: 'reports', label: 'Profit & Loss', icon: 'ðŸ“ˆ' },
      ];

      const handleMenuClick = (menuId) => {
        navigate(menuId);
        // On mobile, close menu completely after selection
        if (window.innerWidth < 1024) {
          setSidebarCollapsed(true);
        }
      };

      const toggleSidebar = () => {
        setSidebarCollapsed(!sidebarCollapsed);
      };

      return (
        <div className="flex h-screen bg-gray-50 overflow-hidden">
          {/* Mobile menu overlay - only show on mobile when sidebar is expanded */}
          {!sidebarCollapsed && (
            <div
              className="fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden"
              onClick={() => setSidebarCollapsed(true)}
            />
          )}

          {/* Sidebar - responsive behavior:
              Mobile: Hidden when collapsed, overlay when expanded
              Desktop: Icon-only when collapsed, full-width when expanded */}
          <aside className={`fixed lg:relative inset-y-0 left-0 z-50 bg-white shadow-lg transform transition-all duration-300 ease-in-out flex flex-col
            ${sidebarCollapsed
              ? '-translate-x-full lg:translate-x-0 lg:w-20'
              : 'translate-x-0 w-64'
            }`}>
            <div className={`p-4 border-b flex-shrink-0 ${sidebarCollapsed ? 'lg:p-2' : 'lg:p-6'}`}>
              <div className="flex items-center justify-between">
                <div className={sidebarCollapsed ? 'lg:hidden' : ''}>
                  <h1 className={`font-bold text-blue-600 ${sidebarCollapsed ? 'text-xl' : 'text-xl lg:text-2xl'}`}>Jyoti Auto Parts</h1>
                  <p className={`text-gray-600 mt-1 ${sidebarCollapsed ? 'text-xs' : 'text-xs lg:text-sm'}`}>Welcome, {user?.username || 'User'}</p>
                </div>
                {sidebarCollapsed && (
                  <div className="hidden lg:block text-2xl">ðŸª</div>
                )}
                <button
                  onClick={() => setSidebarCollapsed(true)}
                  className="lg:hidden text-gray-600 hover:text-gray-900"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
            </div>
            <nav className={`flex-1 p-3 overflow-y-auto ${sidebarCollapsed ? 'lg:p-2' : 'lg:p-4'}`}>
              {menu.map(m => (
                <button
                  key={m.id}
                  onClick={() => handleMenuClick(m.id)}
                  className={`w-full text-left mb-2 rounded-lg flex items-center transition-colors
                    ${sidebarCollapsed
                      ? 'lg:justify-center lg:p-3'
                      : 'px-3 lg:px-4 py-2 lg:py-3 gap-3'
                    }
                    ${current===m.id ? 'bg-blue-600 text-white' : 'hover:bg-gray-100'}`}
                  title={sidebarCollapsed ? m.label : ''}
                >
                  <span className={`${sidebarCollapsed ? 'text-xl lg:text-2xl' : 'text-lg lg:text-xl'}`}>{m.icon}</span>
                  <span className={`font-medium text-sm lg:text-base ${sidebarCollapsed ? 'lg:hidden' : ''}`}>{m.label}</span>
                </button>
              ))}
            </nav>
          </aside>

          <main className="flex-1 flex flex-col overflow-hidden w-full">
            <header className="bg-white border-b p-3 lg:p-4 flex justify-between items-center">
              <div className="flex items-center gap-3">
                {/* Hamburger menu - shows on all screen sizes */}
                <button
                  onClick={toggleSidebar}
                  className="text-gray-600 hover:text-gray-900 hover:bg-gray-100 p-2 rounded-lg transition-colors"
                  title={sidebarCollapsed ? 'Expand sidebar' : 'Collapse sidebar'}
                >
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16" />
                  </svg>
                </button>
                <div className="text-base lg:text-lg font-semibold">{menu.find(i=>i.id===current)?.label}</div>
              </div>
              <div className="flex items-center gap-3">
                <div className="text-xs lg:text-sm text-gray-600 hidden sm:block">Jhansi | {new Date().toLocaleDateString()}</div>
                {/* Help Icon */}
                <button
                  onClick={() => window.open('/user-guide', '_blank')}
                  className="p-2 text-blue-600 hover:text-blue-800 hover:bg-blue-50 rounded-full transition-colors"
                  title="User Guide & Help"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 lg:h-6 lg:w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                </button>
                {/* Logout Icon */}
                <button
                  onClick={logout}
                  className="p-2 text-red-600 hover:text-red-800 hover:bg-red-50 rounded-full transition-colors"
                  title="Logout"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 lg:h-6 lg:w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                  </svg>
                </button>
              </div>
            </header>

            <section className="flex-1 overflow-auto p-3 lg:p-6">
              {current === 'dashboard' && <Dashboard />}
              {current === 'reminders' && <Reminders />}
              {current === 'customers' && <Customers />}
              {current === 'stock' && <StockManagement />}
              {current === 'jobcards' && <JobCards />}
              {current === 'bills' && <Bills />}
              {current === 'sales' && <Sales />}
              {current === 'reports' && <ProfitLoss />}
            </section>

            <footer className="bg-white border-t p-2 lg:p-3 text-center text-xs lg:text-sm text-gray-600">
              Â© {new Date().getFullYear()} Jyoti Auto Parts
            </footer>
          </main>
        </div>
      );
    }

    ReactDOM.render(
      <AuthProvider>
        <NavigationProvider>
          <MessageProvider>
            <App />
          </MessageProvider>
        </NavigationProvider>
      </AuthProvider>,
      document.getElementById('root')
    );
  </script>
</body>
</html>