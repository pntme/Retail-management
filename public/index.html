<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Retail Management System</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    /* prevent page-level horizontal scroll while allowing table-level scroll */
    html, body { overflow-x: hidden; }
  </style>
</head>
<body class="bg-gray-50">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;
    // Dynamic API URL - works for both local and production
const API_URL = window.location.hostname === 'localhost' 
  ? 'http://localhost:3001/api' 
  : `${window.location.origin}/api`;
    const AuthContext = React.createContext();

    function AuthProvider({ children }) {
      const [token, setToken] = useState(localStorage.getItem('token'));
      const [user, setUser] = useState(() => {
        try { const u = localStorage.getItem('user'); return u ? JSON.parse(u) : null; } catch { return null; }
      });

      const login = (t, u) => { localStorage.setItem('token', t); localStorage.setItem('user', JSON.stringify(u)); setToken(t); setUser(u); };
      const logout = () => { localStorage.removeItem('token'); localStorage.removeItem('user'); setToken(null); setUser(null); };

      return <AuthContext.Provider value={{ token, user, login, logout, isAuthenticated: !!token }}>{children}</AuthContext.Provider>;
    }

    async function apiCall(endpoint, options = {}) {
      const token = localStorage.getItem('token');
      const headers = { 'Content-Type': 'application/json', ...(token && { 'Authorization': `Bearer ${token}` }), ...options.headers };
      const res = await fetch(`${API_URL}${endpoint}`, { ...options, headers });
      if (!res.ok) {
        let err;
        try { err = await res.json(); } catch { err = { error: 'Request failed' }; }
        throw new Error(err.error || 'Request failed');
      }
      return res.json();
    }

    function Login() {
      const { login } = React.useContext(AuthContext);
      const [username, setUsername] = useState('admin');
      const [password, setPassword] = useState('admin123');
      const [error, setError] = useState('');
      const [loading, setLoading] = useState(false);

      const handleSubmit = async (e) => {
        e.preventDefault();
        setError(''); setLoading(true);
        try {
          const data = await apiCall('/auth/login', { method: 'POST', body: JSON.stringify({ username, password }) });
          login(data.token, data.user);
        } catch (err) { setError(err.message); } finally { setLoading(false); }
      };

      return (
        <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-blue-500 to-purple-600">
          <div className="bg-white p-8 rounded-2xl shadow-2xl w-96">
            <div className="text-center mb-6">
              <h1 className="text-3xl font-bold text-gray-800">Retail Manager</h1>
              <p className="text-gray-600">Welcome back</p>
            </div>
            <form onSubmit={handleSubmit}>
              <label className="block text-sm font-medium text-gray-700">Username</label>
              <input value={username} onChange={e => setUsername(e.target.value)} className="w-full px-3 py-2 border rounded mb-3" required />
              <label className="block text-sm font-medium text-gray-700">Password</label>
              <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full px-3 py-2 border rounded mb-4" required />
              {error && <div className="text-red-600 mb-3">{error}</div>}
              <button type="submit" disabled={loading} className="w-full bg-blue-600 text-white py-2 rounded">{loading ? 'Logging in...' : 'Login'}</button>
            </form>
            <div className="mt-4 text-sm text-gray-600">Default: admin / admin123</div>
          </div>
        </div>
      );
    }

    function Modal({ children, onClose, wide=false }) {
      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 p-4">
          <div className={`bg-white rounded-lg shadow-2xl ${wide ? 'max-w-5xl w-full' : 'max-w-2xl w-full'} max-h-[90vh] overflow-y-auto relative`}>
            <button onClick={onClose} className="absolute top-3 right-3 text-gray-600 hover:text-gray-900 text-2xl">Ã—</button>
            <div className="p-6">{children}</div>
          </div>
        </div>
      );
    }

    function ConfirmModal({ title, message, onConfirm, onCancel, loading = false }) {
      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 p-4">
          <div className="bg-white rounded-lg shadow-2xl max-w-md w-full relative">
            <div className="p-6">
              <h2 className="text-2xl font-bold mb-4">{title}</h2>
              <p className="text-gray-700 mb-6">{message}</p>
              <div className="flex gap-3 justify-end">
                <button onClick={onCancel} className="px-4 py-2 bg-gray-200 text-gray-800 rounded hover:bg-gray-300 transition" disabled={loading}>Cancel</button>
                <ButtonLoader loading={loading} onClick={onConfirm} className="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition">Delete</ButtonLoader>
              </div>
            </div>
          </div>
        </div>
      );
    }

    function StatCard({ title, value, icon, color }) {
      return (
        <div className="bg-white p-6 rounded shadow hover:shadow-lg transition">
          <div className="flex items-center justify-between mb-3">
            <div className="text-2xl">{icon}</div>
            <div className={`${color} w-10 h-10 rounded-full flex items-center justify-center text-white`}>{icon}</div>
          </div>
          <div className="text-sm text-gray-600">{title}</div>
          <div className="text-2xl font-bold mt-2">{value}</div>
        </div>
      );
    }

    // Spinner component for loading states
    function Spinner({ size = 'md', color = 'blue' }) {
      const sizeClasses = {
        sm: 'w-4 h-4 border-2',
        md: 'w-8 h-8 border-3',
        lg: 'w-12 h-12 border-4',
        xl: 'w-16 h-16 border-4'
      };
      const colorClasses = {
        blue: 'border-blue-600 border-t-transparent',
        white: 'border-white border-t-transparent',
        gray: 'border-gray-600 border-t-transparent',
        green: 'border-green-600 border-t-transparent',
        red: 'border-red-600 border-t-transparent'
      };
      return (
        <div className={`${sizeClasses[size]} ${colorClasses[color]} rounded-full animate-spin`}></div>
      );
    }

    // Full-page loading overlay
    function LoadingOverlay({ message = 'Loading...', show = true }) {
      if (!show) return null;
      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50">
          <div className="bg-white p-8 rounded-lg shadow-2xl flex flex-col items-center space-y-4">
            <Spinner size="xl" />
            <p className="text-gray-700 font-medium text-lg">{message}</p>
          </div>
        </div>
      );
    }

    // Inline loader for buttons
    function ButtonLoader({ loading, children, ...props }) {
      return (
        <button {...props} disabled={loading || props.disabled}>
          {loading ? (
            <div className="flex items-center justify-center gap-2">
              <Spinner size="sm" color="white" />
              <span>Loading...</span>
            </div>
          ) : children}
        </button>
      );
    }

    // Section loader for content areas
    function SectionLoader({ loading, children, message = 'Loading...' }) {
      if (loading) {
        return (
          <div className="flex flex-col items-center justify-center py-12 space-y-4">
            <Spinner size="lg" />
            <p className="text-gray-600">{message}</p>
          </div>
        );
      }
      return children;
    }

    // ------------------ Customers component (enhanced) ------------------
    function Customers() {
      const [customers, setCustomers] = useState([]);
      const [search, setSearch] = useState('');
      const [showForm, setShowForm] = useState(false);
      const [editing, setEditing] = useState(null);
      const [showView, setShowView] = useState(false);
      const [viewCustomer, setViewCustomer] = useState(null);
      const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
      const [deleteId, setDeleteId] = useState(null);

      // Loading states
      const [loadingCustomers, setLoadingCustomers] = useState(false);
      const [submitting, setSubmitting] = useState(false);
      const [deleting, setDeleting] = useState(false);
      const [loadingServiceHistory, setLoadingServiceHistory] = useState(false);
      const [creatingJobCard, setCreatingJobCard] = useState(false);

      // pagination
      const [page, setPage] = useState(1);
      const pageSize = 12;

      // reminders / filters
      const [reminderStart, setReminderStart] = useState('');
      const [reminderEnd, setReminderEnd] = useState('');

      // service history modal
      const [showServiceHistory, setShowServiceHistory] = useState(false);
      const [serviceHistory, setServiceHistory] = useState([]);

      const initialForm = {
        name: '',
        email: '',
        phone: '',
        address: '',
        vehicle_number: '',
        vehicle_type: ''
      };

      const [form, setForm] = useState(initialForm);

      useEffect(() => { loadCustomers(); }, [search]);

      const loadCustomers = async () => {
        setLoadingCustomers(true);
        try {
          const data = await apiCall(`/customers?search=${encodeURIComponent(search)}`);
          setCustomers(data || []);
          setPage(1);
        } catch (err) { console.error(err); }
        finally { setLoadingCustomers(false); }
      };

      const normalizeVehicleNumber = (value) => {
        if (!value) return '';
        return value.toUpperCase().replace(/[^A-Z0-9]/g, '');
      };

      const onVehicleNumberChange = (value) => setForm(prev => ({ ...prev, vehicle_number: normalizeVehicleNumber(value) }));

      const validateForm = () => {
        if (!form.name.trim()) { alert('Name is required'); return false; }
        if (!form.phone.trim()) { alert('Phone is required'); return false; }
        return true;
      };

      const openCreate = () => { setEditing(null); setForm(initialForm); setShowForm(true); };
      const openEdit = (c) => {
        setEditing(c);
        setForm({
          name: c.name ?? '',
          email: c.email ?? '',
          phone: c.phone ?? '',
          address: c.address ?? '',
          vehicle_number: c.vehicle_number ?? '',
          vehicle_type: c.vehicle_type ?? ''
        });
        setShowForm(true);
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!validateForm()) return;
        setSubmitting(true);
        try {
          if (editing) {
            await apiCall(`/customers/${editing.id}`, { method: 'PUT', body: JSON.stringify(form) });
          } else {
            await apiCall('/customers', { method: 'POST', body: JSON.stringify(form) });
          }
          setShowForm(false); setEditing(null); setForm(initialForm); loadCustomers();
        } catch (err) { alert(err.message); }
        finally { setSubmitting(false); }
      };

      const handleDelete = async (id) => { setDeleteId(id); setShowDeleteConfirm(true); };

      const confirmDelete = async () => {
        setDeleting(true);
        try { await apiCall(`/customers/${deleteId}`, { method: 'DELETE' }); loadCustomers(); } catch (err) { alert(err.message); }
        finally { setDeleting(false); setShowDeleteConfirm(false); setDeleteId(null); }
      };

      const cancelDelete = () => { setShowDeleteConfirm(false); setDeleteId(null); };

      const handleView = (customer) => { setViewCustomer(customer); setShowView(true); };

      // service history
      const openServiceHistory = async (customer) => {
        setLoadingServiceHistory(true);
        try {
          const data = await apiCall(`/customers/${customer.id}/service-history`);
          setServiceHistory(data || []);
        } catch (err) {
          console.warn('service history not available via API, using empty list', err);
          setServiceHistory([]);
        }
        finally { setLoadingServiceHistory(false); setShowServiceHistory(true); }
      };

      // job card quick-create (simple inline modal)
      const [showCreateJobCard, setShowCreateJobCard] = useState(false);
      const [jcCustomer, setJcCustomer] = useState(null);
      const [jcVehicle, setJcVehicle] = useState('');
      const [jcTasks, setJcTasks] = useState(['']);

      const openCreateJobCardFor = (customer) => { setJcCustomer(customer); setJcVehicle(customer.vehicle_number || ''); setJcTasks(['']); setShowCreateJobCard(true); };

      const createJobCardInline = async () => {
        if (!jcCustomer) return alert('No customer selected');
        const tasks = jcTasks.map(t => t.trim()).filter(Boolean);
        if (tasks.length === 0) return alert('Add at least one task');
        setCreatingJobCard(true);
        try {
          await apiCall('/job-cards', { method: 'POST', body: JSON.stringify({ customer_id: jcCustomer.id, vehicle_number: jcVehicle, tasks }) });
          setShowCreateJobCard(false); setJcCustomer(null); setJcVehicle(''); setJcTasks(['']);
          alert('Job card created');
        } catch (err) { alert(err.message); }
        finally { setCreatingJobCard(false); }
      };

      // call logs inside view modal (readonly - just display)
      const [callNotes, setCallNotes] = useState([]);

      useEffect(() => {
        if (viewCustomer) {
          // attempt to load call logs
          (async () => {
            try {
              const data = await apiCall(`/customers/${viewCustomer.id}/call-logs`);
              setCallNotes(data || []);
            } catch (e) {
              setCallNotes(viewCustomer.call_logs || []);
            }
          })();
        } else {
          setCallNotes([]);
        }
      }, [viewCustomer]);

      // reminders - moved to separate component
      const getReminders = () => {
        const list = (customers || []).map(c => ({ id: c.id, name: c.name, phone: c.phone, next_service_date: c.next_service_date })).filter(i => i.next_service_date);
        if (reminderStart && reminderEnd) {
          const s = new Date(reminderStart); s.setHours(0,0,0,0);
          const e = new Date(reminderEnd); e.setHours(23,59,59,999);
          return list.filter(i => { const d = new Date(i.next_service_date); return d >= s && d <= e; });
        }
        return list;
      };

      // pagination helpers
      const totalPages = Math.max(1, Math.ceil((customers || []).length / pageSize));
      const pagedCustomers = (customers || []).slice((page-1)*pageSize, page*pageSize);

      return (
        <div>
          <div className="flex justify-between items-center mb-6">
            <h1 className="text-3xl font-bold text-gray-800">Customers</h1>
            <div className="flex items-center gap-3">
              <input
                value={search}
                onChange={e => setSearch(e.target.value)}
                placeholder="Search by name, phone, email, vehicle..."
                className="px-3 py-2 border rounded-lg w-72"
              />
              <button onClick={openCreate} className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">+ Add Customer</button>
            </div>
          </div>

          <div className="bg-white rounded-lg shadow overflow-hidden">
            <SectionLoader loading={loadingCustomers} message="Loading customers...">
              <div className="w-full overflow-x-auto">
                <table className="min-w-[900px] w-full table-auto">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Phone</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Vehicle Type</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Vehicle No.</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Address</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-200">
                    {pagedCustomers.map(c => (
                    <tr key={c.id} className="hover:bg-gray-50">
                      <td className="px-6 py-4 whitespace-nowrap">
                        <div className="flex items-center gap-3">
                          {/* view details */}
                          <button title="View" onClick={() => handleView(c)} className="text-gray-600 hover:text-gray-900">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M2.458 12C3.732 7.943 7.523 5 12 5s8.268 2.943 9.542 7c-1.274 4.057-5.065 7-9.542 7S3.732 16.057 2.458 12z" />
                            </svg>
                          </button>

                          {/* service history icon */}
                          <button title="Service History" onClick={() => openServiceHistory(c)} className="text-indigo-600 hover:text-indigo-800">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                              <path d="M8 2a1 1 0 011 1v1h2V3a1 1 0 112 0v1h1a2 2 0 012 2v1H3V6a2 2 0 012-2h1V3a1 1 0 011-1z" />
                              <path d="M3 9h14v6a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                            </svg>
                          </button>

                          {/* open job card */}
                          <button title="Create Job Card" onClick={() => openCreateJobCardFor(c)} className="text-green-600 hover:text-green-800">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                              <path d="M6 2a1 1 0 00-1 1v2h10V3a1 1 0 00-1-1H6z" />
                              <path fillRule="evenodd" d="M4 7h12v8a2 2 0 01-2 2H6a2 2 0 01-2-2V7z" clipRule="evenodd" />
                            </svg>
                          </button>

                          {/* edit */}
                          <button title="Edit" onClick={() => openEdit(c)} className="text-blue-600 hover:text-blue-800">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                              <path d="M17.414 2.586a2 2 0 010 2.828L8.414 14.414a1 1 0 01-.464.263l-4 1a1 1 0 01-1.213-1.213l1-4a1 1 0 01.263-.464L14.586 2.586a2 2 0 012.828 0z" />
                            </svg>
                          </button>

                          {/* delete */}
                          <button title="Delete" onClick={() => handleDelete(c.id)} className="text-red-600 hover:text-red-800">
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                              <path fillRule="evenodd" d="M6 2a1 1 0 00-1 1v1H3a1 1 0 100 2h14a1 1 0 100-2h-2V3a1 1 0 00-1-1H6zm2 6a1 1 0 10-2 0v7a1 1 0 102 0V8zm6 0a1 1 0 10-2 0v7a1 1 0 102 0V8z" clipRule="evenodd" />
                            </svg>
                          </button>
                        </div>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap max-w-xs overflow-hidden text-ellipsis font-medium">{c.name}</td>
                      <td className="px-6 py-4 whitespace-nowrap"><a href={`tel:${c.phone}`} className="text-blue-600 hover:underline">{c.phone}</a></td>
                      <td className="px-6 py-4 whitespace-nowrap">{c.email || '-'}</td>
                      <td className="px-6 py-4 whitespace-nowrap">{c.vehicle_type || '-'}</td>
                      <td className="px-6 py-4 whitespace-nowrap font-mono">{c.vehicle_number || '-'}</td>
                      <td className="px-6 py-4 whitespace-nowrap max-w-sm overflow-hidden text-ellipsis">{c.address || '-'}</td>
                    </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            </SectionLoader>
          </div>

          {/* pagination */}
          <div className="flex items-center justify-between mt-3">
            <div className="text-sm text-gray-600">Showing {(customers||[]).length === 0 ? 0 : ((page-1)*pageSize+1)} - {Math.min(page*pageSize, (customers||[]).length)} of {(customers||[]).length} customers</div>
            <div className="flex items-center gap-2">
              <button disabled={page<=1} onClick={() => setPage(p => Math.max(1, p-1))} className="px-3 py-1 border rounded disabled:opacity-50">Prev</button>
              <div className="px-3 py-1 border rounded">{page}/{totalPages}</div>
              <button disabled={page>=totalPages} onClick={() => setPage(p => Math.min(totalPages, p+1))} className="px-3 py-1 border rounded disabled:opacity-50">Next</button>
            </div>
          </div>

          {/* Create / Edit Modal */}
          {showForm && (
            <Modal onClose={() => { setShowForm(false); setEditing(null); }} wide={false}>
              <h2 className="text-2xl font-bold mb-4">{editing ? 'Edit Customer' : 'Add Customer'}</h2>
              <form onSubmit={handleSubmit}>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium mb-1">Name *</label>
                    <input type="text" value={form.name} onChange={e => setForm(prev => ({ ...prev, name: e.target.value }))} className="w-full px-3 py-2 border rounded" required />
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-1">Phone *</label>
                    <input type="text" value={form.phone} onChange={e => setForm(prev => ({ ...prev, phone: e.target.value }))} className="w-full px-3 py-2 border rounded" required />
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-1">Email</label>
                    <input type="email" value={form.email} onChange={e => setForm(prev => ({ ...prev, email: e.target.value }))} className="w-full px-3 py-2 border rounded" />
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-1">Vehicle Type</label>
                    <input type="text" value={form.vehicle_type} onChange={e => setForm(prev => ({ ...prev, vehicle_type: e.target.value }))} className="w-full px-3 py-2 border rounded" />
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-1">Vehicle Number</label>
                    <input
                      type="text"
                      value={form.vehicle_number}
                      onChange={e => onVehicleNumberChange(e.target.value)}
                      className="w-full px-3 py-2 border rounded"
                      placeholder="Alphanumeric - will be uppercased"
                    />
                    <p className="text-xs text-gray-500 mt-1">Only A-Z and 0-9 are allowed. Will be stored in uppercase.</p>
                  </div>

                  <div className="col-span-2">
                    <label className="block text-sm font-medium mb-1">Address</label>
                    <textarea value={form.address} onChange={e => setForm(prev => ({ ...prev, address: e.target.value }))} rows="3" className="w-full px-3 py-2 border rounded"></textarea>
                  </div>
                </div>

                <div className="flex justify-end gap-3 mt-4">
                  <button type="button" onClick={() => { setShowForm(false); setEditing(null); }} className="px-4 py-2 border rounded hover:bg-gray-50" disabled={submitting}>Cancel</button>
                  <ButtonLoader loading={submitting} type="submit" className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">{editing ? 'Update' : 'Create'}</ButtonLoader>
                </div>
              </form>
            </Modal>
          )}

          {/* Service History modal */}
          {showServiceHistory && (
            <Modal onClose={() => { setShowServiceHistory(false); setServiceHistory([]); }} wide={true}>
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-2xl font-bold">Service History</h2>
                <button onClick={() => window.print()} className="px-3 py-2 bg-gray-200 rounded">Print</button>
              </div>
              <SectionLoader loading={loadingServiceHistory} message="Loading service history...">
                <div className="space-y-4">
                  {serviceHistory.length === 0 ? (
                    <div className="text-gray-500">No service history available.</div>
                  ) : (
                    serviceHistory.map((s, i) => (
                      <div key={i} className="p-4 border rounded bg-white shadow-sm">
                        <div className="flex justify-between items-start mb-3">
                          <div className="flex-1">
                            <div className="font-semibold text-lg">{s.job_number}</div>
                            <div className="text-sm text-gray-600">
                              {s.created_at && new Date(s.created_at).toLocaleDateString('en-IN', {
                                year: 'numeric', month: 'long', day: 'numeric'
                              })}
                            </div>
                          </div>
                          <div className="text-right">
                            <span className={`px-2 py-1 text-xs rounded ${s.status === 'closed' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}`}>
                              {s.status}
                            </span>
                          </div>
                        </div>

                        {s.tasks && s.tasks.length > 0 && (
                          <div className="mb-3">
                            <div className="text-sm font-medium text-gray-700 mb-1">Services Performed:</div>
                            <ul className="list-disc list-inside text-sm text-gray-600">
                              {s.tasks.map((task, idx) => (
                                <li key={idx}>{task.task_description}</li>
                              ))}
                            </ul>
                          </div>
                        )}

                        {s.stock_items && s.stock_items.length > 0 && (
                          <div className="mb-3">
                            <div className="text-sm font-medium text-gray-700 mb-1">Parts Used:</div>
                            <div className="text-sm text-gray-600">
                              {s.stock_items.map((item, idx) => (
                                <div key={idx}>â€¢ {item.product_name} (Qty: {item.quantity})</div>
                              ))}
                            </div>
                          </div>
                        )}

                        {s.bills && s.bills.length > 0 && (
                          <div className="mt-3 pt-3 border-t">
                            <div className="text-sm font-medium text-gray-700 mb-2">Bills:</div>
                            {s.bills.map((bill, idx) => (
                              <div key={idx} className="flex justify-between items-center bg-gray-50 p-2 rounded mb-2">
                                <div>
                                  <div className="font-medium text-sm">{bill.bill_number}</div>
                                  <div className="text-xs text-gray-600">
                                    {new Date(bill.bill_date).toLocaleDateString('en-IN')} â€¢ â‚¹{bill.total.toFixed(2)}
                                  </div>
                                </div>
                                <div className="flex gap-2 items-center">
                                  <span className={`px-2 py-0.5 text-xs rounded ${bill.payment_status === 'paid' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`}>
                                    {bill.payment_status.toUpperCase()}
                                  </span>
                                  <button
                                    onClick={() => {
                                      const token = localStorage.getItem('token');
                                      const url = `${API_URL}/bills/${bill.id}/view?token=${encodeURIComponent(token)}`;
                                      window.open(url, '_blank');
                                    }}
                                    className="px-2 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700"
                                  >
                                    View Bill
                                  </button>
                                </div>
                              </div>
                            ))}
                          </div>
                        )}

                        {s.notes && (
                          <div className="mt-3 pt-3 border-t">
                            <div className="text-sm text-gray-600">
                              <strong>Notes:</strong> {s.notes}
                            </div>
                          </div>
                        )}
                      </div>
                    ))
                  )}
                </div>
              </SectionLoader>
            </Modal>
          )}

          {loadingServiceHistory && <LoadingOverlay message="Loading service history..." />}

          {/* Create Job Card inline modal */}
          {showCreateJobCard && (
            <Modal onClose={() => setShowCreateJobCard(false)} wide={false}>
              <h2 className="text-2xl font-bold mb-4">Create Job Card for {jcCustomer?.name}</h2>
              <div className="space-y-3">
                <div>
                  <label className="block text-sm font-medium mb-1">Vehicle Number</label>
                  <input value={jcVehicle} onChange={e=>setJcVehicle(e.target.value)} className="w-full px-3 py-2 border rounded" />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Tasks</label>
                  {jcTasks.map((t, idx) => (
                    <div key={idx} className="flex gap-2 mb-2">
                      <input value={t} onChange={e => { const arr=[...jcTasks]; arr[idx]=e.target.value; setJcTasks(arr); }} className="flex-1 px-3 py-2 border rounded" />
                      {jcTasks.length>1 && <button onClick={()=>setJcTasks(prev=>prev.filter((_,i)=>i!==idx))} className="px-3 py-2 bg-red-600 text-white rounded">Remove</button>}
                    </div>
                  ))}
                  <button onClick={()=>setJcTasks(prev=>[...prev,''])} className="px-3 py-2 bg-gray-600 text-white rounded" disabled={creatingJobCard}>+ Add Task</button>
                </div>
                <div className="flex gap-3">
                  <ButtonLoader loading={creatingJobCard} onClick={createJobCardInline} className="flex-1 px-4 py-2 bg-green-600 text-white rounded">Create</ButtonLoader>
                  <button onClick={()=>setShowCreateJobCard(false)} className="flex-1 px-4 py-2 border rounded" disabled={creatingJobCard}>Cancel</button>
                </div>
              </div>
            </Modal>
          )}

          {/* View modal */}
          {showView && viewCustomer && (
            <Modal onClose={() => { setShowView(false); setViewCustomer(null); }} wide={false}>
              <h2 className="text-2xl font-bold mb-4">Customer Details</h2>
              <div className="grid grid-cols-2 gap-4 mb-6">
                <div><div className="text-sm text-gray-500">Name</div><div className="font-medium">{viewCustomer.name}</div></div>
                <div><div className="text-sm text-gray-500">Vehicle Type</div><div className="font-medium">{viewCustomer.vehicle_type || '-'}</div></div>
                <div><div className="text-sm text-gray-500">Vehicle Number</div><div className="font-medium">{viewCustomer.vehicle_number || '-'}</div></div>
                <div><div className="text-sm text-gray-500">Phone</div><div className="font-medium"><a href={`tel:${viewCustomer.phone}`} className="text-blue-600 hover:underline">{viewCustomer.phone}</a></div></div>
                <div><div className="text-sm text-gray-500">Email</div><div className="font-medium">{viewCustomer.email || '-'}</div></div>
                <div className="col-span-2"><div className="text-sm text-gray-500">Address</div><div className="font-medium">{viewCustomer.address || '-'}</div></div>
              </div>

              <div className="border-t pt-4 mb-4">
                <h3 className="text-lg font-semibold mb-3">Service Dates</h3>
                <div className="grid grid-cols-2 gap-4">
                  <div className="p-3 bg-blue-50 rounded">
                    <div className="text-sm text-gray-600">Last Service Date</div>
                    <div className="font-medium text-lg">{viewCustomer.last_service_date ? new Date(viewCustomer.last_service_date).toLocaleDateString() : 'Not available'}</div>
                  </div>
                  <div className="p-3 bg-green-50 rounded">
                    <div className="text-sm text-gray-600">Next Service Date</div>
                    <div className="font-medium text-lg">{viewCustomer.next_service_date ? new Date(viewCustomer.next_service_date).toLocaleDateString() : 'Not available'}</div>
                  </div>
                </div>
              </div>

              <div className="border-t pt-4">
                <h3 className="text-lg font-semibold mb-3">Call Log</h3>
                <div className="space-y-3">
                  <div className="max-h-72 overflow-y-auto">
                    {callNotes.length === 0 ? (
                      <div className="text-sm text-gray-500 p-3">No call notes yet</div>
                    ) : (
                      callNotes.map((n, idx) => (
                        <div key={idx} className="p-3 border rounded bg-gray-50 mb-2">
                          <div className="text-xs text-gray-500">{new Date(n.created_at).toLocaleString()}</div>
                          <div className="mt-1 text-sm">{n.note || n.notes || n.description}</div>
                        </div>
                      ))
                    )}
                  </div>
                  <div className="text-xs text-blue-600 text-center mt-2">ðŸ’¡ Add call logs from the Reminders section</div>
                </div>
              </div>
            </Modal>
          )}

          {/* Delete Confirmation Modal */}
          {showDeleteConfirm && (
            <ConfirmModal
              title="Delete Customer"
              message="Are you sure you want to delete this customer? This action cannot be undone."
              onConfirm={confirmDelete}
              onCancel={cancelDelete}
              loading={deleting}
            />
          )}
        </div>
      );
    }
    // ------------------ end Customers ------------------

    // ------------------ Reminders component ------------------
    function Reminders() {
      const [customers, setCustomers] = useState([]);
      const [reminderStart, setReminderStart] = useState(() => {
        const d = new Date();
        d.setDate(d.getDate()); // today
        return d.toISOString().split('T')[0];
      });
      const [reminderEnd, setReminderEnd] = useState(() => {
        const d = new Date();
        d.setDate(d.getDate() + 7); // 7 days from today
        return d.toISOString().split('T')[0];
      });
      const [page, setPage] = useState(1);
      const pageSize = 12;

      // Loading states
      const [loadingCustomers, setLoadingCustomers] = useState(false);
      const [loadingServiceHistory, setLoadingServiceHistory] = useState(false);
      const [loadingCallLogs, setLoadingCallLogs] = useState(false);
      const [addingCallNote, setAddingCallNote] = useState(false);

      // service history modal
      const [showServiceHistory, setShowServiceHistory] = useState(false);
      const [serviceHistory, setServiceHistory] = useState([]);

      // call logs modal
      const [showCallLogs, setShowCallLogs] = useState(false);
      const [callLogs, setCallLogs] = useState([]);
      const [callLogsCustomer, setCallLogsCustomer] = useState(null);
      const [newCallNote, setNewCallNote] = useState('');

      useEffect(() => { loadCustomers(); }, []);

      const loadCustomers = async () => {
        setLoadingCustomers(true);
        try {
          const data = await apiCall('/customers');
          setCustomers(data || []);
          setPage(1);
        } catch (err) { console.error(err); }
        finally { setLoadingCustomers(false); }
      };

      const getReminders = () => {
        const list = (customers || []).map(c => ({ id: c.id, name: c.name, phone: c.phone, next_service_date: c.next_service_date })).filter(i => i.next_service_date);
        if (reminderStart && reminderEnd) {
          const s = new Date(reminderStart); s.setHours(0,0,0,0);
          const e = new Date(reminderEnd); e.setHours(23,59,59,999);
          return list.filter(i => { const d = new Date(i.next_service_date); return d >= s && d <= e; });
        }
        return list;
      };

      const openServiceHistory = async (customer) => {
        setLoadingServiceHistory(true);
        try {
          const data = await apiCall(`/customers/${customer.id}/service-history`);
          setServiceHistory(data || []);
        } catch (err) {
          console.warn('service history not available', err);
          setServiceHistory([]);
        }
        finally { setLoadingServiceHistory(false); setShowServiceHistory(true); }
      };

      const openCallLogs = async (customer) => {
        setLoadingCallLogs(true);
        try {
          const data = await apiCall(`/customers/${customer.id}/call-logs`);
          setCallLogs(data || []);
        } catch (err) {
          console.warn('call logs not available', err);
          setCallLogs([]);
        }
        finally { setLoadingCallLogs(false); setCallLogsCustomer(customer); setShowCallLogs(true); }
      };

      const addCallNote = async () => {
        if (!newCallNote.trim() || !callLogsCustomer) return;
        setAddingCallNote(true);
        const note = { note: newCallNote.trim(), created_at: new Date().toISOString() };
        setCallLogs(prev => [note, ...prev]);
        setNewCallNote('');
        try {
          await apiCall(`/customers/${callLogsCustomer.id}/call-logs`, { method: 'POST', body: JSON.stringify(note) });
        } catch (e) {
          console.warn('Failed to persist call note', e);
        }
        finally { setAddingCallNote(false); }
      };

      const reminders = getReminders();
      const totalPages = Math.max(1, Math.ceil(reminders.length / pageSize));
      const pagedReminders = reminders.slice((page-1)*pageSize, page*pageSize);

      return (
        <div>
          <div className="mb-6">
            <h1 className="text-3xl font-bold text-gray-800 mb-4">Reminders - Service Due</h1>
            <div className="bg-white rounded-lg shadow p-4 flex items-center justify-between flex-wrap gap-3">
              <div className="flex items-center gap-3">
                <label className="text-sm font-medium">Start Date</label>
                <input type="date" value={reminderStart} onChange={e => { setReminderStart(e.target.value); setPage(1); }} className="px-3 py-2 border rounded" />
                <label className="text-sm font-medium">End Date</label>
                <input type="date" value={reminderEnd} onChange={e => { setReminderEnd(e.target.value); setPage(1); }} className="px-3 py-2 border rounded" />
                <button onClick={() => { 
                  const d = new Date();
                  setReminderStart(d.toISOString().split('T')[0]);
                  setReminderEnd(new Date(d.getTime() + 7*24*60*60*1000).toISOString().split('T')[0]);
                  setPage(1);
                }} className="px-3 py-2 bg-gray-200 rounded hover:bg-gray-300">Reset (7 days)</button>
              </div>
              <div className="text-sm font-medium text-blue-600">Total: {reminders.length} reminders</div>
            </div>
          </div>

          <div className="bg-white rounded-lg shadow overflow-hidden">
            <SectionLoader loading={loadingCustomers} message="Loading reminders...">
              <div className="w-full overflow-x-auto">
                <table className="min-w-[900px] w-full table-auto">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Name</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Phone</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Next Service Date</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-200">
                    {pagedReminders.map(r => {
                      const serviceDate = new Date(r.next_service_date);
                      const today = new Date();
                      today.setHours(0,0,0,0);
                      const daysUntil = Math.ceil((serviceDate.getTime() - today.getTime()) / (1000*60*60*24));
                      const isPast = daysUntil < 0;
                      const statusText = isPast ? `Overdue for ${Math.abs(daysUntil)} days` : `Upcoming service in ${daysUntil} days`;
                      const statusColor = isPast ? 'bg-red-100 text-red-800' : 'bg-blue-100 text-blue-800';

                      return (
                        <tr key={r.id} className={`${isPast ? 'bg-red-50 hover:bg-red-100' : 'hover:bg-gray-50'}`}>
                          <td className="px-6 py-4 whitespace-nowrap">
                            <div className="flex items-center gap-2">
                              {/* service history */}
                              <button
                                title="Service History"
                                onClick={() => { const c = customers.find(x=>x.id===r.id); if(c) openServiceHistory(c); }}
                                className="text-indigo-600 hover:text-indigo-800">
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                  <path d="M8 2a1 1 0 011 1v1h2V3a1 1 0 112 0v1h1a2 2 0 012 2v1H3V6a2 2 0 012-2h1V3a1 1 0 011-1z" />
                                  <path d="M3 9h14v6a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" />
                                </svg>
                              </button>

                              {/* call logs */}
                              <button
                                title="Call Logs"
                                onClick={() => { const c = customers.find(x=>x.id===r.id); if(c) openCallLogs(c); }}
                                className="text-green-600 hover:text-green-800">
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                  <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773c.058.3.102.605.102.92v1.972c0 .78.545 1.437 1.276 1.782.58.305 1.316.309 1.896 0 .76-.397 1.276-1.002 1.276-1.782V8.004c0-.315.044-.62.102-.92l-1.548-.773a1 1 0 01-.54-1.06l.74-4.435A1 1 0 0110.848 2h2.153a1 1 0 011 1v2a1 1 0 11-2 0V3h-2v2a1 1 0 11-2 0V3H4v2a1 1 0 11-2 0V3z" />
                                </svg>
                              </button>
                            </div>
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap font-medium">{r.name}</td>
                          <td className="px-6 py-4 whitespace-nowrap"><a href={`tel:${r.phone}`} className="text-blue-600 hover:underline">{r.phone}</a></td>
                          <td className="px-6 py-4 whitespace-nowrap">{serviceDate.toLocaleDateString()}</td>
                          <td className="px-6 py-4 whitespace-nowrap">
                            <span className={`px-3 py-1 rounded-full text-sm font-medium ${statusColor}`}>
                              {statusText}
                            </span>
                          </td>
                        </tr>
                      );
                    })}
                  </tbody>
                </table>
              </div>
            </SectionLoader>
          </div>

          {/* pagination */}
          <div className="flex items-center justify-between mt-3">
            <div className="text-sm text-gray-600">Showing {reminders.length === 0 ? 0 : ((page-1)*pageSize+1)} - {Math.min(page*pageSize, reminders.length)} of {reminders.length} reminders</div>
            <div className="flex items-center gap-2">
              <button disabled={page<=1} onClick={() => setPage(p => Math.max(1, p-1))} className="px-3 py-1 border rounded disabled:opacity-50">Prev</button>
              <div className="px-3 py-1 border rounded">{page}/{totalPages}</div>
              <button disabled={page>=totalPages} onClick={() => setPage(p => Math.min(totalPages, p+1))} className="px-3 py-1 border rounded disabled:opacity-50">Next</button>
            </div>
          </div>

          {/* Service History Modal */}
          {showServiceHistory && (
            <Modal onClose={() => { setShowServiceHistory(false); setServiceHistory([]); }} wide={true}>
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-2xl font-bold">Service History</h2>
                <button onClick={() => window.print()} className="px-3 py-2 bg-gray-200 rounded">Print</button>
              </div>
              <SectionLoader loading={loadingServiceHistory} message="Loading service history...">
                <div className="space-y-4">
                  {serviceHistory.length === 0 ? (
                    <div className="text-gray-500">No service history available.</div>
                  ) : (
                    serviceHistory.map((s, i) => (
                      <div key={i} className="p-4 border rounded bg-white shadow-sm">
                        <div className="flex justify-between items-start mb-3">
                          <div className="flex-1">
                            <div className="font-semibold text-lg">{s.job_number}</div>
                            <div className="text-sm text-gray-600">
                              {s.created_at && new Date(s.created_at).toLocaleDateString('en-IN', {
                                year: 'numeric', month: 'long', day: 'numeric'
                              })}
                            </div>
                          </div>
                          <div className="text-right">
                            <span className={`px-2 py-1 text-xs rounded ${s.status === 'closed' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}`}>
                              {s.status}
                            </span>
                          </div>
                        </div>

                        {s.tasks && s.tasks.length > 0 && (
                          <div className="mb-3">
                            <div className="text-sm font-medium text-gray-700 mb-1">Services Performed:</div>
                            <ul className="list-disc list-inside text-sm text-gray-600">
                              {s.tasks.map((task, idx) => (
                                <li key={idx}>{task.task_description}</li>
                              ))}
                            </ul>
                          </div>
                        )}

                        {s.stock_items && s.stock_items.length > 0 && (
                          <div className="mb-3">
                            <div className="text-sm font-medium text-gray-700 mb-1">Parts Used:</div>
                            <div className="text-sm text-gray-600">
                              {s.stock_items.map((item, idx) => (
                                <div key={idx}>â€¢ {item.product_name} (Qty: {item.quantity})</div>
                              ))}
                            </div>
                          </div>
                        )}

                        {s.bills && s.bills.length > 0 && (
                          <div className="mt-3 pt-3 border-t">
                            <div className="text-sm font-medium text-gray-700 mb-2">Bills:</div>
                            {s.bills.map((bill, idx) => (
                              <div key={idx} className="flex justify-between items-center bg-gray-50 p-2 rounded mb-2">
                                <div>
                                  <div className="font-medium text-sm">{bill.bill_number}</div>
                                  <div className="text-xs text-gray-600">
                                    {new Date(bill.bill_date).toLocaleDateString('en-IN')} â€¢ â‚¹{bill.total.toFixed(2)}
                                  </div>
                                </div>
                                <div className="flex gap-2 items-center">
                                  <span className={`px-2 py-0.5 text-xs rounded ${bill.payment_status === 'paid' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'}`}>
                                    {bill.payment_status.toUpperCase()}
                                  </span>
                                  <button
                                    onClick={() => {
                                      const token = localStorage.getItem('token');
                                      const url = `${API_URL}/bills/${bill.id}/view?token=${encodeURIComponent(token)}`;
                                      window.open(url, '_blank');
                                    }}
                                    className="px-2 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700"
                                  >
                                    View Bill
                                  </button>
                                </div>
                              </div>
                            ))}
                          </div>
                        )}

                        {s.notes && (
                          <div className="mt-3 pt-3 border-t">
                            <div className="text-sm text-gray-600">
                              <strong>Notes:</strong> {s.notes}
                            </div>
                          </div>
                        )}
                      </div>
                    ))
                  )}
                </div>
              </SectionLoader>
            </Modal>
          )}

          {/* Call Logs Modal */}
          {showCallLogs && callLogsCustomer && (
            <Modal onClose={() => { setShowCallLogs(false); setCallLogsCustomer(null); setCallLogs([]); setNewCallNote(''); }} wide={false}>
              <h2 className="text-2xl font-bold mb-4">Call Logs - {callLogsCustomer.name}</h2>
              <div className="space-y-3">
                <div className="bg-blue-50 p-3 rounded border border-blue-200">
                  <label className="text-sm font-medium block mb-2">Add New Call Log</label>
                  <div className="flex gap-2">
                    <input
                      value={newCallNote}
                      onChange={e => setNewCallNote(e.target.value)}
                      placeholder="Enter call notes..."
                      className="flex-1 px-3 py-2 border rounded"
                      disabled={addingCallNote}
                    />
                    <ButtonLoader
                      loading={addingCallNote}
                      onClick={addCallNote}
                      className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                      Add
                    </ButtonLoader>
                  </div>
                </div>

                <div className="border-t pt-3">
                  <h3 className="text-sm font-semibold mb-2">Call History</h3>
                  <SectionLoader loading={loadingCallLogs} message="Loading call logs...">
                    <div className="max-h-96 overflow-y-auto">
                      {callLogs.length === 0 ? (
                        <div className="text-sm text-gray-500 p-3">No call logs yet</div>
                      ) : (
                        callLogs.map((log, idx) => (
                          <div key={idx} className="p-3 border rounded bg-gray-50 mb-2">
                            <div className="text-xs text-gray-500">{new Date(log.created_at).toLocaleString()}</div>
                            <div className="text-sm text-gray-600 mt-1">By: {log.created_by || 'Unknown'}</div>
                            <div className="mt-2 text-sm">{log.note || log.notes}</div>
                          </div>
                        ))
                      )}
                    </div>
                  </SectionLoader>
                </div>
              </div>
            </Modal>
          )}
        </div>
      );
    }
    // ------------------ end Reminders ------------------

    function Dashboard() {
      const [stats, setStats] = useState(null);
      const [loadingStats, setLoadingStats] = useState(false);

      useEffect(() => {
        (async () => {
          setLoadingStats(true);
          try {
            const d = await apiCall('/dashboard/stats');
            setStats(d);
          } catch (e) {
            console.error(e);
          } finally {
            setLoadingStats(false);
          }
        })();
      }, []);

      return (
        <div>
          <div className="flex items-center justify-between mb-6">
            <h1 className="text-3xl font-bold">Dashboard</h1>
            <div className="text-sm text-gray-600">Welcome back â€” {new Date().toLocaleDateString()}</div>
          </div>

          <SectionLoader loading={loadingStats} message="Loading dashboard statistics...">
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
              <div className="bg-white p-6 rounded-lg shadow-lg">
                <div className="flex items-center justify-between">
                  <div>
                    <div className="text-sm text-gray-500">Today's Sales</div>
                    <div className="text-2xl font-bold mt-1">â‚¹{(stats?.today_sales ?? 0).toFixed(2)}</div>
                  </div>
                  <div className="text-3xl">ðŸ’°</div>
                </div>
                <div className="mt-4 text-sm text-gray-500">Transactions: {stats?.today_transactions ?? 0}</div>
              </div>

              <div className="bg-white p-6 rounded-lg shadow-lg">
                <div className="flex items-center justify-between">
                  <div>
                    <div className="text-sm text-gray-500">Total Customers</div>
                    <div className="text-2xl font-bold mt-1">{stats?.total_customers ?? 0}</div>
                  </div>
                  <div className="text-3xl">ðŸ‘¥</div>
                </div>
                <div className="mt-4 text-sm text-gray-500">Active services: {stats?.active_services ?? 0}</div>
              </div>

              <div className="bg-white p-6 rounded-lg shadow-lg">
                <div className="flex items-center justify-between">
                  <div>
                    <div className="text-sm text-gray-500">Low Stock Items</div>
                    <div className="text-2xl font-bold mt-1">{stats?.low_stock_items ?? 0}</div>
                  </div>
                  <div className="text-3xl">âš ï¸</div>
                </div>
                <div className="mt-4 text-sm text-gray-500">Monthly Sales: â‚¹{(stats?.monthly_sales ?? 0).toFixed(2)}</div>
              </div>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div className="bg-white p-6 rounded-lg shadow-lg">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-lg font-bold">Upcoming Services (Next 7 days)</h3>
                  <div className="text-sm text-gray-500">{stats?.upcoming_count ?? 0} customers</div>
                </div>
                {stats?.upcoming_services && stats.upcoming_services.length > 0 ? (
                  <div className="space-y-3">
                    {stats.upcoming_services.slice(0,10).map(s => (
                      <div key={s.id} className="p-3 border rounded flex justify-between items-center">
                        <div>
                          <div className="font-medium">{s.name}</div>
                          <div className="text-sm text-gray-500">{s.phone} â€¢ {new Date(s.next_service_date).toLocaleDateString()}</div>
                        </div>
                        <div className="text-sm text-blue-600">View</div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="text-sm text-gray-500">No upcoming services in next 7 days</div>
                )}
              </div>

              <div className="bg-white p-6 rounded-lg shadow-lg">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="text-lg font-bold">Overdue Services (Past 7 days)</h3>
                  <div className="text-sm text-gray-500">{stats?.overdue_count ?? 0} customers</div>
                </div>
                {stats?.overdue_services && stats.overdue_services.length > 0 ? (
                  <div className="space-y-3">
                    {stats.overdue_services.slice(0,10).map(s => (
                      <div key={s.id} className="p-3 border rounded flex justify-between items-center">
                        <div>
                          <div className="font-medium">{s.name}</div>
                          <div className="text-sm text-gray-500">{s.phone} â€¢ {new Date(s.next_service_date).toLocaleDateString()}</div>
                        </div>
                        <div className="text-sm text-red-600">Overdue</div>
                      </div>
                    ))}
                  </div>
                ) : (
                  <div className="text-sm text-gray-500">No overdue services in past 7 days</div>
                )}
              </div>
            </div>
          </SectionLoader>
        </div>
      );
    }

    // Products Component - Transaction-based inventory
    function Products() {
      const [products, setProducts] = useState([]);
      const [filteredProducts, setFilteredProducts] = useState([]);
      const [showForm, setShowForm] = useState(false);
      const [editing, setEditing] = useState(null);
      const [showView, setShowView] = useState(false);
      const [viewProduct, setViewProduct] = useState(null);
      const [searchTerm, setSearchTerm] = useState('');
      const [rackFilter, setRackFilter] = useState('');
      const [allRacks, setAllRacks] = useState([]);
      const [showPurchase, setShowPurchase] = useState(false);
      const [purchaseProduct, setPurchaseProduct] = useState(null);
      const [showHistory, setShowHistory] = useState(false);
      const [historyProduct, setHistoryProduct] = useState(null);
      const [transactions, setTransactions] = useState([]);

      // Loading states
      const [loadingProducts, setLoadingProducts] = useState(false);
      const [submitting, setSubmitting] = useState(false);
      const [deleting, setDeleting] = useState(false);
      const [showDeleteConfirm, setShowDeleteConfirm] = useState(false);
      const [deleteId, setDeleteId] = useState(null);

      const initialForm = {
        name: '',
        sell_price: '',
        rack_id: '',
        additional_info: ''
      };

      const initialPurchaseForm = {
        quantity: '',
        unit_cost: '',
        reference_no: '',
        notes: ''
      };

      const [form, setForm] = useState(initialForm);
      const [purchaseForm, setPurchaseForm] = useState(initialPurchaseForm);

      useEffect(() => { loadProducts(); }, []);

      useEffect(() => {
        filterProducts();
      }, [products, searchTerm, rackFilter]);

      const loadProducts = async () => {
        setLoadingProducts(true);
        try {
          const data = await apiCall('/products');
          setProducts(data);

          // Extract unique rack IDs
          const racks = [...new Set(data.map(p => p.rack_id).filter(r => r))].sort();
          setAllRacks(racks);
        } catch (err) { console.error(err); }
        finally { setLoadingProducts(false); }
      };

      const filterProducts = () => {
        let filtered = products;

        // Filter by search term (name)
        if (searchTerm.trim()) {
          const term = searchTerm.toLowerCase();
          filtered = filtered.filter(p => 
            p.name.toLowerCase().includes(term)
          );
        }

        // Filter by rack
        if (rackFilter) {
          filtered = filtered.filter(p => p.rack_id === rackFilter);
        }

        setFilteredProducts(filtered);
      };

      const validateForm = () => {
        if (!form.name.trim()) { alert('Product name is required'); return false; }
        if (!form.sell_price || isNaN(form.sell_price) || parseFloat(form.sell_price) <= 0) {
          alert('Sell price is required and must be a positive number'); return false;
        }
        if (!form.quantity || isNaN(form.quantity) || parseInt(form.quantity) < 0) {
          alert('Quantity is required and must be a non-negative number'); return false;
        }
        if (!form.purchase_price || isNaN(form.purchase_price) || parseFloat(form.purchase_price) <= 0) {
          alert('Purchase price is required and must be a positive number'); return false;
        }
        return true;
      };

      const openCreate = () => { setEditing(null); setForm(initialForm); setShowForm(true); };
      const openEdit = (p) => {
        setEditing(p);
        setForm({
          name: p.name ?? '',
          sell_price: p.sell_price ?? '',
          quantity: p.quantity ?? '',
          purchase_price: p.purchase_price ?? '',
          rack_id: p.rack_id ?? '',
          additional_info: p.additional_info ?? ''
        });
        setShowForm(true);
      };

      const handleSubmit = async (e) => {
        e.preventDefault();
        if (!validateForm()) return;
        setSubmitting(true);
        try {
          const payload = {
            name: form.name,
            sell_price: parseFloat(form.sell_price),
            quantity: parseInt(form.quantity),
            purchase_price: parseFloat(form.purchase_price),
            rack_id: form.rack_id || null,
            additional_info: form.additional_info || null
          };
          if (editing) {
            await apiCall(`/products/${editing.id}`, { method: 'PUT', body: JSON.stringify(payload) });
          } else {
            await apiCall('/products', { method: 'POST', body: JSON.stringify(payload) });
          }
          setShowForm(false); setEditing(null); setForm(initialForm); loadProducts();
        } catch (err) { alert(err.message); }
        finally { setSubmitting(false); }
      };

      const handleDelete = async (id) => { setDeleteId(id); setShowDeleteConfirm(true); };

      const confirmDelete = async () => {
        setDeleting(true);
        try { await apiCall(`/products/${deleteId}`, { method: 'DELETE' }); loadProducts(); } catch (err) { alert(err.message); }
        finally { setDeleting(false); setShowDeleteConfirm(false); setDeleteId(null); }
      };

      const cancelDelete = () => { setShowDeleteConfirm(false); setDeleteId(null); };

      const handleView = (product) => { setViewProduct(product); setShowView(true); };

      const calculateTotals = (product) => {
        const totalPurchasePrice = parseFloat(product.purchase_price) * parseInt(product.quantity);
        const expectedTotalSellPrice = parseFloat(product.sell_price) * parseInt(product.quantity);
        const potentialProfit = expectedTotalSellPrice - totalPurchasePrice;
        return { totalPurchasePrice, expectedTotalSellPrice, potentialProfit };
      };

      const clearFilters = () => {
        setSearchTerm('');
        setRackFilter('');
      };

      return (
        <div>
          <div className="flex justify-between items-center mb-4">
            <h1 className="text-3xl font-bold text-gray-800">Products & Inventory</h1>
            <button onClick={openCreate} className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700">+ Add Product</button>
          </div>

          {/* New System Banner */}
          <div className="bg-gradient-to-r from-green-500 to-blue-500 rounded-lg p-4 mb-6 text-white shadow-lg">
            <div className="flex items-center justify-between">
              <div>
                <h3 className="font-bold text-lg mb-1">âœ¨ New: Advanced Stock Management Available!</h3>
                <p className="text-sm">Track multiple purchases at different prices â€¢ Weighted average costing â€¢ Document management â€¢ Complete audit trail</p>
              </div>
              <a 
                href="#" 
                onClick={(e) => { e.preventDefault(); window.location.href = '/test.html'; }} 
                className="bg-white text-blue-600 px-6 py-2 rounded-lg hover:bg-gray-100 font-bold whitespace-nowrap ml-4"
              >
                Open Stock Management â†’
              </a>
            </div>
          </div>

          {/* Search and Filter Bar */}
          <div className="bg-white rounded-lg shadow p-4 mb-6">
            <div className="flex flex-wrap gap-4 items-end">
              <div className="flex-1 min-w-[250px]">
                <label className="block text-sm font-medium text-gray-700 mb-1">Search Products</label>
                <input
                  type="text"
                  value={searchTerm}
                  onChange={e => setSearchTerm(e.target.value)}
                  placeholder="Search by product name..."
                  className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                />
              </div>
              
              <div className="min-w-[200px]">
                <label className="block text-sm font-medium text-gray-700 mb-1">Filter by Rack</label>
                <select
                  value={rackFilter}
                  onChange={e => setRackFilter(e.target.value)}
                  className="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500"
                >
                  <option value="">All Racks</option>
                  {allRacks.map(rack => (
                    <option key={rack} value={rack}>{rack}</option>
                  ))}
                </select>
              </div>

              {(searchTerm || rackFilter) && (
                <button
                  onClick={clearFilters}
                  className="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600"
                >
                  Clear Filters
                </button>
              )}

              <div className="text-sm text-gray-600 py-2">
                Showing {filteredProducts.length} of {products.length} products
              </div>
            </div>
          </div>

          <div className="bg-white rounded-lg shadow overflow-hidden">
            <SectionLoader loading={loadingProducts} message="Loading products...">
              <div className="w-full overflow-x-auto">
                <table className="min-w-[1100px] w-full table-auto">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Product Name</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Unit Sell Price (â‚¹)</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Quantity</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Unit Purchase Price (â‚¹)</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total Purchase (â‚¹)</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Expected Total Sell (â‚¹)</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Rack ID</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-200">
                    {filteredProducts.map(p => {
                      const { totalPurchasePrice, expectedTotalSellPrice } = calculateTotals(p);
                      return (
                        <tr key={p.id} className="hover:bg-gray-50">
                          <td className="px-6 py-4 whitespace-nowrap">
                            <div className="flex items-center gap-3">
                              <button title="View" onClick={() => handleView(p)} className="text-gray-600 hover:text-gray-900">
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M2.458 12C3.732 7.943 7.523 5 12 5s8.268 2.943 9.542 7c-1.274 4.057-5.065 7-9.542 7S3.732 16.057 2.458 12z" />
                                </svg>
                              </button>
                              <button title="Edit" onClick={() => openEdit(p)} className="text-blue-600 hover:text-blue-800">
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                  <path d="M17.414 2.586a2 2 0 010 2.828L8.414 14.414a1 1 0 01-.464.263l-4 1a1 1 0 01-1.213-1.213l1-4a1 1 0 01.263-.464L14.586 2.586a2 2 0 012.828 0z" />
                                </svg>
                              </button>
                              <button title="Delete" onClick={() => handleDelete(p.id)} className="text-red-600 hover:text-red-800">
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                  <path fillRule="evenodd" d="M6 2a1 1 0 00-1 1v1H3a1 1 0 100 2h14a1 1 0 100-2h-2V3a1 1 0 00-1-1H6zm2 6a1 1 0 10-2 0v7a1 1 0 102 0V8zm6 0a1 1 0 10-2 0v7a1 1 0 102 0V8z" clipRule="evenodd" />
                                </svg>
                              </button>
                            </div>
                          </td>
                          <td className="px-6 py-4 whitespace-nowrap max-w-xs overflow-hidden text-ellipsis font-medium">{p.name}</td>
                          <td className="px-6 py-4 whitespace-nowrap">â‚¹{parseFloat(p.sell_price).toFixed(2)}</td>
                          <td className="px-6 py-4 whitespace-nowrap">{p.quantity}</td>
                          <td className="px-6 py-4 whitespace-nowrap">â‚¹{parseFloat(p.purchase_price).toFixed(2)}</td>
                          <td className="px-6 py-4 whitespace-nowrap font-medium text-orange-600">â‚¹{totalPurchasePrice.toFixed(2)}</td>
                          <td className="px-6 py-4 whitespace-nowrap font-medium text-green-600">â‚¹{expectedTotalSellPrice.toFixed(2)}</td>
                          <td className="px-6 py-4 whitespace-nowrap">{p.rack_id || '-'}</td>
                        </tr>
                      );
                    })}
                    {filteredProducts.length === 0 && (
                      <tr>
                        <td colSpan="9" className="px-6 py-8 text-center text-gray-500">
                          No products found. {searchTerm || rackFilter ? 'Try adjusting your filters.' : 'Add your first product to get started.'}
                        </td>
                      </tr>
                    )}
                  </tbody>
                </table>
              </div>
            </SectionLoader>
          </div>

          {/* Create / Edit Modal */}
          {showForm && (
            <Modal onClose={() => { setShowForm(false); setEditing(null); }} wide={false}>
              <h2 className="text-2xl font-bold mb-4">{editing ? 'Edit Product' : 'Add Product'}</h2>
              <form onSubmit={handleSubmit}>
                <div className="grid grid-cols-2 gap-4">
                  <div className="col-span-2">
                    <label className="block text-sm font-medium mb-1">Product Name *</label>
                    <input type="text" value={form.name} onChange={e => setForm(prev => ({ ...prev, name: e.target.value }))} className="w-full px-3 py-2 border rounded" required />
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-1">Unit Sell Price (â‚¹) *</label>
                    <input type="number" step="0.01" min="0" value={form.sell_price} onChange={e => setForm(prev => ({ ...prev, sell_price: e.target.value }))} className="w-full px-3 py-2 border rounded" required />
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-1">Quantity *</label>
                    <input type="number" min="0" value={form.quantity} onChange={e => setForm(prev => ({ ...prev, quantity: e.target.value }))} className="w-full px-3 py-2 border rounded" required />
                  </div>

                  <div>
                    <label className="block text-sm font-medium mb-1">Unit Purchase Price (â‚¹) *</label>
                    <input type="number" step="0.01" min="0" value={form.purchase_price} onChange={e => setForm(prev => ({ ...prev, purchase_price: e.target.value }))} className="w-full px-3 py-2 border rounded" required />
                  </div>

                  <div className="col-span-2">
                    <label className="block text-sm font-medium mb-1">Rack ID</label>
                    <input type="text" value={form.rack_id} onChange={e => setForm(prev => ({ ...prev, rack_id: e.target.value }))} className="w-full px-3 py-2 border rounded" placeholder="e.g., A-1, B-2" />
                  </div>

                  {/* Show calculated totals if editing or if values entered */}
                  {(form.sell_price && form.quantity && form.purchase_price) && (
                    <div className="col-span-2 bg-gray-50 p-4 rounded-lg">
                      <div className="text-sm font-medium text-gray-700 mb-2">Calculated Values:</div>
                      <div className="grid grid-cols-2 gap-3 text-sm">
                        <div>
                          <span className="text-gray-600">Total Purchase Price:</span>
                          <span className="ml-2 font-medium text-orange-600">â‚¹{(parseFloat(form.purchase_price || 0) * parseInt(form.quantity || 0)).toFixed(2)}</span>
                        </div>
                        <div>
                          <span className="text-gray-600">Expected Total Sell Price:</span>
                          <span className="ml-2 font-medium text-green-600">â‚¹{(parseFloat(form.sell_price || 0) * parseInt(form.quantity || 0)).toFixed(2)}</span>
                        </div>
                        <div className="col-span-2">
                          <span className="text-gray-600">Potential Profit:</span>
                          <span className="ml-2 font-medium text-blue-600">â‚¹{((parseFloat(form.sell_price || 0) * parseInt(form.quantity || 0)) - (parseFloat(form.purchase_price || 0) * parseInt(form.quantity || 0))).toFixed(2)}</span>
                        </div>
                      </div>
                    </div>
                  )}

                  <div className="col-span-2">
                    <label className="block text-sm font-medium mb-1">Additional Info</label>
                    <textarea value={form.additional_info} onChange={e => setForm(prev => ({ ...prev, additional_info: e.target.value }))} rows="3" className="w-full px-3 py-2 border rounded"></textarea>
                  </div>
                </div>

                <div className="flex justify-end gap-3 mt-4">
                  <button type="button" onClick={() => { setShowForm(false); setEditing(null); }} className="px-4 py-2 border rounded hover:bg-gray-50" disabled={submitting}>Cancel</button>
                  <ButtonLoader loading={submitting} type="submit" className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">{editing ? 'Update' : 'Create'}</ButtonLoader>
                </div>
              </form>
            </Modal>
          )}

          {/* View modal */}
          {showView && viewProduct && (
            <Modal onClose={() => { setShowView(false); setViewProduct(null); }} wide={false}>
              <h2 className="text-2xl font-bold mb-4">Product Details</h2>
              <div className="grid grid-cols-2 gap-4">
                <div className="col-span-2"><div className="text-sm text-gray-500">Product Name</div><div className="font-medium text-lg">{viewProduct.name}</div></div>
                
                <div className="col-span-2 bg-blue-50 p-3 rounded">
                  <div className="text-sm font-medium text-blue-800 mb-2">Pricing Information</div>
                  <div className="grid grid-cols-2 gap-3">
                    <div><div className="text-xs text-gray-600">Unit Sell Price</div><div className="font-medium">â‚¹{parseFloat(viewProduct.sell_price).toFixed(2)}</div></div>
                    <div><div className="text-xs text-gray-600">Quantity</div><div className="font-medium">{viewProduct.quantity}</div></div>
                    <div><div className="text-xs text-gray-600">Unit Purchase Price</div><div className="font-medium">â‚¹{parseFloat(viewProduct.purchase_price).toFixed(2)}</div></div>
                  </div>
                </div>

                <div className="col-span-2 bg-green-50 p-3 rounded">
                  <div className="text-sm font-medium text-green-800 mb-2">Total Values</div>
                  <div className="grid grid-cols-2 gap-3">
                    <div><div className="text-xs text-gray-600">Total Purchase Price</div><div className="font-medium text-orange-600">â‚¹{calculateTotals(viewProduct).totalPurchasePrice.toFixed(2)}</div></div>
                    <div><div className="text-xs text-gray-600">Expected Total Sell Price</div><div className="font-medium text-green-600">â‚¹{calculateTotals(viewProduct).expectedTotalSellPrice.toFixed(2)}</div></div>
                    <div className="col-span-2"><div className="text-xs text-gray-600">Potential Profit (Before Discount)</div><div className="font-medium text-blue-600">â‚¹{calculateTotals(viewProduct).potentialProfit.toFixed(2)}</div></div>
                  </div>
                </div>

                <div><div className="text-sm text-gray-500">Rack ID</div><div className="font-medium">{viewProduct.rack_id || '-'}</div></div>
                <div className="col-span-2"><div className="text-sm text-gray-500">Additional Info</div><div className="font-medium">{viewProduct.additional_info || '-'}</div></div>
                
                <div className="col-span-2 mt-2 p-3 bg-yellow-50 rounded">
                  <div className="text-xs text-yellow-800">
                    <strong>Note:</strong> Customer discounts can be applied during sales transactions. The expected total sell price shown is before any discounts.
                  </div>
                </div>
              </div>
            </Modal>
          )}

          {/* Delete Confirmation Modal */}
          {showDeleteConfirm && (
            <ConfirmModal
              title="Delete Product"
              message="Are you sure you want to delete this product? This action cannot be undone."
              onConfirm={confirmDelete}
              onCancel={cancelDelete}
              loading={deleting}
            />
          )}
        </div>
      );
    }


    function Sales() {
      const [mode, setMode] = useState(''); // 'jobcard' or 'direct'
      const [loading, setLoading] = useState(false);

      // Job Card mode states
      const [jobCards, setJobCards] = useState([]);
      const [searchTerm, setSearchTerm] = useState('');
      const [selectedJobCard, setSelectedJobCard] = useState(null);
      const [jobCardDetails, setJobCardDetails] = useState(null);

      // Direct Sell mode states
      const [customers, setCustomers] = useState([]);
      const [customerSearch, setCustomerSearch] = useState('');
      const [selectedCustomer, setSelectedCustomer] = useState(null);
      const [showNewCustomerForm, setShowNewCustomerForm] = useState(false);
      const [newCustomer, setNewCustomer] = useState({ name: '', email: '', phone: '', address: '' });

      // Common states for both modes
      const [products, setProducts] = useState([]);
      const [productSearch, setProductSearch] = useState('');
      const [selectedItems, setSelectedItems] = useState([]);
      const [showProductSearch, setShowProductSearch] = useState(false);
      const [discount, setDiscount] = useState(0);
      const [paymentMethod, setPaymentMethod] = useState('cash');
      const [showBillModal, setShowBillModal] = useState(false);
      const [billGenerated, setBillGenerated] = useState(false);

      // Fetch open job cards for Job Card mode
      const fetchJobCards = async () => {
        setLoading(true);
        try {
          const data = await apiCall('/job-cards?status=open');
          setJobCards(data);
        } catch (error) {
          console.error('Error fetching job cards:', error);
        }
        setLoading(false);
      };

      // Fetch customers for Direct Sell mode
      const fetchCustomers = async () => {
        setLoading(true);
        try {
          const data = await apiCall('/customers');
          setCustomers(data);
        } catch (error) {
          console.error('Error fetching customers:', error);
        }
        setLoading(false);
      };

      // Fetch products for stock selection
      const fetchProducts = async () => {
        try {
          const data = await apiCall('/products');
          setProducts(data);
        } catch (error) {
          console.error('Error fetching products:', error);
        }
      };

      // Load job card details when selected
      const loadJobCardDetails = async (jobCardId) => {
        setLoading(true);
        try {
          const data = await apiCall(`/job-cards/${jobCardId}`);
          setJobCardDetails(data);
          setSelectedJobCard(data);
        } catch (error) {
          console.error('Error fetching job card details:', error);
        }
        setLoading(false);
      };

      // Filter job cards by search term
      const filteredJobCards = jobCards.filter(jc =>
        jc.vehicle_number?.toLowerCase().includes(searchTerm.toLowerCase()) ||
        jc.customer_name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
        jc.customer_phone?.includes(searchTerm) ||
        jc.customer_email?.toLowerCase().includes(searchTerm.toLowerCase())
      );

      // Filter customers by search term
      const filteredCustomers = customers.filter(c =>
        c.name?.toLowerCase().includes(customerSearch.toLowerCase()) ||
        c.phone?.includes(customerSearch) ||
        c.email?.toLowerCase().includes(customerSearch.toLowerCase())
      );

      // Filter products by search term
      const filteredProducts = products.filter(p =>
        p.name?.toLowerCase().includes(productSearch.toLowerCase())
      );

      // Calculate available quantity for a product
      const getAvailableQuantity = (productId) => {
        const product = products.find(p => p.id === productId);
        return product?.quantity || 0;
      };

      // Add item to cart
      const addItem = (product) => {
        const existing = selectedItems.find(item => item.product_id === product.id);
        if (existing) {
          setSelectedItems(selectedItems.map(item =>
            item.product_id === product.id
              ? { ...item, quantity: item.quantity + 1 }
              : item
          ));
        } else {
          setSelectedItems([...selectedItems, {
            product_id: product.id,
            product_name: product.name,
            unit_price: product.sell_price,
            quantity: 1
          }]);
        }
        setShowProductSearch(false);
        setProductSearch('');
      };

      // Update item quantity
      const updateQuantity = (productId, quantity) => {
        if (quantity <= 0) {
          setSelectedItems(selectedItems.filter(item => item.product_id !== productId));
        } else {
          const available = getAvailableQuantity(productId);
          if (quantity > available) {
            alert(`Only ${available} units available in stock`);
            return;
          }
          setSelectedItems(selectedItems.map(item =>
            item.product_id === productId
              ? { ...item, quantity: parseInt(quantity) }
              : item
          ));
        }
      };

      // Update item price
      const updatePrice = (productId, price) => {
        setSelectedItems(selectedItems.map(item =>
          item.product_id === productId
            ? { ...item, unit_price: parseFloat(price) }
            : item
        ));
      };

      // Remove item from cart
      const removeItem = (productId) => {
        setSelectedItems(selectedItems.filter(item => item.product_id !== productId));
      };

      // Calculate totals
      const calculateTotals = () => {
        const subtotal = selectedItems.reduce((sum, item) => sum + (item.quantity * item.unit_price), 0);
        const discountAmount = discount || 0;
        const total = subtotal - discountAmount;
        return { subtotal, discountAmount, total };
      };

      // Create new customer for Direct Sell
      const createNewCustomer = async () => {
        if (!newCustomer.name || !newCustomer.phone) {
          alert('Name and phone are required');
          return;
        }
        setLoading(true);
        try {
          const created = await apiCall('/customers', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(newCustomer)
          });
          setSelectedCustomer(created);
          setShowNewCustomerForm(false);
          setNewCustomer({ name: '', email: '', phone: '', address: '' });
        } catch (error) {
          console.error('Error creating customer:', error);
          alert('Failed to create customer');
        }
        setLoading(false);
      };

      // Generate bill and complete sale
      const generateBill = async () => {
        if (selectedItems.length === 0) {
          alert('Please add at least one item');
          return;
        }

        const customerId = mode === 'jobcard' ? selectedJobCard?.customer_id : selectedCustomer?.id;
        if (!customerId) {
          alert('Please select a customer');
          return;
        }

        const { total } = calculateTotals();

        setLoading(true);
        try {
          const saleData = {
            customer_id: customerId,
            items: selectedItems,
            discount: discount || 0,
            tax: 0,
            payment_method: paymentMethod
          };

          await apiCall('/sales', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(saleData)
          });

          // If job card mode, mark job card as completed
          if (mode === 'jobcard' && selectedJobCard) {
            await apiCall(`/job-cards/${selectedJobCard.id}/complete`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                labour_charge: 0,
                discount: discount || 0
              })
            });
          }

          setBillGenerated(true);
          setShowBillModal(true);
        } catch (error) {
          console.error('Error generating bill:', error);
          alert('Failed to generate bill');
        }
        setLoading(false);
      };

      // Reset form
      const resetForm = () => {
        setMode('');
        setSelectedJobCard(null);
        setJobCardDetails(null);
        setSelectedCustomer(null);
        setSelectedItems([]);
        setDiscount(0);
        setPaymentMethod('cash');
        setBillGenerated(false);
        setShowBillModal(false);
        setSearchTerm('');
        setCustomerSearch('');
      };

      React.useEffect(() => {
        if (mode === 'jobcard') {
          fetchJobCards();
        } else if (mode === 'direct') {
          fetchCustomers();
        }
        fetchProducts();
      }, [mode]);

      // Mode Selection Screen
      if (!mode) {
        return (
          <div>
            <h1 className="text-3xl font-bold mb-6">Sales & Billing</h1>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <button
                onClick={() => setMode('jobcard')}
                className="bg-white rounded-lg p-8 shadow hover:shadow-lg transition-shadow border-2 border-transparent hover:border-blue-500"
              >
                <div className="text-6xl mb-4">ðŸ”§</div>
                <h2 className="text-2xl font-bold mb-2">Sell by Job Card</h2>
                <p className="text-gray-600">
                  Select from open job cards and complete the sale with stock items
                </p>
              </button>
              <button
                onClick={() => setMode('direct')}
                className="bg-white rounded-lg p-8 shadow hover:shadow-lg transition-shadow border-2 border-transparent hover:border-green-500"
              >
                <div className="text-6xl mb-4">ðŸ’°</div>
                <h2 className="text-2xl font-bold mb-2">Direct Sell</h2>
                <p className="text-gray-600">
                  Sell directly to any customer (registered or walk-in)
                </p>
              </button>
            </div>
          </div>
        );
      }

      // Common Bill Modal
      const BillModal = () => {
        const { subtotal, discountAmount, total } = calculateTotals();
        const customer = mode === 'jobcard' ? selectedJobCard : selectedCustomer;

        return (
          <Modal onClose={() => { setShowBillModal(false); if (billGenerated) resetForm(); }}>
            <div className="bg-white rounded-lg p-6 max-w-2xl w-full max-h-[90vh] overflow-auto">
              <h2 className="text-2xl font-bold mb-4 text-center">
                {billGenerated ? 'Bill Generated Successfully' : 'Bill Preview'}
              </h2>

              <div className="border-b pb-4 mb-4">
                <h3 className="font-bold text-lg mb-2">Customer Details</h3>
                <p><strong>Name:</strong> {customer?.name || customer?.customer_name}</p>
                <p><strong>Phone:</strong> {customer?.phone || customer?.customer_phone}</p>
                {mode === 'jobcard' && (
                  <p><strong>Vehicle:</strong> {customer?.vehicle_number}</p>
                )}
              </div>

              <div className="mb-4">
                <h3 className="font-bold text-lg mb-2">Items</h3>
                <table className="w-full">
                  <thead className="bg-gray-100">
                    <tr>
                      <th className="p-2 text-left">Product</th>
                      <th className="p-2 text-right">Qty</th>
                      <th className="p-2 text-right">Price</th>
                      <th className="p-2 text-right">Total</th>
                    </tr>
                  </thead>
                  <tbody>
                    {selectedItems.map(item => (
                      <tr key={item.product_id} className="border-b">
                        <td className="p-2">{item.product_name}</td>
                        <td className="p-2 text-right">{item.quantity}</td>
                        <td className="p-2 text-right">â‚¹{item.unit_price.toFixed(2)}</td>
                        <td className="p-2 text-right">â‚¹{(item.quantity * item.unit_price).toFixed(2)}</td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>

              <div className="border-t pt-4">
                <div className="flex justify-between mb-2">
                  <span>Subtotal:</span>
                  <span>â‚¹{subtotal.toFixed(2)}</span>
                </div>
                {discountAmount > 0 && (
                  <div className="flex justify-between mb-2 text-green-600">
                    <span>Discount:</span>
                    <span>- â‚¹{discountAmount.toFixed(2)}</span>
                  </div>
                )}
                <div className="flex justify-between font-bold text-xl border-t pt-2">
                  <span>Total:</span>
                  <span>â‚¹{total.toFixed(2)}</span>
                </div>
                <div className="flex justify-between mt-2">
                  <span>Payment Method:</span>
                  <span className="capitalize">{paymentMethod}</span>
                </div>
              </div>

              <div className="mt-6 flex gap-3">
                {!billGenerated ? (
                  <>
                    <button
                      onClick={() => setShowBillModal(false)}
                      className="flex-1 px-4 py-2 bg-gray-300 rounded hover:bg-gray-400"
                    >
                      Cancel
                    </button>
                    <button
                      onClick={generateBill}
                      disabled={loading}
                      className="flex-1 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 disabled:bg-gray-400"
                    >
                      {loading ? 'Processing...' : 'Confirm & Generate Bill'}
                    </button>
                  </>
                ) : (
                  <button
                    onClick={() => { setShowBillModal(false); resetForm(); }}
                    className="flex-1 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                  >
                    Done
                  </button>
                )}
              </div>
            </div>
          </Modal>
        );
      };

      // Job Card Selection Screen
      if (mode === 'jobcard' && !selectedJobCard) {
        return (
          <div>
            <div className="flex justify-between items-center mb-6">
              <h1 className="text-3xl font-bold">Sell by Job Card</h1>
              <button
                onClick={resetForm}
                className="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400"
              >
                Back
              </button>
            </div>

            <div className="bg-white rounded-lg p-6 shadow mb-6">
              <input
                type="text"
                placeholder="Search by vehicle number, customer name, phone, or email..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                className="w-full p-3 border rounded"
              />
            </div>

            {loading ? (
              <div className="text-center py-8"><Spinner /></div>
            ) : (
              <div className="grid grid-cols-1 gap-4">
                {filteredJobCards.length === 0 ? (
                  <div className="bg-white rounded-lg p-6 shadow text-center text-gray-500">
                    No open job cards found
                  </div>
                ) : (
                  filteredJobCards.map(jc => (
                    <div
                      key={jc.id}
                      className="bg-white rounded-lg p-6 shadow hover:shadow-lg transition-shadow cursor-pointer"
                      onClick={() => loadJobCardDetails(jc.id)}
                    >
                      <div className="flex justify-between items-start">
                        <div>
                          <h3 className="font-bold text-lg">{jc.job_number}</h3>
                          <p className="text-gray-600">Customer: {jc.customer_name}</p>
                          <p className="text-gray-600">Vehicle: {jc.vehicle_number}</p>
                          <p className="text-gray-600">Phone: {jc.customer_phone}</p>
                        </div>
                        <div className="text-right">
                          <span className="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">
                            {jc.status}
                          </span>
                          <p className="text-sm text-gray-500 mt-2">
                            {new Date(jc.created_at).toLocaleDateString()}
                          </p>
                        </div>
                      </div>
                    </div>
                  ))
                )}
              </div>
            )}
          </div>
        );
      }

      // Direct Sell - Customer Selection Screen
      if (mode === 'direct' && !selectedCustomer) {
        return (
          <div>
            <div className="flex justify-between items-center mb-6">
              <h1 className="text-3xl font-bold">Direct Sell - Select Customer</h1>
              <button
                onClick={resetForm}
                className="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400"
              >
                Back
              </button>
            </div>

            {!showNewCustomerForm ? (
              <>
                <div className="bg-white rounded-lg p-6 shadow mb-6">
                  <div className="flex gap-3">
                    <input
                      type="text"
                      placeholder="Search by customer name, phone, or email..."
                      value={customerSearch}
                      onChange={(e) => setCustomerSearch(e.target.value)}
                      className="flex-1 p-3 border rounded"
                    />
                    <button
                      onClick={() => setShowNewCustomerForm(true)}
                      className="px-6 py-3 bg-green-600 text-white rounded hover:bg-green-700"
                    >
                      New Customer
                    </button>
                  </div>
                </div>

                {loading ? (
                  <div className="text-center py-8"><Spinner /></div>
                ) : (
                  <div className="grid grid-cols-1 gap-4">
                    {filteredCustomers.map(customer => (
                      <div
                        key={customer.id}
                        className="bg-white rounded-lg p-6 shadow hover:shadow-lg transition-shadow cursor-pointer"
                        onClick={() => setSelectedCustomer(customer)}
                      >
                        <div className="flex justify-between items-start">
                          <div>
                            <h3 className="font-bold text-lg">{customer.name}</h3>
                            <p className="text-gray-600">Phone: {customer.phone}</p>
                            {customer.email && <p className="text-gray-600">Email: {customer.email}</p>}
                            {customer.vehicle_number && (
                              <p className="text-gray-600">Vehicle: {customer.vehicle_number}</p>
                            )}
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </>
            ) : (
              <div className="bg-white rounded-lg p-6 shadow">
                <h2 className="text-xl font-bold mb-4">Create New Customer</h2>
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-medium mb-1">Name *</label>
                    <input
                      type="text"
                      value={newCustomer.name}
                      onChange={(e) => setNewCustomer({...newCustomer, name: e.target.value})}
                      className="w-full p-2 border rounded"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-1">Phone *</label>
                    <input
                      type="tel"
                      value={newCustomer.phone}
                      onChange={(e) => setNewCustomer({...newCustomer, phone: e.target.value})}
                      className="w-full p-2 border rounded"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-1">Email</label>
                    <input
                      type="email"
                      value={newCustomer.email}
                      onChange={(e) => setNewCustomer({...newCustomer, email: e.target.value})}
                      className="w-full p-2 border rounded"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-1">Address</label>
                    <textarea
                      value={newCustomer.address}
                      onChange={(e) => setNewCustomer({...newCustomer, address: e.target.value})}
                      className="w-full p-2 border rounded"
                      rows="3"
                    />
                  </div>
                  <div className="flex gap-3">
                    <button
                      onClick={() => setShowNewCustomerForm(false)}
                      className="flex-1 px-4 py-2 bg-gray-300 rounded hover:bg-gray-400"
                    >
                      Cancel
                    </button>
                    <button
                      onClick={createNewCustomer}
                      disabled={loading}
                      className="flex-1 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:bg-gray-400"
                    >
                      {loading ? 'Creating...' : 'Create & Continue'}
                    </button>
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      }

      // Main Sales Screen (both modes after selection)
      const customer = mode === 'jobcard' ? selectedJobCard : selectedCustomer;
      const { subtotal, discountAmount, total } = calculateTotals();

      return (
        <div>
          <div className="flex justify-between items-center mb-6">
            <h1 className="text-3xl font-bold">
              {mode === 'jobcard' ? 'Job Card Sale' : 'Direct Sale'}
            </h1>
            <button
              onClick={resetForm}
              className="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400"
            >
              Cancel
            </button>
          </div>

          {/* Customer Info */}
          <div className="bg-white rounded-lg p-6 shadow mb-6">
            <h2 className="text-xl font-bold mb-3">Customer Information</h2>
            <div className="grid grid-cols-2 gap-4">
              <div>
                <p className="text-sm text-gray-600">Name</p>
                <p className="font-medium">{customer?.name || customer?.customer_name}</p>
              </div>
              <div>
                <p className="text-sm text-gray-600">Phone</p>
                <p className="font-medium">{customer?.phone || customer?.customer_phone}</p>
              </div>
              {mode === 'jobcard' && (
                <>
                  <div>
                    <p className="text-sm text-gray-600">Vehicle Number</p>
                    <p className="font-medium">{customer?.vehicle_number}</p>
                  </div>
                  <div>
                    <p className="text-sm text-gray-600">Job Card Number</p>
                    <p className="font-medium">{customer?.job_number}</p>
                  </div>
                </>
              )}
            </div>
          </div>

          {/* Stock Items */}
          <div className="bg-white rounded-lg p-6 shadow mb-6">
            <div className="flex justify-between items-center mb-4">
              <h2 className="text-xl font-bold">Stock Items</h2>
              <button
                onClick={() => setShowProductSearch(true)}
                className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
              >
                + Add Item
              </button>
            </div>

            {selectedItems.length === 0 ? (
              <p className="text-gray-500 text-center py-8">No items added yet</p>
            ) : (
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead className="bg-gray-100">
                    <tr>
                      <th className="p-3 text-left">Product</th>
                      <th className="p-3 text-right">Quantity</th>
                      <th className="p-3 text-right">Unit Price</th>
                      <th className="p-3 text-right">Total</th>
                      <th className="p-3"></th>
                    </tr>
                  </thead>
                  <tbody>
                    {selectedItems.map(item => (
                      <tr key={item.product_id} className="border-b">
                        <td className="p-3">{item.product_name}</td>
                        <td className="p-3 text-right">
                          <input
                            type="number"
                            value={item.quantity}
                            onChange={(e) => updateQuantity(item.product_id, e.target.value)}
                            className="w-20 p-1 border rounded text-right"
                            min="1"
                          />
                        </td>
                        <td className="p-3 text-right">
                          <input
                            type="number"
                            value={item.unit_price}
                            onChange={(e) => updatePrice(item.product_id, e.target.value)}
                            className="w-24 p-1 border rounded text-right"
                            min="0"
                            step="0.01"
                          />
                        </td>
                        <td className="p-3 text-right">
                          â‚¹{(item.quantity * item.unit_price).toFixed(2)}
                        </td>
                        <td className="p-3 text-right">
                          <button
                            onClick={() => removeItem(item.product_id)}
                            className="text-red-600 hover:text-red-800"
                          >
                            Remove
                          </button>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
          </div>

          {/* Billing Summary */}
          <div className="bg-white rounded-lg p-6 shadow mb-6">
            <h2 className="text-xl font-bold mb-4">Billing Summary</h2>
            <div className="space-y-3">
              <div className="flex justify-between">
                <span>Subtotal:</span>
                <span className="font-medium">â‚¹{subtotal.toFixed(2)}</span>
              </div>
              <div className="flex justify-between items-center">
                <span>Discount:</span>
                <input
                  type="number"
                  value={discount}
                  onChange={(e) => setDiscount(parseFloat(e.target.value) || 0)}
                  className="w-32 p-2 border rounded text-right"
                  min="0"
                  step="0.01"
                  placeholder="0.00"
                />
              </div>
              <div className="flex justify-between items-center">
                <span>Payment Method:</span>
                <select
                  value={paymentMethod}
                  onChange={(e) => setPaymentMethod(e.target.value)}
                  className="p-2 border rounded"
                >
                  <option value="cash">Cash</option>
                  <option value="card">Card</option>
                  <option value="upi">UPI</option>
                  <option value="cheque">Cheque</option>
                </select>
              </div>
              <div className="flex justify-between text-xl font-bold border-t pt-3">
                <span>Total:</span>
                <span>â‚¹{total.toFixed(2)}</span>
              </div>
            </div>
          </div>

          {/* Actions */}
          <div className="flex gap-3">
            <button
              onClick={resetForm}
              className="flex-1 px-6 py-3 bg-gray-300 rounded hover:bg-gray-400"
            >
              Cancel
            </button>
            <button
              onClick={() => setShowBillModal(true)}
              disabled={selectedItems.length === 0}
              className="flex-1 px-6 py-3 bg-green-600 text-white rounded hover:bg-green-700 disabled:bg-gray-400"
            >
              Generate Bill
            </button>
          </div>

          {/* Product Search Modal */}
          {showProductSearch && (
            <Modal onClose={() => { setShowProductSearch(false); setProductSearch(''); }}>
              <div className="bg-white rounded-lg p-6 max-w-2xl w-full max-h-[80vh] overflow-auto">
                <h2 className="text-2xl font-bold mb-4">Add Product</h2>
                <input
                  type="text"
                  placeholder="Search products..."
                  value={productSearch}
                  onChange={(e) => setProductSearch(e.target.value)}
                  className="w-full p-3 border rounded mb-4"
                  autoFocus
                />
                <div className="space-y-2">
                  {filteredProducts.length === 0 ? (
                    <p className="text-gray-500 text-center py-4">No products found</p>
                  ) : (
                    filteredProducts.map(product => {
                      const available = getAvailableQuantity(product.id);
                      return (
                        <div
                          key={product.id}
                          onClick={() => available > 0 && addItem(product)}
                          className={`p-4 border rounded ${
                            available > 0
                              ? 'cursor-pointer hover:bg-gray-50'
                              : 'opacity-50 cursor-not-allowed'
                          }`}
                        >
                          <div className="flex justify-between items-center">
                            <div>
                              <p className="font-medium">{product.name}</p>
                              <p className="text-sm text-gray-600">
                                Available: {available} units
                              </p>
                            </div>
                            <div className="text-right">
                              <p className="font-bold">â‚¹{product.sell_price}</p>
                              {available <= 0 && (
                                <span className="text-xs text-red-600">Out of stock</span>
                              )}
                            </div>
                          </div>
                        </div>
                      );
                    })
                  )}
                </div>
              </div>
            </Modal>
          )}

          {/* Bill Modal */}
          {showBillModal && <BillModal />}
        </div>
      );
    }

    function StockManagement() {
      const [products, setProducts] = useState([]);
      const [selectedProduct, setSelectedProduct] = useState(null);
      const [transactions, setTransactions] = useState([]);
      const [showAddProduct, setShowAddProduct] = useState(false);
      const [showAddPurchase, setShowAddPurchase] = useState(false);
      const [showAdjustment, setShowAdjustment] = useState(false);
      const [showUploadDoc, setShowUploadDoc] = useState(false);
      const [uploadTransaction, setUploadTransaction] = useState(null);
      const [searchTerm, setSearchTerm] = useState('');
      const [rackFilter, setRackFilter] = useState('');
      const [allRacks, setAllRacks] = useState([]);

      // Loading states
      const [loadingProducts, setLoadingProducts] = useState(false);
      const [loadingTransactions, setLoadingTransactions] = useState(false);
      const [submittingProduct, setSubmittingProduct] = useState(false);
      const [submittingPurchase, setSubmittingPurchase] = useState(false);
      const [submittingAdjustment, setSubmittingAdjustment] = useState(false);
      const [uploadingDocument, setUploadingDocument] = useState(false);

      // Modal state for alerts and confirmations
      const [modalMessage, setModalMessage] = useState('');
      const [modalType, setModalType] = useState('info'); // 'info', 'error', 'success', 'confirm'
      const [showModal, setShowModal] = useState(false);
      const [modalAction, setModalAction] = useState(null);
      const [deleteProductId, setDeleteProductId] = useState(null);

      const [productForm, setProductForm] = useState({
        name: '', sell_price: '', rack_id: '', additional_info: ''
      });

      const [purchaseForm, setPurchaseForm] = useState({
        quantity: '', unit_cost: '', new_sell_price: '', vendor: '', reference_no: '', notes: ''
      });

      const [adjustmentForm, setAdjustmentForm] = useState({
        type: 'ADJUSTMENT_OUT', quantity: '', reason: 'DEFECTED', notes: ''
      });

      const [uploadFile, setUploadFile] = useState(null);

      useEffect(() => { loadProducts(); }, []);

      const loadProducts = async () => {
        setLoadingProducts(true);
        try {
          const data = await apiCall('/products');
          setProducts(data);
          const racks = [...new Set(data.map(p => p.rack_id).filter(r => r))].sort();
          setAllRacks(racks);
        } catch (err) { console.error(err); }
        finally { setLoadingProducts(false); }
      };

      const loadTransactions = async (productId) => {
        setLoadingTransactions(true);
        try {
          const data = await apiCall(`/inventory-transactions/product/${productId}`);
          // Fetch documents for all transactions
          const docPromises = data.map(t =>
            apiCall(`/documents/INVENTORY_TRANSACTION/${t.id}`).then(docs => ({ id: t.id, docs: docs || [] })).catch(() => ({ id: t.id, docs: [] }))
          );
          const docsArr = await Promise.all(docPromises);
          const docsMap = Object.fromEntries(docsArr.map(d => [d.id, d.docs[0] || null]));
          // Merge document_path, document_id, and document_name into each transaction
          const merged = data.map(t => ({
            ...t,
            document_path: docsMap[t.id]?.file_path || null,
            document_id: docsMap[t.id]?.id || null,
            document_name: docsMap[t.id]?.file_name || null
          }));
          setTransactions(merged);
        } catch (err) { console.error(err); }
        finally { setLoadingTransactions(false); }
      };

      // Helper function to show modal messages
      const showMessage = (message, type = 'info', action = null) => {
        setModalMessage(message);
        setModalType(type);
        setModalAction(() => action);
        setShowModal(true);
      };

      const handleAddProduct = async (e) => {
        e.preventDefault();
        if (!productForm.name.trim()) { showMessage('Product name is required', 'error'); return; }
        if (!productForm.sell_price || parseFloat(productForm.sell_price) <= 0) { showMessage('Valid sell price is required', 'error'); return; }

        setSubmittingProduct(true);
        try {
          await apiCall('/products', {
            method: 'POST',
            body: JSON.stringify({
              name: productForm.name,
              sell_price: parseFloat(productForm.sell_price),
              rack_id: productForm.rack_id,
              additional_info: productForm.additional_info
            })
          });
          setShowAddProduct(false);
          setProductForm({ name: '', sell_price: '', rack_id: '', additional_info: '' });
          loadProducts();
        } catch (err) { showMessage(err.message, 'error'); }
        finally { setSubmittingProduct(false); }
      };

      const handleAddPurchase = async (e) => {
        e.preventDefault();
        if (!purchaseForm.quantity || parseInt(purchaseForm.quantity) <= 0) { showMessage('Valid quantity is required', 'error'); return; }
        if (!purchaseForm.unit_cost || parseFloat(purchaseForm.unit_cost) <= 0) { showMessage('Valid unit cost is required', 'error'); return; }

        setSubmittingPurchase(true);
        try {
          const requestData = {
            product_id: selectedProduct.id,
            transaction_type: 'PURCHASE',
            quantity: parseInt(purchaseForm.quantity),
            unit_cost: parseFloat(purchaseForm.unit_cost),
            vendor: purchaseForm.vendor,
            reference_no: purchaseForm.reference_no,
            notes: purchaseForm.notes
          };

          // If new sell price provided, update product sell price
          if (purchaseForm.new_sell_price && parseFloat(purchaseForm.new_sell_price) > 0) {
            await apiCall(`/products/${selectedProduct.id}`, {
              method: 'PUT',
              body: JSON.stringify({
                ...selectedProduct,
                sell_price: parseFloat(purchaseForm.new_sell_price)
              })
            });
          }

          const result = await apiCall('/inventory-transactions', {
            method: 'POST',
            body: JSON.stringify(requestData)
          });

          setShowAddPurchase(false);
          setPurchaseForm({ quantity: '', unit_cost: '', new_sell_price: '', vendor: '', reference_no: '', notes: '' });

          // Reload product to get updated values
          const updatedProduct = await apiCall(`/products/${selectedProduct.id}`);
          setSelectedProduct(updatedProduct);
          await loadTransactions(selectedProduct.id);
          loadProducts();
        } catch (err) { alert(err.message); }
        finally { setSubmittingPurchase(false); }
      };

      const handleAdjustment = async (e) => {
        e.preventDefault();
        if (!adjustmentForm.quantity || parseInt(adjustmentForm.quantity) <= 0) { showMessage('Valid quantity is required', 'error'); return; }

        setSubmittingAdjustment(true);
        try {
          await apiCall('/inventory-transactions', {
            method: 'POST',
            body: JSON.stringify({
              product_id: selectedProduct.id,
              transaction_type: adjustmentForm.type,
              quantity: parseInt(adjustmentForm.quantity),
              notes: `${adjustmentForm.reason}: ${adjustmentForm.notes}`
            })
          });
          setShowAdjustment(false);
          setAdjustmentForm({ type: 'ADJUSTMENT_OUT', quantity: '', reason: 'DEFECTED', notes: '' });

          const updatedProduct = await apiCall(`/products/${selectedProduct.id}`);
          setSelectedProduct(updatedProduct);
          await loadTransactions(selectedProduct.id);
          loadProducts();
        } catch (err) { alert(err.message); }
        finally { setSubmittingAdjustment(false); }
      };

      const handleFileUpload = async (e) => {
        e.preventDefault();
        if (!uploadFile) { showMessage('Please select a file', 'error'); return; }

        const formData = new FormData();
        formData.append('file', uploadFile);
        formData.append('document_type', 'TRANSACTION');
        formData.append('related_entity_type', 'INVENTORY_TRANSACTION');
        formData.append('related_entity_id', uploadTransaction.id);
        formData.append('notes', '');

        setUploadingDocument(true);
        try {
          const res = await fetch(`${API_URL}/documents/upload`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
            body: formData
          });

          if (!res.ok) throw new Error('Upload failed');

          showMessage('Document uploaded successfully!', 'success');
          setShowUploadDoc(false);
          setUploadFile(null);
          setUploadTransaction(null);
          await loadTransactions(selectedProduct.id);
        } catch (err) { showMessage(err.message, 'error'); }
        finally { setUploadingDocument(false); }
      };

      const handleDeleteDocument = async (transactionId) => {
        try {
          await apiCall(`/inventory-transactions/${transactionId}/document`, { method: 'DELETE' });
          showMessage('Document deleted successfully!', 'success');
          await loadTransactions(selectedProduct.id);
        } catch (err) { showMessage(err.message, 'error'); }
      };

      const handleDownloadDocument = async (documentId, fileName) => {
        try {
          const response = await fetch(`${API_URL}/documents/download/${documentId}`, {
            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
          });
          if (!response.ok) throw new Error(`Download failed: ${response.statusText}`);
          
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = fileName || 'document';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          window.URL.revokeObjectURL(url);
        } catch (err) { showMessage(`Download error: ${err.message}`, 'error'); }
      };

      const openProductDetails = async (product) => {
        setSelectedProduct(product);
        await loadTransactions(product.id);
      };

      const filteredProducts = products.filter(p => {
        const matchesSearch = !searchTerm || p.name.toLowerCase().includes(searchTerm.toLowerCase());
        const matchesRack = !rackFilter || p.rack_id === rackFilter;
        return matchesSearch && matchesRack;
      });

      if (selectedProduct) {
        const totalSell = selectedProduct.quantity * selectedProduct.sell_price;
        const totalCost = selectedProduct.quantity * selectedProduct.purchase_price;
        const margin = totalSell - totalCost;
        const marginPerUnit = selectedProduct.sell_price - selectedProduct.purchase_price;

        return (
          <div>
            <div className="flex justify-between items-center mb-6">
              <button onClick={() => setSelectedProduct(null)} className="text-blue-600 hover:text-blue-800 flex items-center gap-2">
                <span>â†</span> Back to Products
              </button>
              <div className="flex gap-2">
                <button onClick={() => setShowAddPurchase(true)} className="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">+ Add Purchase</button>
                <button onClick={() => setShowAdjustment(true)} className="bg-orange-600 text-white px-4 py-2 rounded hover:bg-orange-700">âš  Adjust Stock</button>
              </div>
            </div>

            <div className="bg-white rounded-lg shadow p-6 mb-6">
              <h1 className="text-2xl font-bold text-gray-800 mb-2">{selectedProduct.name}</h1>
              <p className="text-gray-600 mb-4">Rack: {selectedProduct.rack_id || 'N/A'}</p>

              <div className="grid grid-cols-4 gap-4 mb-4">
                <div className="bg-blue-50 p-4 rounded">
                  <div className="text-sm text-gray-600">Current Stock</div>
                  <div className="text-2xl font-bold text-blue-600">{selectedProduct.quantity} units</div>
                </div>
                <div className="bg-green-50 p-4 rounded">
                  <div className="text-sm text-gray-600">Unit Sell Price</div>
                  <div className="text-2xl font-bold text-green-600">â‚¹{selectedProduct.sell_price}</div>
                </div>
                <div className="bg-purple-50 p-4 rounded">
                  <div className="text-sm text-gray-600">Avg Unit Cost</div>
                  <div className="text-2xl font-bold text-purple-600">â‚¹{selectedProduct.purchase_price.toFixed(2)}</div>
                </div>
                <div className="bg-yellow-50 p-4 rounded">
                  <div className="text-sm text-gray-600">Unit Margin</div>
                  <div className="text-2xl font-bold text-yellow-600">â‚¹{marginPerUnit.toFixed(2)}</div>
                </div>
              </div>

              <div className="grid grid-cols-3 gap-4 pt-4 border-t">
                <div>
                  <div className="text-sm text-gray-600">Total Purchase Price</div>
                  <div className="text-xl font-bold text-gray-800">â‚¹{totalCost.toFixed(2)}</div>
                </div>
                <div>
                  <div className="text-sm text-gray-600">Expected Total Sell</div>
                  <div className="text-xl font-bold text-gray-800">â‚¹{totalSell.toFixed(2)}</div>
                </div>
                <div>
                  <div className="text-sm text-gray-600">Total Margin</div>
                  <div className="text-xl font-bold text-green-600">â‚¹{margin.toFixed(2)}</div>
                </div>
              </div>
            </div>

            <div className="bg-white rounded-lg shadow">
              <div className="p-6 border-b">
                <h2 className="text-xl font-bold">Transaction History</h2>
              </div>
              <SectionLoader loading={loadingTransactions} message="Loading transaction history...">
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead className="bg-gray-50">
                      <tr>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">ID</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Quantity</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Unit Cost</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Vendor</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Reference</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Document</th>
                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Notes</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-200">
                    {transactions.length === 0 ? (
                      <tr>
                        <td colSpan="10" className="px-6 py-8 text-center text-gray-500">
                          No transactions yet. Add your first purchase!
                        </td>
                      </tr>
                    ) : (
                      transactions.map(t => (
                        <tr key={t.id} className="hover:bg-gray-50">
                          <td className="px-6 py-4 text-sm font-mono text-gray-600">#{t.id}</td>
                          <td className="px-6 py-4 text-sm">{new Date(t.transaction_date).toLocaleString()}</td>
                          <td className="px-6 py-4">
                            <span className={`px-2 py-1 text-xs rounded ${
                              t.transaction_type === 'PURCHASE' ? 'bg-green-100 text-green-800' :
                              t.transaction_type === 'SALE' ? 'bg-blue-100 text-blue-800' :
                              'bg-orange-100 text-orange-800'
                            }`}>
                              {t.transaction_type}
                            </span>
                          </td>
                          <td className="px-6 py-4 text-sm font-medium">{t.quantity}</td>
                          <td className="px-6 py-4 text-sm">{t.unit_cost ? `â‚¹${t.unit_cost}` : '-'}</td>
                          <td className="px-6 py-4 text-sm font-medium">{t.unit_cost ? `â‚¹${(t.quantity * t.unit_cost).toFixed(2)}` : '-'}</td>
                          <td className="px-6 py-4 text-sm">{t.vendor || '-'}</td>
                          <td className="px-6 py-4 text-sm">{t.reference_no || '-'}</td>
                          <td className="px-6 py-4 text-sm">
                            {t.document_path ? (
                              <div className="flex items-center gap-3">
                                <button onClick={() => handleDownloadDocument(t.document_id, t.document_name)} title="Download Document" className="text-blue-600 hover:text-blue-800 transition">
                                  <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fillRule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clipRule="evenodd" />
                                  </svg>
                                </button>
                                <button 
                                  onClick={(e) => {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    showMessage('Delete this document?', 'confirm', () => handleDeleteDocument(t.id));
                                  }} 
                                  title="Delete Document"
                                  className="text-red-600 hover:text-red-800 transition">
                                  <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fillRule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clipRule="evenodd" />
                                  </svg>
                                </button>
                              </div>
                            ) : (
                              <button onClick={() => { setUploadTransaction(t); setShowUploadDoc(true); }} title="Upload Document" className="text-green-600 hover:text-green-800 transition">
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                  <path d="M5.5 13a3.5 3.5 0 01-.369-6.98 4 4 0 117.753-1.3A4.5 4.5 0 1113.5 13H11V9.413l1.293 1.293a1 1 0 001.414-1.414l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13H5.5z" />
                                </svg>
                              </button>
                            )}
                          </td>
                          <td className="px-6 py-4 text-sm text-gray-600">{t.notes || '-'}</td>
                        </tr>
                      ))
                    )}
                    </tbody>
                  </table>
                </div>
              </SectionLoader>
            </div>

            {showAddPurchase && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-lg shadow-xl max-w-md w-full max-h-[90vh] overflow-y-auto">
                  <div className="p-6 border-b">
                    <h3 className="text-xl font-bold">Add Purchase</h3>
                    <p className="text-sm text-gray-600 mt-1">Add stock for {selectedProduct.name}</p>
                  </div>
                  <form onSubmit={handleAddPurchase} className="p-6">
                    <div className="space-y-4">
                      <div>
                        <label className="block text-sm font-medium mb-1">Quantity *</label>
                        <input type="number" value={purchaseForm.quantity} onChange={e => setPurchaseForm({...purchaseForm, quantity: e.target.value})} className="w-full px-3 py-2 border rounded" required />
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-1">Unit Cost (â‚¹) *</label>
                        <input type="number" step="0.01" value={purchaseForm.unit_cost} onChange={e => setPurchaseForm({...purchaseForm, unit_cost: e.target.value})} className="w-full px-3 py-2 border rounded" required />
                      </div>
                      <div className="bg-yellow-50 p-3 rounded">
                        <label className="block text-sm font-medium mb-1">New Sell Price (â‚¹) - Optional</label>
                        <input type="number" step="0.01" value={purchaseForm.new_sell_price} onChange={e => setPurchaseForm({...purchaseForm, new_sell_price: e.target.value})} className="w-full px-3 py-2 border rounded" placeholder={`Current: â‚¹${selectedProduct.sell_price}`} />
                        <p className="text-xs text-gray-600 mt-1">Leave empty to keep current price</p>
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-1">Vendor</label>
                        <input value={purchaseForm.vendor} onChange={e => setPurchaseForm({...purchaseForm, vendor: e.target.value})} className="w-full px-3 py-2 border rounded" />
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-1">Invoice/Reference No</label>
                        <input value={purchaseForm.reference_no} onChange={e => setPurchaseForm({...purchaseForm, reference_no: e.target.value})} className="w-full px-3 py-2 border rounded" />
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-1">Notes</label>
                        <textarea value={purchaseForm.notes} onChange={e => setPurchaseForm({...purchaseForm, notes: e.target.value})} className="w-full px-3 py-2 border rounded" rows="2"></textarea>
                      </div>
                      {purchaseForm.quantity && purchaseForm.unit_cost && (
                        <div className="bg-blue-50 p-3 rounded">
                          <div className="text-sm font-medium">Total Purchase: â‚¹{(parseInt(purchaseForm.quantity) * parseFloat(purchaseForm.unit_cost)).toFixed(2)}</div>
                          {purchaseForm.new_sell_price && (
                            <div className="text-sm text-green-600 mt-1">New margin per unit: â‚¹{(parseFloat(purchaseForm.new_sell_price) - parseFloat(purchaseForm.unit_cost)).toFixed(2)}</div>
                          )}
                        </div>
                      )}
                    </div>
                    <div className="flex gap-3 mt-6">
                      <button type="button" onClick={() => setShowAddPurchase(false)} className="flex-1 px-4 py-2 border rounded hover:bg-gray-50" disabled={submittingPurchase}>Cancel</button>
                      <ButtonLoader loading={submittingPurchase} type="submit" className="flex-1 px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">Add Purchase</ButtonLoader>
                    </div>
                  </form>
                </div>
              </div>
            )}

            {showAdjustment && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-lg shadow-xl max-w-md w-full">
                  <div className="p-6 border-b">
                    <h3 className="text-xl font-bold">Stock Adjustment</h3>
                  </div>
                  <form onSubmit={handleAdjustment} className="p-6">
                    <div className="space-y-4">
                      <div>
                        <label className="block text-sm font-medium mb-1">Adjustment Type *</label>
                        <select value={adjustmentForm.type} onChange={e => setAdjustmentForm({...adjustmentForm, type: e.target.value})} className="w-full px-3 py-2 border rounded">
                          <option value="ADJUSTMENT_OUT">Decrease Stock (OUT)</option>
                          <option value="ADJUSTMENT_IN">Increase Stock (IN)</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-1">Quantity *</label>
                        <input type="number" value={adjustmentForm.quantity} onChange={e => setAdjustmentForm({...adjustmentForm, quantity: e.target.value})} className="w-full px-3 py-2 border rounded" required />
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-1">Reason *</label>
                        <select value={adjustmentForm.reason} onChange={e => setAdjustmentForm({...adjustmentForm, reason: e.target.value})} className="w-full px-3 py-2 border rounded">
                          <option value="DEFECTED">Defected</option>
                          <option value="RETURNED">Returned by Customer</option>
                          <option value="DAMAGED">Damaged</option>
                          <option value="LOST">Lost/Stolen</option>
                          <option value="EXPIRED">Expired</option>
                          <option value="FOUND">Found (Extra Stock)</option>
                          <option value="OTHER">Other</option>
                        </select>
                      </div>
                      <div>
                        <label className="block text-sm font-medium mb-1">Additional Notes</label>
                        <textarea value={adjustmentForm.notes} onChange={e => setAdjustmentForm({...adjustmentForm, notes: e.target.value})} className="w-full px-3 py-2 border rounded" rows="2" placeholder="Describe the reason..."></textarea>
                      </div>
                    </div>
                    <div className="flex gap-3 mt-6">
                      <button type="button" onClick={() => setShowAdjustment(false)} className="flex-1 px-4 py-2 border rounded hover:bg-gray-50" disabled={submittingAdjustment}>Cancel</button>
                      <ButtonLoader loading={submittingAdjustment} type="submit" className="flex-1 px-4 py-2 bg-orange-600 text-white rounded hover:bg-orange-700">Adjust Stock</ButtonLoader>
                    </div>
                  </form>
                </div>
              </div>
            )}

            {showUploadDoc && (
              <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
                <div className="bg-white rounded-lg shadow-xl max-w-md w-full">
                  <div className="p-6 border-b">
                    <h3 className="text-xl font-bold">Upload Document</h3>
                    <p className="text-sm text-gray-600 mt-1">Transaction #{uploadTransaction?.id}</p>
                  </div>
                  <form onSubmit={handleFileUpload} className="p-6">
                    <div className="space-y-4">
                      <div>
                        <label className="block text-sm font-medium mb-1">Select Document *</label>
                        <input type="file" onChange={e => setUploadFile(e.target.files[0])} className="w-full px-3 py-2 border rounded" accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" required />
                        <p className="text-xs text-gray-600 mt-1">Supported: PDF, JPG, PNG, DOC, DOCX</p>
                      </div>
                      {uploadFile && (
                        <div className="bg-blue-50 p-3 rounded text-sm">
                          <div className="font-medium">Selected: {uploadFile.name}</div>
                          <div className="text-gray-600">Size: {(uploadFile.size / 1024).toFixed(2)} KB</div>
                        </div>
                      )}
                    </div>
                    <div className="flex gap-3 mt-6">
                      <button type="button" onClick={() => { setShowUploadDoc(false); setUploadFile(null); setUploadTransaction(null); }} className="flex-1 px-4 py-2 border rounded hover:bg-gray-50" disabled={uploadingDocument}>Cancel</button>
                      <ButtonLoader loading={uploadingDocument} type="submit" className="flex-1 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Upload</ButtonLoader>
                    </div>
                  </form>
                </div>
              </div>
            )}
          </div>
        );
      }

      return (
        <div>
          <div className="flex justify-between items-center mb-6">
            <h1 className="text-3xl font-bold text-gray-800">Stock Management</h1>
            <button onClick={() => setShowAddProduct(true)} className="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700">+ Add Product</button>
          </div>

          <div className="bg-white rounded-lg shadow p-4 mb-6">
            <div className="flex gap-4">
              <input
                type="text"
                placeholder="Search products..."
                value={searchTerm}
                onChange={e => setSearchTerm(e.target.value)}
                className="flex-1 px-4 py-2 border rounded-lg"
              />
              <select value={rackFilter} onChange={e => setRackFilter(e.target.value)} className="px-4 py-2 border rounded-lg">
                <option value="">All Racks</option>
                {allRacks.map(rack => <option key={rack} value={rack}>{rack}</option>)}
              </select>
              {(searchTerm || rackFilter) && (
                <button onClick={() => { setSearchTerm(''); setRackFilter(''); }} className="px-4 py-2 text-gray-600 hover:text-gray-800">
                  Clear
                </button>
              )}
            </div>
          </div>

          <div className="bg-white rounded-lg shadow overflow-hidden">
            <SectionLoader loading={loadingProducts} message="Loading products...">
              <table className="w-full">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Product Name</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Current Stock</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sell Price (â‚¹)</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Avg Cost (â‚¹)</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Rack</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-gray-200">
                  {filteredProducts.length === 0 ? (
                    <tr>
                      <td colSpan="6" className="px-6 py-12 text-center text-gray-500">
                        {products.length === 0 ? (
                          <div>
                            <p className="text-lg font-medium mb-2">No products yet</p>
                            <p className="text-sm">Click "Add Product" to get started</p>
                          </div>
                        ) : (
                          <div>No products match your search</div>
                        )}
                      </td>
                    </tr>
                  ) : (
                    filteredProducts.map(p => (
                      <tr key={p.id} className="hover:bg-gray-50 cursor-pointer" onClick={() => openProductDetails(p)}>
                        <td className="px-6 py-4 font-medium text-blue-600">{p.name}</td>
                        <td className="px-6 py-4">
                          <span className={`font-bold ${p.quantity === 0 ? 'text-red-600' : p.quantity < 10 ? 'text-orange-600' : 'text-green-600'}`}>
                            {p.quantity}
                          </span>
                        </td>
                        <td className="px-6 py-4">â‚¹{p.sell_price}</td>
                        <td className="px-6 py-4">â‚¹{p.purchase_price.toFixed(2)}</td>
                        <td className="px-6 py-4 text-gray-600">{p.rack_id || '-'}</td>
                        <td className="px-6 py-4">
                          <button onClick={(e) => { e.stopPropagation(); openProductDetails(p); }} className="text-blue-600 hover:text-blue-800">
                            View Details â†’
                          </button>
                        </td>
                      </tr>
                    ))
                  )}
                </tbody>
              </table>
            </SectionLoader>
          </div>

          <div className="mt-4 text-sm text-gray-600">
            Showing {filteredProducts.length} of {products.length} products
          </div>

          {showAddProduct && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-lg shadow-xl max-w-md w-full">
                <div className="p-6 border-b">
                  <h3 className="text-xl font-bold">Add New Product</h3>
                  <p className="text-sm text-gray-600 mt-1">Stock will be added through purchase transactions</p>
                </div>
                <form onSubmit={handleAddProduct} className="p-6">
                  <div className="space-y-4">
                    <div>
                      <label className="block text-sm font-medium mb-1">Product Name *</label>
                      <input value={productForm.name} onChange={e => setProductForm({...productForm, name: e.target.value})} className="w-full px-3 py-2 border rounded" required />
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1">Sell Price (â‚¹) *</label>
                      <input type="number" step="0.01" value={productForm.sell_price} onChange={e => setProductForm({...productForm, sell_price: e.target.value})} className="w-full px-3 py-2 border rounded" required />
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1">Rack ID</label>
                      <input value={productForm.rack_id} onChange={e => setProductForm({...productForm, rack_id: e.target.value})} className="w-full px-3 py-2 border rounded" placeholder="e.g., A-1, B-2" />
                    </div>
                    <div>
                      <label className="block text-sm font-medium mb-1">Additional Info</label>
                      <textarea value={productForm.additional_info} onChange={e => setProductForm({...productForm, additional_info: e.target.value})} className="w-full px-3 py-2 border rounded" rows="2"></textarea>
                    </div>
                  </div>
                  <div className="flex gap-3 mt-6">
                    <button type="button" onClick={() => setShowAddProduct(false)} className="flex-1 px-4 py-2 border rounded hover:bg-gray-50" disabled={submittingProduct}>Cancel</button>
                    <ButtonLoader loading={submittingProduct} type="submit" className="flex-1 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Add Product</ButtonLoader>
                  </div>
                </form>
              </div>
            </div>
          )}

          {/* Modal Popup Component */}
          {showModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-lg shadow-xl max-w-md w-full">
                <div className={`p-6 border-b flex items-start gap-4 ${
                  modalType === 'error' ? 'border-red-300 bg-red-50' :
                  modalType === 'success' ? 'border-green-300 bg-green-50' :
                  modalType === 'confirm' ? 'border-blue-300 bg-blue-50' :
                  'border-blue-300 bg-blue-50'
                }`}>
                  <div className={`flex-shrink-0 h-6 w-6 rounded-full flex items-center justify-center text-white ${
                    modalType === 'error' ? 'bg-red-500' :
                    modalType === 'success' ? 'bg-green-500' :
                    modalType === 'confirm' ? 'bg-blue-500' :
                    'bg-blue-500'
                  }`}>
                    {modalType === 'error' && '!'}
                    {modalType === 'success' && 'âœ“'}
                    {(modalType === 'info' || modalType === 'confirm') && 'i'}
                  </div>
                  <div className="flex-1">
                    <p className="text-sm text-gray-700">{modalMessage}</p>
                  </div>
                </div>
                <div className="p-6 flex gap-3">
                  {modalType === 'confirm' ? (
                    <>
                      <button 
                        onClick={() => { setShowModal(false); }} 
                        className="flex-1 px-4 py-2 border rounded hover:bg-gray-50">
                        Cancel
                      </button>
                      <button
                        onClick={() => {
                          if (modalAction) {
                            const action = modalAction();
                            if (action) action();
                          }
                          setShowModal(false);
                        }}
                        className="flex-1 px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700">
                        Confirm
                      </button>
                    </>
                  ) : (
                    <button 
                      onClick={() => setShowModal(false)} 
                      className="w-full px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                      OK
                    </button>
                  )}
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    function JobCards() {
      const [jobCards, setJobCards] = useState([]);
      const [filteredJobCards, setFilteredJobCards] = useState([]);
      const [searchTerm, setSearchTerm] = useState('');
      const [statusFilter, setStatusFilter] = useState('');
      const [showCreateModal, setShowCreateModal] = useState(false);
      const [showViewModal, setShowViewModal] = useState(false);
      const [showAddStockModal, setShowAddStockModal] = useState(false);
      const [showBillingModal, setShowBillingModal] = useState(false);
      const [showRejectModal, setShowRejectModal] = useState(false);
      const [currentJobCard, setCurrentJobCard] = useState(null);
      const [products, setProducts] = useState([]);

      // Loading states
      const [loadingJobCards, setLoadingJobCards] = useState(false);
      const [loadingJobCard, setLoadingJobCard] = useState(false);
      const [creatingJobCard, setCreatingJobCard] = useState(false);
      const [addingStockItem, setAddingStockItem] = useState(false);
      const [completingJobCard, setCompletingJobCard] = useState(false);
      const [rejectingJobCard, setRejectingJobCard] = useState(false);
      
      // Create job card form states
      const [customerSearch, setCustomerSearch] = useState('');
      const [customerResults, setCustomerResults] = useState([]);
      const [selectedCustomer, setSelectedCustomer] = useState(null);
      const [vehicleNumber, setVehicleNumber] = useState('');
      const [tasks, setTasks] = useState(['']);
      const [assignee, setAssignee] = useState('');
      const [notes, setNotes] = useState('');
      
      // Stock item form states
      const [stockProductId, setStockProductId] = useState('');
      const [stockQuantity, setStockQuantity] = useState(1);
      const [stockUnitPrice, setStockUnitPrice] = useState(0);
      const [stockNotes, setStockNotes] = useState('');
      
      // Billing form states
      const [labourCharge, setLabourCharge] = useState(0);
      const [lastServiceDate, setLastServiceDate] = useState('');
      const [nextServiceDate, setNextServiceDate] = useState('');
      
      // Reject form state
      const [rejectReason, setRejectReason] = useState('');

      useEffect(() => {
        loadJobCards();
        loadProducts();
      }, []);

      useEffect(() => {
        filterJobCards();
      }, [jobCards, searchTerm, statusFilter]);

      const loadJobCards = async () => {
        setLoadingJobCards(true);
        try {
          const response = await fetch(`${API_URL}/job-cards`, {
            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
          });
          const data = await response.json();
          setJobCards(data);
        } catch (error) {
          console.error('Error loading job cards:', error);
        }
        finally { setLoadingJobCards(false); }
      };

      const loadProducts = async () => {
        try {
          const response = await fetch(`${API_URL}/products`, {
            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
          });
          const data = await response.json();
          setProducts(data);
        } catch (error) {
          console.error('Error loading products:', error);
        }
      };

      const filterJobCards = () => {
        let filtered = [...jobCards];
        
        if (searchTerm) {
          filtered = filtered.filter(job => 
            job.job_number.toLowerCase().includes(searchTerm.toLowerCase()) ||
            job.vehicle_number.toLowerCase().includes(searchTerm.toLowerCase()) ||
            job.customer_name.toLowerCase().includes(searchTerm.toLowerCase())
          );
        }
        
        if (statusFilter) {
          filtered = filtered.filter(job => job.status === statusFilter);
        }
        
        setFilteredJobCards(filtered);
      };

      const searchCustomers = async (search) => {
        if (search.length < 2) {
          setCustomerResults([]);
          return;
        }
        
        try {
          const response = await fetch(`${API_URL}/job-cards/search-customer?search=${encodeURIComponent(search)}`, {
            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
          });
          const data = await response.json();
          setCustomerResults(data);
        } catch (error) {
          console.error('Error searching customers:', error);
        }
      };

      const handleCustomerSearch = (value) => {
        setCustomerSearch(value);
        searchCustomers(value);
      };

      const selectCustomer = (customer) => {
        setSelectedCustomer(customer);
        setCustomerSearch(customer.name);
        setVehicleNumber(customer.vehicle_number || '');
        setCustomerResults([]);
      };

      const createJobCard = async () => {
        if (!selectedCustomer) {
          alert('Please select a customer');
          return;
        }

        if (!vehicleNumber) {
          alert('Please enter vehicle number');
          return;
        }

        const validTasks = tasks.filter(t => t.trim().length > 0);
        if (validTasks.length === 0) {
          alert('Please add at least one task');
          return;
        }

        setCreatingJobCard(true);
        try {
          const response = await fetch(`${API_URL}/job-cards`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify({
              customer_id: selectedCustomer.id,
              vehicle_number: vehicleNumber,
              tasks: validTasks,
              assignee: assignee || null,
              notes: notes || null
            })
          });

          const data = await response.json();
          if (data.error) {
            alert(data.error);
          } else {
            closeCreateModal();
            loadJobCards();
          }
        } catch (error) {
          console.error('Error creating job card:', error);
          alert('Failed to create job card');
        }
        finally { setCreatingJobCard(false); }
      };

      const viewJobCard = async (id) => {
        setLoadingJobCard(true);
        try {
          const response = await fetch(`${API_URL}/job-cards/${id}`, {
            headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
          });
          const data = await response.json();
          setCurrentJobCard(data);
          setShowViewModal(true);
        } catch (error) {
          console.error('Error loading job card:', error);
        }
        finally { setLoadingJobCard(false); }
      };

      const addStockItem = async () => {
        if (!stockProductId || !stockQuantity || !stockUnitPrice) {
          alert('Please fill all required fields');
          return;
        }

        setAddingStockItem(true);
        try {
          const response = await fetch(`${API_URL}/job-cards/${currentJobCard.id}/stock-items`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify({
              product_id: stockProductId,
              quantity: stockQuantity,
              unit_price: stockUnitPrice,
              notes: stockNotes || null
            })
          });

          const data = await response.json();
          if (data.error) {
            alert(data.error);
          } else {
            setShowAddStockModal(false);
            resetStockForm();
            viewJobCard(currentJobCard.id);
          }
        } catch (error) {
          console.error('Error adding stock item:', error);
          alert('Failed to add stock item');
        }
        finally { setAddingStockItem(false); }
      };

      const completeJobCard = async () => {
        setCompletingJobCard(true);
        try {
          const response = await fetch(`${API_URL}/job-cards/${currentJobCard.id}/complete`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify({
              labour_charge: labourCharge,
              last_service_date: lastServiceDate || null,
              next_service_date: nextServiceDate || null
            })
          });

          const data = await response.json();
          if (data.error) {
            alert(data.error);
          } else {
            setShowBillingModal(false);
            setShowViewModal(false);
            loadJobCards();
          }
        } catch (error) {
          console.error('Error completing job card:', error);
          alert('Failed to complete job card');
        }
        finally { setCompletingJobCard(false); }
      };

      const rejectJobCard = async () => {
        if (!rejectReason.trim()) {
          alert('Please enter rejection reason');
          return;
        }

        setRejectingJobCard(true);
        try {
          const response = await fetch(`${API_URL}/job-cards/${currentJobCard.id}/reject`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify({ reason: rejectReason })
          });

          const data = await response.json();
          if (data.error) {
            alert(data.error);
          } else {
            setShowRejectModal(false);
            setShowViewModal(false);
            loadJobCards();
          }
        } catch (error) {
          console.error('Error rejecting job card:', error);
          alert('Failed to reject job card');
        }
        finally { setRejectingJobCard(false); }
      };

      const printJobCard = () => {
        if (!currentJobCard) return;
        
        const stockTotal = currentJobCard.stock_items.reduce((sum, item) => sum + item.total_price, 0);
        const jobLabourCharge = currentJobCard.labour_charge || labourCharge || 0;
        const grandTotal = stockTotal + parseFloat(jobLabourCharge);
        
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
          <html>
            <head>
              <title>Job Card - ${currentJobCard.job_number}</title>
              <style>
                body { font-family: Arial, sans-serif; padding: 20px; }
                h1 { text-align: center; color: #333; }
                .header { margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 10px; }
                .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
                .info-item { margin-bottom: 10px; }
                .info-item strong { display: block; color: #666; font-size: 12px; }
                .info-item span { font-size: 16px; }
                table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
                th { background: #f5f5f5; font-weight: bold; }
                .total-row { font-weight: bold; background: #f9f9f9; }
                .tasks { margin: 20px 0; }
                .task-item { padding: 8px; background: #f9f9f9; margin: 5px 0; border-left: 3px solid #667eea; }
                .footer { margin-top: 40px; text-align: center; font-size: 12px; color: #666; }
                @media print {
                  button { display: none; }
                }
              </style>
            </head>
            <body>
              <div class="header">
                <h1>ðŸ”§ Job Card</h1>
                <p style="text-align: center; color: #666;">${currentJobCard.job_number}</p>
              </div>
              
              <div class="info-grid">
                <div class="info-item">
                  <strong>Customer</strong>
                  <span>${currentJobCard.customer_name}</span>
                </div>
                <div class="info-item">
                  <strong>Vehicle Number</strong>
                  <span>${currentJobCard.vehicle_number}</span>
                </div>
                <div class="info-item">
                  <strong>Status</strong>
                  <span style="text-transform: uppercase;">${currentJobCard.status}</span>
                </div>
                <div class="info-item">
                  <strong>Assignee</strong>
                  <span>${currentJobCard.assignee || 'Not assigned'}</span>
                </div>
                <div class="info-item">
                  <strong>Created Date</strong>
                  <span>${new Date(currentJobCard.created_at).toLocaleString()}</span>
                </div>
                ${currentJobCard.closed_at ? `
                  <div class="info-item">
                    <strong>Closed Date</strong>
                    <span>${new Date(currentJobCard.closed_at).toLocaleString()}</span>
                  </div>
                ` : ''}
              </div>
              
              ${currentJobCard.notes ? `
                <div style="margin: 20px 0; padding: 15px; background: #f9f9f9; border-radius: 5px;">
                  <strong>Notes:</strong>
                  <p style="margin: 5px 0 0 0;">${currentJobCard.notes}</p>
                </div>
              ` : ''}
              
              <h3>Tasks</h3>
              <div class="tasks">
                ${currentJobCard.tasks.map(task => `
                  <div class="task-item">${task.task_description}</div>
                `).join('')}
              </div>
              
              <h3>Stock Items & Parts</h3>
              <table>
                <thead>
                  <tr>
                    <th>Product</th>
                    <th>Quantity</th>
                    <th>Unit Price</th>
                    <th>Total</th>
                  </tr>
                </thead>
                <tbody>
                  ${currentJobCard.stock_items.map(item => `
                    <tr>
                      <td>${item.product_name}</td>
                      <td>${item.quantity}</td>
                      <td>â‚¹${item.unit_price.toFixed(2)}</td>
                      <td>â‚¹${item.total_price.toFixed(2)}</td>
                    </tr>
                  `).join('')}
                  <tr class="total-row">
                    <td colspan="3">Parts Subtotal</td>
                    <td>â‚¹${stockTotal.toFixed(2)}</td>
                  </tr>
                  <tr class="total-row">
                    <td colspan="3">Labour Charges</td>
                    <td>â‚¹${parseFloat(jobLabourCharge).toFixed(2)}</td>
                  </tr>
                  <tr class="total-row" style="font-size: 18px;">
                    <td colspan="3">GRAND TOTAL</td>
                    <td>â‚¹${grandTotal.toFixed(2)}</td>
                  </tr>
                </tbody>
              </table>
              
              <div class="footer">
                <p>Thank you for your business!</p>
                <p>Generated on ${new Date().toLocaleString()}</p>
              </div>
              
              <div style="text-align: center; margin: 20px;">
                <button onclick="window.print()" style="padding: 10px 30px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px;">Print</button>
                <button onclick="window.close()" style="padding: 10px 30px; background: #6b7280; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-left: 10px;">Close</button>
              </div>
            </body>
          </html>
        `);
        printWindow.document.close();
      };

      const closeCreateModal = () => {
        setShowCreateModal(false);
        setCustomerSearch('');
        setSelectedCustomer(null);
        setVehicleNumber('');
        setTasks(['']);
        setAssignee('');
        setNotes('');
        setCustomerResults([]);
      };

      const resetStockForm = () => {
        setStockProductId('');
        setStockQuantity(1);
        setStockUnitPrice(0);
        setStockNotes('');
      };

      return (
        <div className="p-6">
          <h1 className="text-3xl font-bold text-gray-800 mb-6">ðŸ”§ Job Cards Management</h1>
          
          <div className="bg-white rounded-lg shadow p-6 mb-6">
            <div className="flex gap-4 items-center flex-wrap">
              <input
                type="text"
                placeholder="Search by job number, vehicle, customer..."
                className="flex-1 min-w-[300px] px-4 py-2 border rounded-lg"
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
              />
              <select
                className="px-4 py-2 border rounded-lg"
                value={statusFilter}
                onChange={(e) => setStatusFilter(e.target.value)}
              >
                <option value="">All Status</option>
                <option value="open">Open</option>
                <option value="closed">Closed</option>
                <option value="rejected">Rejected</option>
              </select>
              <button
                onClick={() => setShowCreateModal(true)}
                className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
              >
                + Create Job Card
              </button>
            </div>
          </div>

          <SectionLoader loading={loadingJobCards} message="Loading job cards...">
            {filteredJobCards.length === 0 ? (
              <div className="text-center py-20 text-gray-500">
                <div className="text-6xl mb-4">ðŸ“‹</div>
                <h3 className="text-xl font-semibold mb-2">No job cards found</h3>
                <p>Create your first job card to get started</p>
              </div>
            ) : (
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {filteredJobCards.map(job => (
                  <div
                    key={job.id}
                    className={`bg-white rounded-lg shadow p-6 cursor-pointer hover:shadow-lg transition border-l-4 ${
                      job.status === 'open' ? 'border-green-500' :
                      job.status === 'closed' ? 'border-gray-500' : 'border-red-500'
                    }`}
                    onClick={() => viewJobCard(job.id)}
                  >
                    <div className="flex justify-between items-start mb-4">
                      <div className="text-lg font-bold text-blue-600">{job.job_number}</div>
                      <span className={`px-3 py-1 rounded-full text-xs font-semibold uppercase ${
                        job.status === 'open' ? 'bg-green-100 text-green-800' :
                        job.status === 'closed' ? 'bg-gray-100 text-gray-800' : 'bg-red-100 text-red-800'
                      }`}>
                        {job.status}
                      </span>
                    </div>
                    <div className="space-y-2 text-sm">
                      <div>
                        <strong className="text-gray-600">Customer:</strong>
                        <div>{job.customer_name}</div>
                      </div>
                      <div>
                        <strong className="text-gray-600">Vehicle:</strong>
                        <div>{job.vehicle_number}</div>
                      </div>
                      {job.assignee && (
                        <div>
                          <strong className="text-gray-600">Assignee:</strong>
                          <div>{job.assignee}</div>
                        </div>
                      )}
                      <div>
                        <strong className="text-gray-600">Created:</strong>
                        <div>{new Date(job.created_at).toLocaleDateString()}</div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}
          </SectionLoader>

          {/* Create Job Card Modal */}
          {showCreateModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-lg max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                <div className="p-6 border-b flex justify-between items-center">
                  <h2 className="text-2xl font-bold">Create New Job Card</h2>
                  <button onClick={closeCreateModal} className="text-2xl text-gray-500 hover:text-red-600">Ã—</button>
                </div>
                <div className="p-6">
                  <div className="space-y-4">
                    <div>
                      <label className="block font-semibold mb-2">Search Customer *</label>
                      <div className="relative">
                        <input
                          type="text"
                          placeholder="Search by name, phone, email, or vehicle number..."
                          className="w-full px-4 py-2 border rounded-lg"
                          value={customerSearch}
                          onChange={(e) => handleCustomerSearch(e.target.value)}
                        />
                        {customerResults.length > 0 && (
                          <div className="absolute z-10 w-full bg-white border rounded-lg mt-1 max-h-60 overflow-y-auto shadow-lg">
                            {customerResults.map(customer => (
                              <div
                                key={customer.id}
                                className="p-3 hover:bg-gray-100 cursor-pointer border-b"
                                onClick={() => selectCustomer(customer)}
                              >
                                <div className="font-semibold">{customer.name}</div>
                                <div className="text-sm text-gray-600">
                                  {customer.phone} {customer.vehicle_number && `â€¢ ${customer.vehicle_number}`}
                                </div>
                              </div>
                            ))}
                          </div>
                        )}
                      </div>
                      {selectedCustomer && (
                        <div className="mt-2 p-3 bg-blue-50 rounded-lg">
                          <div className="font-semibold">{selectedCustomer.name}</div>
                          <div className="text-sm text-gray-600">{selectedCustomer.phone}</div>
                        </div>
                      )}
                    </div>

                    <div>
                      <label className="block font-semibold mb-2">Vehicle Number *</label>
                      <input
                        type="text"
                        placeholder="Enter vehicle number"
                        className="w-full px-4 py-2 border rounded-lg"
                        value={vehicleNumber}
                        onChange={(e) => setVehicleNumber(e.target.value)}
                      />
                    </div>

                    <div>
                      <label className="block font-semibold mb-2">Tasks/Requirements *</label>
                      {tasks.map((task, index) => (
                        <div key={index} className="flex gap-2 mb-2">
                          <input
                            type="text"
                            placeholder="e.g., Change engine oil"
                            className="flex-1 px-4 py-2 border rounded-lg"
                            value={task}
                            onChange={(e) => {
                              const newTasks = [...tasks];
                              newTasks[index] = e.target.value;
                              setTasks(newTasks);
                            }}
                          />
                          {tasks.length > 1 && (
                            <button
                              onClick={() => setTasks(tasks.filter((_, i) => i !== index))}
                              className="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700"
                            >
                              Remove
                            </button>
                          )}
                        </div>
                      ))}
                      <button
                        onClick={() => setTasks([...tasks, ''])}
                        className="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700"
                      >
                        + Add Task
                      </button>
                    </div>

                    <div>
                      <label className="block font-semibold mb-2">Assignee</label>
                      <input
                        type="text"
                        placeholder="Person responsible for this job"
                        className="w-full px-4 py-2 border rounded-lg"
                        value={assignee}
                        onChange={(e) => setAssignee(e.target.value)}
                      />
                    </div>

                    <div>
                      <label className="block font-semibold mb-2">Notes</label>
                      <textarea
                        placeholder="Additional notes or instructions..."
                        className="w-full px-4 py-2 border rounded-lg"
                        rows="3"
                        value={notes}
                        onChange={(e) => setNotes(e.target.value)}
                      />
                    </div>
                  </div>

                  <div className="flex gap-4 mt-6">
                    <ButtonLoader
                      loading={creatingJobCard}
                      onClick={createJobCard}
                      className="flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold"
                    >
                      Create Job Card
                    </ButtonLoader>
                    <button
                      onClick={closeCreateModal}
                      className="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700"
                      disabled={creatingJobCard}
                    >
                      Cancel
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* View Job Card Modal */}
          {showViewModal && currentJobCard && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
                <div className="p-6 border-b flex justify-between items-center">
                  <h2 className="text-2xl font-bold">{currentJobCard.job_number}</h2>
                  <div className="flex gap-2">
                    <button
                      onClick={printJobCard}
                      className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700"
                    >
                      ðŸ–¨ï¸ Print
                    </button>
                    <button onClick={() => setShowViewModal(false)} className="text-2xl text-gray-500 hover:text-red-600">Ã—</button>
                  </div>
                </div>
                <div className="p-6">
                  <div className="grid grid-cols-2 gap-4 mb-6">
                    <div className="p-4 bg-gray-50 rounded-lg">
                      <div className="text-sm text-gray-600">Status</div>
                      <div className={`text-lg font-semibold uppercase ${
                        currentJobCard.status === 'open' ? 'text-green-600' :
                        currentJobCard.status === 'closed' ? 'text-gray-600' : 'text-red-600'
                      }`}>
                        {currentJobCard.status}
                      </div>
                    </div>
                    <div className="p-4 bg-gray-50 rounded-lg">
                      <div className="text-sm text-gray-600">Customer</div>
                      <div className="text-lg font-semibold">{currentJobCard.customer_name}</div>
                    </div>
                    <div className="p-4 bg-gray-50 rounded-lg">
                      <div className="text-sm text-gray-600">Vehicle</div>
                      <div className="text-lg font-semibold">{currentJobCard.vehicle_number}</div>
                    </div>
                    <div className="p-4 bg-gray-50 rounded-lg">
                      <div className="text-sm text-gray-600">Assignee</div>
                      <div className="text-lg font-semibold">{currentJobCard.assignee || 'Not assigned'}</div>
                    </div>
                    <div className="p-4 bg-gray-50 rounded-lg">
                      <div className="text-sm text-gray-600">Created</div>
                      <div className="text-lg font-semibold">{new Date(currentJobCard.created_at).toLocaleString()}</div>
                    </div>
                    {currentJobCard.closed_at && (
                      <div className="p-4 bg-gray-50 rounded-lg">
                        <div className="text-sm text-gray-600">Closed</div>
                        <div className="text-lg font-semibold">{new Date(currentJobCard.closed_at).toLocaleString()}</div>
                      </div>
                    )}
                  </div>

                  {currentJobCard.notes && (
                    <div className="mb-6 p-4 bg-yellow-50 rounded-lg">
                      <div className="font-semibold mb-2">Notes:</div>
                      <div>{currentJobCard.notes}</div>
                    </div>
                  )}

                  <div className="mb-6">
                    <h3 className="text-xl font-bold mb-3">Tasks</h3>
                    <div className="space-y-2">
                      {currentJobCard.tasks.map((task, index) => (
                        <div key={index} className="p-3 bg-gray-50 rounded-lg border-l-4 border-blue-500">
                          {task.task_description}
                        </div>
                      ))}
                    </div>
                  </div>

                  <div className="mb-6">
                    <div className="flex justify-between items-center mb-3">
                      <h3 className="text-xl font-bold">Stock Items & Parts</h3>
                      {currentJobCard.status === 'open' && (
                        <button
                          onClick={() => setShowAddStockModal(true)}
                          className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700"
                        >
                          + Add Stock
                        </button>
                      )}
                    </div>
                    {currentJobCard.stock_items.length > 0 ? (
                      <div className="overflow-x-auto">
                        <table className="w-full border-collapse">
                          <thead>
                            <tr className="bg-gray-100">
                              <th className="border p-3 text-left">Product</th>
                              <th className="border p-3 text-right">Quantity</th>
                              <th className="border p-3 text-right">Unit Price</th>
                              <th className="border p-3 text-right">Total</th>
                            </tr>
                          </thead>
                          <tbody>
                            {currentJobCard.stock_items.map((item, index) => (
                              <tr key={index}>
                                <td className="border p-3">{item.product_name}</td>
                                <td className="border p-3 text-right">{item.quantity}</td>
                                <td className="border p-3 text-right">â‚¹{item.unit_price.toFixed(2)}</td>
                                <td className="border p-3 text-right">â‚¹{item.total_price.toFixed(2)}</td>
                              </tr>
                            ))}
                            <tr className="font-bold bg-gray-50">
                              <td colSpan="3" className="border p-3 text-right">Subtotal</td>
                              <td className="border p-3 text-right">
                                â‚¹{currentJobCard.stock_items.reduce((sum, item) => sum + item.total_price, 0).toFixed(2)}
                              </td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    ) : (
                      <div className="text-center py-8 text-gray-500">No stock items added yet</div>
                    )}
                  </div>

                  {currentJobCard.status === 'open' && (
                    <div className="flex gap-4">
                      <button
                        onClick={() => setShowBillingModal(true)}
                        className="flex-1 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold"
                      >
                        Complete & Bill
                      </button>
                      <button
                        onClick={() => setShowRejectModal(true)}
                        className="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700"
                      >
                        Reject
                      </button>
                    </div>
                  )}
                </div>
              </div>
            </div>
          )}

          {/* Add Stock Modal */}
          {showAddStockModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-lg max-w-md w-full">
                <div className="p-6 border-b flex justify-between items-center">
                  <h2 className="text-2xl font-bold">Add Stock Item</h2>
                  <button onClick={() => { setShowAddStockModal(false); resetStockForm(); }} className="text-2xl text-gray-500 hover:text-red-600">Ã—</button>
                </div>
                <div className="p-6">
                  <div className="space-y-4">
                    <div>
                      <label className="block font-semibold mb-2">Product *</label>
                      <select
                        className="w-full px-4 py-2 border rounded-lg"
                        value={stockProductId}
                        onChange={(e) => {
                          setStockProductId(e.target.value);
                          const product = products.find(p => p.id === e.target.value);
                          if (product) setStockUnitPrice(product.sell_price);
                        }}
                      >
                        <option value="">Select product...</option>
                        {products.map(product => (
                          <option key={product.id} value={product.id}>
                            {product.name} - â‚¹{product.sell_price} {product.rack_id && `(${product.rack_id})`}
                          </option>
                        ))}
                      </select>
                    </div>

                    <div>
                      <label className="block font-semibold mb-2">Quantity *</label>
                      <input
                        type="number"
                        min="1"
                        className="w-full px-4 py-2 border rounded-lg"
                        value={stockQuantity}
                        onChange={(e) => setStockQuantity(parseInt(e.target.value))}
                      />
                    </div>

                    <div>
                      <label className="block font-semibold mb-2">Unit Price (â‚¹) *</label>
                      <input
                        type="number"
                        min="0"
                        step="0.01"
                        className="w-full px-4 py-2 border rounded-lg"
                        value={stockUnitPrice}
                        onChange={(e) => setStockUnitPrice(parseFloat(e.target.value))}
                      />
                    </div>

                    <div>
                      <label className="block font-semibold mb-2">Notes</label>
                      <textarea
                        placeholder="Additional information..."
                        className="w-full px-4 py-2 border rounded-lg"
                        rows="3"
                        value={stockNotes}
                        onChange={(e) => setStockNotes(e.target.value)}
                      />
                    </div>
                  </div>

                  <div className="flex gap-4 mt-6">
                    <ButtonLoader
                      loading={addingStockItem}
                      onClick={addStockItem}
                      className="flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold"
                    >
                      Add Stock
                    </ButtonLoader>
                    <button
                      onClick={() => { setShowAddStockModal(false); resetStockForm(); }}
                      className="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700"
                      disabled={addingStockItem}
                    >
                      Cancel
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Billing Modal */}
          {showBillingModal && currentJobCard && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-lg max-w-md w-full">
                <div className="p-6 border-b flex justify-between items-center">
                  <h2 className="text-2xl font-bold">Complete & Bill</h2>
                  <button onClick={() => setShowBillingModal(false)} className="text-2xl text-gray-500 hover:text-red-600">Ã—</button>
                </div>
                <div className="p-6">
                  <div className="mb-6 p-4 bg-gray-50 rounded-lg">
                    <div className="flex justify-between mb-2">
                      <span>Parts & Materials:</span>
                      <span className="font-semibold">
                        â‚¹{currentJobCard.stock_items.reduce((sum, item) => sum + item.total_price, 0).toFixed(2)}
                      </span>
                    </div>
                  </div>

                  <div className="space-y-4 mb-6">
                    <div>
                      <label className="block font-semibold mb-2">Labour Charge (â‚¹) *</label>
                      <input
                        type="number"
                        min="0"
                        step="0.01"
                        className="w-full px-4 py-2 border rounded-lg"
                        value={labourCharge}
                        onChange={(e) => setLabourCharge(parseFloat(e.target.value) || 0)}
                        placeholder="Enter labour charges"
                      />
                    </div>

                    <div className="p-4 bg-blue-50 rounded-lg">
                      <div className="flex justify-between text-lg font-bold">
                        <span>Grand Total:</span>
                        <span className="text-blue-600">
                          â‚¹{(currentJobCard.stock_items.reduce((sum, item) => sum + item.total_price, 0) + (parseFloat(labourCharge) || 0)).toFixed(2)}
                        </span>
                      </div>
                    </div>

                    <div>
                      <label className="block font-semibold mb-2">Last Service Date</label>
                      <input
                        type="date"
                        className="w-full px-4 py-2 border rounded-lg"
                        value={lastServiceDate}
                        onChange={(e) => setLastServiceDate(e.target.value)}
                      />
                    </div>

                    <div>
                      <label className="block font-semibold mb-2">Next Service Date</label>
                      <input
                        type="date"
                        className="w-full px-4 py-2 border rounded-lg"
                        value={nextServiceDate}
                        onChange={(e) => setNextServiceDate(e.target.value)}
                      />
                    </div>
                  </div>

                  <div className="flex gap-4">
                    <ButtonLoader
                      loading={completingJobCard}
                      onClick={completeJobCard}
                      className="flex-1 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold"
                    >
                      Complete Job Card
                    </ButtonLoader>
                    <button
                      onClick={() => setShowBillingModal(false)}
                      className="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700"
                      disabled={completingJobCard}
                    >
                      Cancel
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}

          {/* Reject Modal */}
          {showRejectModal && (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
              <div className="bg-white rounded-lg max-w-md w-full">
                <div className="p-6 border-b flex justify-between items-center">
                  <h2 className="text-2xl font-bold">Reject Job Card</h2>
                  <button onClick={() => { setShowRejectModal(false); setRejectReason(''); }} className="text-2xl text-gray-500 hover:text-red-600">Ã—</button>
                </div>
                <div className="p-6">
                  <div className="space-y-4">
                    <div>
                      <label className="block font-semibold mb-2">Reason for Rejection *</label>
                      <textarea
                        placeholder="Enter reason for rejecting this job card..."
                        className="w-full px-4 py-2 border rounded-lg"
                        rows="4"
                        value={rejectReason}
                        onChange={(e) => setRejectReason(e.target.value)}
                      />
                    </div>
                  </div>

                  <div className="flex gap-4 mt-6">
                    <ButtonLoader
                      loading={rejectingJobCard}
                      onClick={rejectJobCard}
                      className="flex-1 px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold"
                    >
                      Reject Job Card
                    </ButtonLoader>
                    <button
                      onClick={() => { setShowRejectModal(false); setRejectReason(''); }}
                      className="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700"
                      disabled={rejectingJobCard}
                    >
                      Cancel
                    </button>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // ------------------ Bills component ------------------
    function Bills() {
      const [bills, setBills] = useState([]);
      const [loading, setLoading] = useState(false);
      const [filters, setFilters] = useState({ from: '', to: '', payment_status: '', search: '' });
      const [viewBill, setViewBill] = useState(null);

      useEffect(() => { loadBills(); }, []);

      const loadBills = async () => {
        setLoading(true);
        try {
          const params = new URLSearchParams();
          if (filters.from) params.append('from', filters.from);
          if (filters.to) params.append('to', filters.to);
          if (filters.payment_status) params.append('payment_status', filters.payment_status);
          if (filters.search) params.append('search', filters.search);

          const data = await apiCall(`/bills?${params.toString()}`);
          setBills(data || []);
        } catch (err) {
          alert('Error loading bills: ' + err.message);
        } finally {
          setLoading(false);
        }
      };

      const handleViewBill = (billId) => {
        const token = localStorage.getItem('token');
        const url = `${API_URL}/bills/${billId}/view?token=${encodeURIComponent(token)}`;
        window.open(url, '_blank');
      };

      const handleMarkPaid = async (billId) => {
        if (!confirm('Mark this bill as paid?')) return;
        try {
          await apiCall(`/bills/${billId}/mark-paid`, { method: 'POST' });
          loadBills();
        } catch (err) {
          alert('Error: ' + err.message);
        }
      };

      const getBadgeColor = (status) => {
        if (status === 'paid') return 'bg-green-100 text-green-800';
        if (status === 'unpaid') return 'bg-yellow-100 text-yellow-800';
        return 'bg-gray-100 text-gray-800';
      };

      return (
        <div>
          <div className="mb-6">
            <h1 className="text-3xl font-bold text-gray-800">Bills & Invoices</h1>
            <p className="text-gray-600">View and manage all bills</p>
          </div>

          {/* Filters */}
          <div className="bg-white p-4 rounded-lg shadow mb-6">
            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">From Date</label>
                <input
                  type="date"
                  value={filters.from}
                  onChange={e => setFilters({...filters, from: e.target.value})}
                  className="w-full px-3 py-2 border rounded"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">To Date</label>
                <input
                  type="date"
                  value={filters.to}
                  onChange={e => setFilters({...filters, to: e.target.value})}
                  className="w-full px-3 py-2 border rounded"
                />
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Payment Status</label>
                <select
                  value={filters.payment_status}
                  onChange={e => setFilters({...filters, payment_status: e.target.value})}
                  className="w-full px-3 py-2 border rounded"
                >
                  <option value="">All</option>
                  <option value="paid">Paid</option>
                  <option value="unpaid">Unpaid</option>
                </select>
              </div>
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">Search</label>
                <input
                  type="text"
                  placeholder="Bill number or job number..."
                  value={filters.search}
                  onChange={e => setFilters({...filters, search: e.target.value})}
                  className="w-full px-3 py-2 border rounded"
                />
              </div>
            </div>
            <div className="mt-4 flex gap-2">
              <button
                onClick={loadBills}
                className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
              >
                Apply Filters
              </button>
              <button
                onClick={() => {
                  setFilters({ from: '', to: '', payment_status: '', search: '' });
                  setTimeout(loadBills, 100);
                }}
                className="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300"
              >
                Clear Filters
              </button>
            </div>
          </div>

          {/* Bills Table */}
          {loading ? (
            <div className="text-center py-12">
              <div className="text-gray-600">Loading bills...</div>
            </div>
          ) : bills.length === 0 ? (
            <div className="bg-white rounded-lg shadow p-12 text-center">
              <div className="text-gray-400 text-5xl mb-4">ðŸ“„</div>
              <p className="text-gray-600">No bills found</p>
            </div>
          ) : (
            <div className="bg-white rounded-lg shadow overflow-hidden">
              <div className="overflow-x-auto">
                <table className="w-full">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Bill Number</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Job Number</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Customer</th>
                      <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                      <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Total</th>
                      <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Status</th>
                      <th className="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Actions</th>
                    </tr>
                  </thead>
                  <tbody className="divide-y divide-gray-200">
                    {bills.map(bill => (
                      <tr key={bill.id} className="hover:bg-gray-50">
                        <td className="px-6 py-4 text-sm font-medium text-gray-900">{bill.bill_number}</td>
                        <td className="px-6 py-4 text-sm text-gray-600">{bill.job_number}</td>
                        <td className="px-6 py-4 text-sm text-gray-600">
                          <div>{bill.customer_data.name}</div>
                          <div className="text-xs text-gray-400">{bill.customer_data.phone}</div>
                        </td>
                        <td className="px-6 py-4 text-sm text-gray-600">
                          {new Date(bill.bill_date).toLocaleDateString('en-IN')}
                        </td>
                        <td className="px-6 py-4 text-sm font-medium text-right text-gray-900">
                          â‚¹{bill.total.toFixed(2)}
                        </td>
                        <td className="px-6 py-4 text-center">
                          <span className={`px-2 py-1 text-xs font-medium rounded-full ${getBadgeColor(bill.payment_status)}`}>
                            {bill.payment_status.toUpperCase()}
                          </span>
                        </td>
                        <td className="px-6 py-4 text-center">
                          <div className="flex justify-center gap-2">
                            <button
                              onClick={() => handleViewBill(bill.id)}
                              className="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700"
                            >
                              View
                            </button>
                            {bill.payment_status === 'unpaid' && (
                              <button
                                onClick={() => handleMarkPaid(bill.id)}
                                className="px-3 py-1 text-sm bg-green-600 text-white rounded hover:bg-green-700"
                              >
                                Mark Paid
                              </button>
                            )}
                          </div>
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>

              {/* Summary */}
              <div className="bg-gray-50 px-6 py-4 border-t">
                <div className="flex justify-between items-center">
                  <div className="text-sm text-gray-600">
                    Total Bills: <span className="font-semibold">{bills.length}</span>
                  </div>
                  <div className="text-sm text-gray-600">
                    Total Amount: <span className="font-semibold text-lg">
                      â‚¹{bills.reduce((sum, b) => sum + b.total, 0).toFixed(2)}
                    </span>
                  </div>
                  <div className="text-sm text-gray-600">
                    Unpaid: <span className="font-semibold text-yellow-600">
                      â‚¹{bills.filter(b => b.payment_status === 'unpaid').reduce((sum, b) => sum + b.total, 0).toFixed(2)}
                    </span>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    function App() {
      const { isAuthenticated, logout, user } = React.useContext(AuthContext);
      const [current, setCurrent] = useState('dashboard');
      const [menuOpen, setMenuOpen] = useState(false);
      if (!isAuthenticated) return <Login />;

      const menu = [
        { id: 'dashboard', label: 'Dashboard', icon: 'ðŸ“Š' },
        { id: 'reminders', label: 'Reminders', icon: 'ðŸ””' },
        { id: 'customers', label: 'Customers', icon: 'ðŸ‘¥' },
        { id: 'stock', label: 'Stock Management', icon: 'ðŸ“¦' },
        { id: 'jobcards', label: 'Job Cards', icon: 'ðŸ”§' },
        { id: 'bills', label: 'Bills', icon: 'ðŸ“„' },
        { id: 'sales', label: 'Sales', icon: 'ðŸ’°' },
      ];

      const handleMenuClick = (menuId) => {
        setCurrent(menuId);
        setMenuOpen(false); // Close menu on mobile after selection
      };

      return (
        <div className="flex h-screen bg-gray-50 overflow-hidden">
          {/* Mobile menu overlay */}
          {menuOpen && (
            <div
              className="fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden"
              onClick={() => setMenuOpen(false)}
            />
          )}

          {/* Sidebar - hidden on mobile, overlay on mobile when open, always visible on lg screens */}
          <aside className={`fixed lg:relative inset-y-0 left-0 z-50 w-64 bg-white shadow-lg transform transition-transform duration-300 ease-in-out ${
            menuOpen ? 'translate-x-0' : '-translate-x-full lg:translate-x-0'
          }`}>
            <div className="p-4 lg:p-6 border-b">
              <div className="flex items-center justify-between">
                <div>
                  <h1 className="text-xl lg:text-2xl font-bold text-blue-600">Retail Manager</h1>
                  <p className="text-xs lg:text-sm text-gray-600 mt-1">Welcome, {user?.username || 'User'}</p>
                </div>
                <button
                  onClick={() => setMenuOpen(false)}
                  className="lg:hidden text-gray-600 hover:text-gray-900"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12" />
                  </svg>
                </button>
              </div>
            </div>
            <nav className="p-3 lg:p-4 overflow-y-auto" style={{maxHeight: 'calc(100vh - 180px)'}}>
              {menu.map(m => (
                <button
                  key={m.id}
                  onClick={() => handleMenuClick(m.id)}
                  className={`w-full text-left px-3 lg:px-4 py-2 lg:py-3 mb-2 rounded-lg flex items-center gap-3 transition-colors ${
                    current===m.id ? 'bg-blue-600 text-white' : 'hover:bg-gray-100'
                  }`}
                >
                  <span className="text-lg lg:text-xl">{m.icon}</span>
                  <span className="font-medium text-sm lg:text-base">{m.label}</span>
                </button>
              ))}
            </nav>
            <div className="absolute bottom-0 left-0 right-0 p-3 lg:p-4 border-t bg-white">
              <button
                onClick={logout}
                className="w-full px-3 lg:px-4 py-2 text-sm lg:text-base bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
              >
                Logout
              </button>
            </div>
          </aside>

          <main className="flex-1 flex flex-col overflow-hidden w-full">
            <header className="bg-white border-b p-3 lg:p-4 flex justify-between items-center">
              <div className="flex items-center gap-3">
                {/* Mobile hamburger menu */}
                <button
                  onClick={() => setMenuOpen(true)}
                  className="lg:hidden text-gray-600 hover:text-gray-900"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 6h16M4 12h16M4 18h16" />
                  </svg>
                </button>
                <div className="text-base lg:text-lg font-semibold">{menu.find(i=>i.id===current)?.label}</div>
              </div>
              <div className="text-xs lg:text-sm text-gray-600 hidden sm:block">Jhansi | {new Date().toLocaleDateString()}</div>
            </header>

            <section className="flex-1 overflow-auto p-3 lg:p-6">
              {current === 'dashboard' && <Dashboard />}
              {current === 'reminders' && <Reminders />}
              {current === 'customers' && <Customers />}
              {current === 'stock' && <StockManagement />}
              {current === 'jobcards' && <JobCards />}
              {current === 'bills' && <Bills />}
              {current === 'sales' && <Sales />}
            </section>

            <footer className="bg-white border-t p-2 lg:p-3 text-center text-xs lg:text-sm text-gray-600">
              Â© {new Date().getFullYear()} Retail Manager
            </footer>
          </main>
        </div>
      );
    }

    ReactDOM.render(<AuthProvider><App /></AuthProvider>, document.getElementById('root'));
  </script>
</body>
</html>